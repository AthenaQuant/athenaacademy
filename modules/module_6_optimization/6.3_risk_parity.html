<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Master Risk Parity allocation for quantitative trading. Learn equal risk contribution portfolios used by Bridgewater and institutional investors.">
    <title>6.3 Risk Parity Allocation | Quantitative Trading Mastery</title>

    <link rel="stylesheet" href="../../assets/css/shared-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">

    <style>
        .key-concept { background: var(--bg-card); border-left: 4px solid var(--accent-cyan); padding: 1.5rem; border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: 1.5rem 0; }
        .key-concept h3 { color: var(--accent-cyan); margin-bottom: 1rem; }
        .important-note { background: var(--warning-bg); border-left: 4px solid var(--warning); padding: 1.5rem; border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: 1.5rem 0; }
        .important-note h3 { color: var(--warning); margin-bottom: 0.5rem; }
        .calculator-container { background: var(--bg-card); border-radius: var(--radius-lg); padding: 2rem; margin: 2rem 0; border: 1px solid rgba(255,255,255,0.1); }
        .calculator-container h3 { color: var(--accent-purple); margin-bottom: 1.5rem; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .input-group input { width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); color: var(--text-primary); font-size: 1rem; }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .calculate-btn { background: var(--gradient-secondary); color: white; border: none; padding: 1rem 2rem; border-radius: var(--radius-md); cursor: pointer; font-size: 1rem; font-weight: 600; width: 100%; margin-top: 1rem; }
        .results-container { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 1.5rem; margin-top: 1.5rem; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
        .result-item { text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md); }
        .result-label { font-size: 0.85rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem; }
        .result-value { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
        .quiz-container { background: var(--bg-card); border-radius: var(--radius-lg); padding: 2rem; margin: 2rem 0; }
        .quiz-question { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .quiz-question:last-child { border-bottom: none; }
        .quiz-question h4 { color: var(--text-primary); margin-bottom: 1rem; }
        .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .quiz-options button { background: var(--bg-secondary); border: 2px solid transparent; padding: 1rem; border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; text-align: left; }
        .quiz-options button:hover:not(:disabled) { border-color: var(--accent-blue); }
        .quiz-options button:disabled { cursor: not-allowed; opacity: 0.7; }
        .quiz-feedback { margin-top: 1rem; padding: 1rem; border-radius: var(--radius-md); display: none; }
        .quiz-feedback .correct { background: var(--success-bg); color: var(--success); }
        .quiz-feedback .incorrect { background: var(--error-bg); color: var(--error); }
        .score-container { text-align: center; padding: 2rem; background: var(--gradient-secondary); border-radius: var(--radius-lg); margin-top: 2rem; display: none; }
        .code-block { background: #1a1f2e; border-radius: var(--radius-lg); overflow: hidden; margin: 1.5rem 0; }
        .code-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg-tertiary); }
        .code-header span { color: var(--text-muted); font-size: 0.85rem; }
        .code-block pre { margin: 0; padding: 1.5rem; overflow-x: auto; }
        .code-block code { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; line-height: 1.6; }
        .chart-container { background: var(--bg-card); border-radius: var(--radius-lg); padding: 1.5rem; margin: 2rem 0; border: 1px solid rgba(255,255,255,0.1); position: relative; height: 400px; }
        .chart-container canvas { max-height: 350px; }
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .comparison-card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .comparison-card h4 { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <nav class="module-nav-header">
        <div class="container">
            <div class="nav-content">
                <a href="../../index.html" class="nav-home">‚Üê Back to Course</a>
                <div class="nav-module-info">
                    <span class="nav-module-number">Module 6.3</span>
                    <span class="nav-module-title">Risk Parity</span>
                </div>
                <a href="6.4_numerical_optimization.html" class="nav-next">Next Module ‚Üí</a>
            </div>
        </div>
    </nav>

    <header class="module-hero">
        <div class="container">
            <div class="module-hero-content">
                <div class="module-breadcrumb">
                    <span>Module 6: Optimization & Portfolio Theory</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span>6.3 Risk Parity Allocation</span>
                </div>
                <h1>Risk Parity Allocation</h1>
                <p class="module-subtitle">
                    Build portfolios where each asset contributes equally to total risk. The approach
                    that powers Bridgewater's All Weather fund and billions in institutional assets.
                </p>
                <div class="module-meta">
                    <span class="meta-item">‚è±Ô∏è 40 min read</span>
                    <span class="meta-item">üìä 3 Visualizations</span>
                    <span class="meta-item">üíª Risk Parity Calculator</span>
                    <span class="meta-item">‚úÖ 5 Quiz Questions</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container content-wrapper">
        <!-- Part 1: Why Should I Care? -->
        <section class="content-section fade-in">
            <h2>Part 1: Why Should I Care?</h2>

            <div class="important-note">
                <h3>‚ö†Ô∏è The 60/40 Illusion</h3>
                <p>
                    A traditional 60% stocks / 40% bonds portfolio seems "balanced." But stocks contribute
                    <strong>~90% of the portfolio's risk</strong> due to their higher volatility. Your "diversified"
                    portfolio is essentially a stock portfolio in disguise.
                </p>
            </div>

            <div class="key-concept">
                <h3>The Risk Parity Solution</h3>
                <p>
                    Instead of allocating capital equally, allocate <strong>risk equally</strong>. Each asset
                    contributes the same amount to total portfolio volatility. Result: true diversification
                    across economic regimes.
                </p>
            </div>

            <div class="card-grid">
                <div class="card">
                    <h4 style="color: var(--accent-blue);">üí∞ $400+ Billion</h4>
                    <p>Assets under management using risk parity strategies globally. Bridgewater's All Weather alone manages ~$80B.</p>
                </div>
                <div class="card">
                    <h4 style="color: var(--accent-purple);">üìâ Lower Drawdowns</h4>
                    <p>Risk parity portfolios typically experience smaller maximum drawdowns than traditional portfolios.</p>
                </div>
                <div class="card">
                    <h4 style="color: var(--accent-cyan);">üåç All Weather</h4>
                    <p>Designed to perform in any economic environment: growth, recession, inflation, deflation.</p>
                </div>
            </div>
        </section>

        <!-- Part 2: The Problem with Traditional Allocation -->
        <section class="content-section fade-in">
            <h2>Part 2: The Problem with 60/40</h2>

            <div class="comparison-grid">
                <div class="comparison-card" style="border-left: 4px solid var(--error);">
                    <h4 style="color: var(--error);">Traditional 60/40</h4>
                    <table class="data-table">
                        <tr><td>Stocks</td><td>60%</td><td style="color: var(--error);">~90% of risk</td></tr>
                        <tr><td>Bonds</td><td>40%</td><td style="color: var(--success);">~10% of risk</td></tr>
                    </table>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                        Risk is dominated by stocks. When stocks crash, the portfolio crashes.
                    </p>
                </div>
                <div class="comparison-card" style="border-left: 4px solid var(--success);">
                    <h4 style="color: var(--success);">Risk Parity</h4>
                    <table class="data-table">
                        <tr><td>Stocks</td><td>~25%</td><td style="color: var(--accent-blue);">50% of risk</td></tr>
                        <tr><td>Bonds</td><td>~75%</td><td style="color: var(--accent-blue);">50% of risk</td></tr>
                    </table>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                        Each asset contributes equally. True diversification.
                    </p>
                </div>
            </div>

            <div class="chart-container">
                <h4 style="margin-bottom: 1rem;">Risk Contribution Comparison</h4>
                <canvas id="riskContributionChart" height="250"></canvas>
            </div>
        </section>

        <!-- Part 3: The Mathematics -->
        <section class="content-section fade-in">
            <h2>Part 3: The Mathematics</h2>

            <h3>Marginal Risk Contribution</h3>
            <div class="formula-box">
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem;">
                    MRC_i = ‚àÇœÉ_p / ‚àÇw_i = (Œ£w)_i / œÉ_p
                </div>
                <p style="text-align: center; color: var(--text-muted);">
                    How much portfolio volatility changes when we add a little more of asset i
                </p>
            </div>

            <h3>Total Risk Contribution</h3>
            <div class="formula-box">
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem;">
                    TRC_i = w_i √ó MRC_i = w_i √ó (Œ£w)_i / œÉ_p
                </div>
                <p style="text-align: center; color: var(--text-muted);">
                    Asset i's total contribution to portfolio risk
                </p>
            </div>

            <div class="key-concept">
                <h3>Risk Parity Condition</h3>
                <p>For equal risk contribution across all assets:</p>
                <div class="formula" style="text-align: center; font-size: 1.3rem; padding: 1rem; margin-top: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                    TRC_1 = TRC_2 = ... = TRC_n = œÉ_p / n
                </div>
            </div>

            <h3>Simple Two-Asset Case</h3>
            <div class="formula-box">
                <p>For two uncorrelated assets, risk parity weights are:</p>
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem;">
                    w_1 = œÉ_2 / (œÉ_1 + œÉ_2), w_2 = œÉ_1 / (œÉ_1 + œÉ_2)
                </div>
                <p style="text-align: center; color: var(--text-muted);">
                    Weight inversely proportional to volatility
                </p>
            </div>
        </section>

        <!-- Part 4: Python Implementation -->
        <section class="content-section fade-in">
            <h2>Part 4: Python Implementation</h2>

            <div class="code-block">
                <div class="code-header">
                    <span>risk_parity.py</span>
                    <button onclick="copyCode(this)" style="background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer;">Copy</button>
                </div>
                <pre><code class="language-python">"""
Risk Parity Portfolio Construction
==================================
Equal risk contribution allocation.
"""

import numpy as np
from scipy.optimize import minimize

def risk_parity_weights(cov_matrix: np.ndarray) -> np.ndarray:
    """
    Calculate risk parity weights using optimization.

    Parameters
    ----------
    cov_matrix : np.ndarray
        Covariance matrix of asset returns

    Returns
    -------
    np.ndarray
        Risk parity weights
    """
    n = len(cov_matrix)

    def risk_contribution(weights):
        """Calculate risk contribution of each asset."""
        port_vol = np.sqrt(weights @ cov_matrix @ weights)
        marginal_contrib = cov_matrix @ weights / port_vol
        risk_contrib = weights * marginal_contrib
        return risk_contrib

    def objective(weights):
        """Minimize sum of squared differences from equal risk."""
        rc = risk_contribution(weights)
        target = np.ones(n) / n  # Equal risk contribution
        return np.sum((rc - target * np.sum(rc))**2)

    # Initial guess: inverse volatility
    init_weights = 1 / np.sqrt(np.diag(cov_matrix))
    init_weights /= init_weights.sum()

    # Constraints and bounds
    constraints = {'type': 'eq', 'fun': lambda w: np.sum(w) - 1}
    bounds = tuple((0.01, 1) for _ in range(n))

    result = minimize(objective, init_weights, method='SLSQP',
                     bounds=bounds, constraints=constraints)

    return result.x


def inverse_volatility_weights(volatilities: np.ndarray) -> np.ndarray:
    """
    Simple inverse volatility weighting (approximation).

    Good approximation when correlations are similar.
    """
    inv_vol = 1 / volatilities
    return inv_vol / inv_vol.sum()


def analyze_risk_contribution(weights: np.ndarray, cov_matrix: np.ndarray,
                             asset_names: list = None) -> dict:
    """
    Analyze risk contributions of portfolio.
    """
    n = len(weights)
    names = asset_names or [f"Asset_{i}" for i in range(n)]

    port_vol = np.sqrt(weights @ cov_matrix @ weights)
    marginal_contrib = cov_matrix @ weights / port_vol
    risk_contrib = weights * marginal_contrib
    pct_contrib = risk_contrib / risk_contrib.sum()

    return {
        'portfolio_volatility': port_vol,
        'weights': dict(zip(names, weights)),
        'risk_contribution': dict(zip(names, risk_contrib)),
        'pct_risk_contribution': dict(zip(names, pct_contrib))
    }


# Example
if __name__ == "__main__":
    # Example: Stocks, Bonds, Commodities
    vols = np.array([0.20, 0.05, 0.15])  # 20%, 5%, 15%
    corr = np.array([
        [1.0, 0.2, 0.3],
        [0.2, 1.0, 0.1],
        [0.3, 0.1, 1.0]
    ])
    cov = np.outer(vols, vols) * corr
    names = ['Stocks', 'Bonds', 'Commodities']

    # Risk parity weights
    rp_weights = risk_parity_weights(cov)

    print("Risk Parity Portfolio:")
    analysis = analyze_risk_contribution(rp_weights, cov, names)

    for name in names:
        w = analysis['weights'][name]
        rc = analysis['pct_risk_contribution'][name]
        print(f"  {name}: {w:.1%} weight, {rc:.1%} risk contribution")

    print(f"\nPortfolio Volatility: {analysis['portfolio_volatility']:.2%}")

    # Compare to 60/40
    print("\n--- 60/40 Comparison ---")
    trad_weights = np.array([0.60, 0.40, 0.0])
    trad_analysis = analyze_risk_contribution(trad_weights, cov, names)

    for name in names:
        rc = trad_analysis['pct_risk_contribution'][name]
        print(f"  {name}: {rc:.1%} risk contribution")</code></pre>
            </div>
        </section>

        <!-- Part 5: Interactive Calculator -->
        <section class="content-section fade-in">
            <h2>Part 5: Risk Parity Calculator</h2>

            <div class="calculator-container">
                <h3>‚öñÔ∏è Risk Parity Weight Calculator</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Enter volatilities for 3 assets to calculate risk parity weights.
                </p>

                <div class="input-row">
                    <div class="input-group">
                        <label>Asset 1 (Stocks) Volatility (%)</label>
                        <input type="number" id="vol1" value="20" min="1" max="100">
                    </div>
                    <div class="input-group">
                        <label>Asset 2 (Bonds) Volatility (%)</label>
                        <input type="number" id="vol2" value="5" min="1" max="100">
                    </div>
                    <div class="input-group">
                        <label>Asset 3 (Commodities) Volatility (%)</label>
                        <input type="number" id="vol3" value="15" min="1" max="100">
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateRiskParity()">Calculate Risk Parity Weights</button>

                <div class="results-container" id="resultsContainer" style="display: none;">
                    <h4 style="margin-bottom: 1rem; color: var(--accent-cyan);">Risk Parity Weights (Inverse Volatility)</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <span class="result-label">Stocks</span>
                            <span class="result-value" id="w1">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Bonds</span>
                            <span class="result-value" id="w2">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Commodities</span>
                            <span class="result-value" id="w3">-</span>
                        </div>
                    </div>
                    <div class="chart-container" style="margin-top: 1.5rem;">
                        <canvas id="weightsChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Part 6: Key Takeaways -->
        <section class="content-section fade-in">
            <h2>Part 6: Key Takeaways</h2>

            <div class="card" style="padding: 2rem;">
                <div style="display: grid; gap: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</span>
                        <div>
                            <strong style="color: var(--text-primary);">Allocate risk, not capital</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Equal risk contribution provides true diversification.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</span>
                        <div>
                            <strong style="color: var(--text-primary);">60/40 is ~90% stock risk</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Traditional portfolios are disguised stock bets.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</span>
                        <div>
                            <strong style="color: var(--text-primary);">Inverse volatility is a good approximation</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Weight inversely proportional to volatility works well in practice.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">4</span>
                        <div>
                            <strong style="color: var(--text-primary);">Often requires leverage</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Heavy bond allocation may need leverage to hit return targets.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Part 7: Quiz -->
        <section class="content-section fade-in">
            <h2>Part 7: Knowledge Check</h2>

            <div class="quiz-container">
                <div class="quiz-question" id="q1">
                    <h4>1. In a traditional 60/40 portfolio, approximately what percentage of risk comes from stocks?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(1, 'a')">a) 60%</button>
                        <button onclick="checkAnswer(1, 'b')">b) 75%</button>
                        <button onclick="checkAnswer(1, 'c')">c) 90%</button>
                        <button onclick="checkAnswer(1, 'd')">d) 50%</button>
                    </div>
                    <div class="quiz-feedback" id="feedback1"></div>
                </div>

                <div class="quiz-question" id="q2">
                    <h4>2. In risk parity, how do we determine weights?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(2, 'a')">a) Equal capital allocation</button>
                        <button onclick="checkAnswer(2, 'b')">b) Equal risk contribution</button>
                        <button onclick="checkAnswer(2, 'c')">c) Maximum return</button>
                        <button onclick="checkAnswer(2, 'd')">d) Minimum volatility</button>
                    </div>
                    <div class="quiz-feedback" id="feedback2"></div>
                </div>

                <div class="quiz-question" id="q3">
                    <h4>3. For two uncorrelated assets, risk parity weights are:</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(3, 'a')">a) Proportional to volatility</button>
                        <button onclick="checkAnswer(3, 'b')">b) Inversely proportional to volatility</button>
                        <button onclick="checkAnswer(3, 'c')">c) Always 50/50</button>
                        <button onclick="checkAnswer(3, 'd')">d) Based on expected returns</button>
                    </div>
                    <div class="quiz-feedback" id="feedback3"></div>
                </div>

                <div class="quiz-question" id="q4">
                    <h4>4. Why might a risk parity portfolio require leverage?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(4, 'a')">a) To increase risk</button>
                        <button onclick="checkAnswer(4, 'b')">b) Heavy bond allocation reduces expected return</button>
                        <button onclick="checkAnswer(4, 'c')">c) Regulatory requirement</button>
                        <button onclick="checkAnswer(4, 'd')">d) To reduce correlations</button>
                    </div>
                    <div class="quiz-feedback" id="feedback4"></div>
                </div>

                <div class="quiz-question" id="q5">
                    <h4>5. Which fund popularized risk parity?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(5, 'a')">a) Berkshire Hathaway</button>
                        <button onclick="checkAnswer(5, 'b')">b) Bridgewater All Weather</button>
                        <button onclick="checkAnswer(5, 'c')">c) Vanguard 500</button>
                        <button onclick="checkAnswer(5, 'd')">d) PIMCO Total Return</button>
                    </div>
                    <div class="quiz-feedback" id="feedback5"></div>
                </div>

                <div class="score-container" id="scoreContainer">
                    <h3>Quiz Complete! Score: <span id="finalScore">0</span>/5</h3>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Quiz
        const correctAnswers = { 1: 'c', 2: 'b', 3: 'b', 4: 'b', 5: 'b' };
        const explanations = {
            1: { 'a': 'That\'s the capital allocation, not risk.', 'b': 'Higher, due to stock volatility.', 'c': 'Correct! Stocks dominate risk despite only 60% capital.', 'd': 'Much higher due to volatility difference.' },
            2: { 'a': 'That\'s traditional allocation.', 'b': 'Correct! Each asset contributes equally to portfolio risk.', 'c': 'That\'s mean-variance optimization.', 'd': 'That\'s a different objective.' },
            3: { 'a': 'Opposite‚Äîhigher vol gets lower weight.', 'b': 'Correct! Lower volatility assets get higher weights.', 'c': 'Only if volatilities are equal.', 'd': 'Risk parity ignores expected returns.' },
            4: { 'a': 'Leverage isn\'t used to increase risk unnecessarily.', 'b': 'Correct! Bond-heavy portfolios have lower expected returns, so leverage is used to scale up.', 'c': 'Not a regulatory issue.', 'd': 'Leverage doesn\'t change correlations.' },
            5: { 'a': 'Buffett doesn\'t use risk parity.', 'b': 'Correct! Ray Dalio\'s Bridgewater All Weather fund.', 'c': 'That\'s a passive index fund.', 'd': 'That\'s an active bond fund.' }
        };
        let quizAnswers = {};

        function checkAnswer(q, a) {
            const feedback = document.getElementById(`feedback${q}`);
            const isCorrect = a === correctAnswers[q];
            quizAnswers[q] = a;
            feedback.innerHTML = `<div class="${isCorrect ? 'correct' : 'incorrect'}">${isCorrect ? '‚úì Correct!' : '‚úó Incorrect.'} ${explanations[q][a]}</div>`;
            feedback.style.display = 'block';
            document.querySelectorAll(`#q${q} button`).forEach(btn => btn.disabled = true);
            if (Object.keys(quizAnswers).length === 5) {
                const score = Object.keys(quizAnswers).reduce((s, q) => s + (quizAnswers[q] === correctAnswers[q] ? 1 : 0), 0);
                document.getElementById('finalScore').textContent = score;
                document.getElementById('scoreContainer').style.display = 'block';
            }
        }

        // Calculator
        let weightsChartInstance = null;

        function calculateRiskParity() {
            const vol1 = parseFloat(document.getElementById('vol1').value);
            const vol2 = parseFloat(document.getElementById('vol2').value);
            const vol3 = parseFloat(document.getElementById('vol3').value);

            // Inverse volatility weights
            const invVol1 = 1 / vol1, invVol2 = 1 / vol2, invVol3 = 1 / vol3;
            const sum = invVol1 + invVol2 + invVol3;
            const w1 = invVol1 / sum, w2 = invVol2 / sum, w3 = invVol3 / sum;

            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('w1').textContent = (w1 * 100).toFixed(1) + '%';
            document.getElementById('w2').textContent = (w2 * 100).toFixed(1) + '%';
            document.getElementById('w3').textContent = (w3 * 100).toFixed(1) + '%';

            // Update chart
            if (weightsChartInstance) weightsChartInstance.destroy();
            const ctx = document.getElementById('weightsChart').getContext('2d');
            weightsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Stocks', 'Bonds', 'Commodities'],
                    datasets: [{
                        data: [w1 * 100, w2 * 100, w3 * 100],
                        backgroundColor: ['#ef4444', '#3b82f6', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } }
                }
            });
        }

        // Risk contribution chart
        function initCharts() {
            const ctx = document.getElementById('riskContributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['60/40 Portfolio', 'Risk Parity'],
                    datasets: [
                        { label: 'Stocks', data: [90, 50], backgroundColor: '#ef4444' },
                        { label: 'Bonds', data: [10, 50], backgroundColor: '#3b82f6' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        x: { stacked: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                        y: { stacked: true, min: 0, max: 100, title: { display: true, text: 'Risk Contribution (%)', color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } }
                    }
                }
            });
        }

        function copyCode(btn) {
            const code = btn.closest('.code-block').querySelector('code').textContent;
            navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }

        document.addEventListener('DOMContentLoaded', function() { initCharts(); calculateRiskParity(); });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
