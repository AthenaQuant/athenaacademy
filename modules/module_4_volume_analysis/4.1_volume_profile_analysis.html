<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Master Volume Profile analysis for quantitative trading. Learn POC, Value Area, HVN/LVN identification for institutional-level market structure analysis.">
    <title>4.1 Volume Profile Analysis | Quantitative Trading Mastery</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../../assets/css/shared-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">

    <style>
        .volume-profile-visual {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            align-items: stretch;
        }
        .price-ladder {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }
        .price-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .price-label {
            width: 60px;
            text-align: right;
            color: #94a3b8;
            font-size: 0.85rem;
        }
        .volume-bar {
            height: 24px;
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.8), rgba(99, 102, 241, 0.4));
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .volume-bar.poc {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.9), rgba(16, 185, 129, 0.5));
        }
        .volume-bar.hvn {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.8), rgba(245, 158, 11, 0.4));
        }
        .volume-bar.lvn {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.6), rgba(239, 68, 68, 0.3));
        }
        .profile-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 3px;
        }
        .value-area-box {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.1));
            border: 2px solid #a855f7;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        .value-area-box h4 {
            color: #a855f7;
            margin-bottom: 15px;
        }
        .node-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }
        .node-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
        }
        .node-card.hvn {
            border: 2px solid #f59e0b;
        }
        .node-card.lvn {
            border: 2px solid #ef4444;
        }
        .node-card h4 {
            margin-bottom: 10px;
        }
        .institutional-insight {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(59, 130, 246, 0.1));
            border-left: 4px solid #06b6d4;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 12px 12px 0;
        }
        .institutional-insight h4 {
            color: #06b6d4;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- Navigation Header -->
    <nav class="module-nav-header">
        <div class="container">
            <div class="nav-content">
                <a href="../../index.html" class="nav-home">‚Üê Back to Course</a>
                <div class="nav-module-info">
                    <span class="nav-module-number">Module 4.1</span>
                    <span class="nav-module-title">Volume Profile Analysis</span>
                </div>
                <a href="4.2_vwap_analysis.html" class="nav-next">Next Module ‚Üí</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="module-hero">
        <div class="container">
            <div class="module-hero-content">
                <div class="module-breadcrumb">
                    <span>Module 4: Volume Analysis</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span>4.1 Volume Profile Analysis</span>
                </div>
                <h1>Volume Profile Analysis</h1>
                <p class="module-subtitle">
                    Understand market structure through horizontal volume distribution.
                    Identify institutional support/resistance with POC and Value Area.
                </p>
                <div class="module-meta">
                    <span class="meta-item">‚è±Ô∏è 35 min read</span>
                    <span class="meta-item">üìä 4 Visualizations</span>
                    <span class="meta-item">üíª Interactive Calculator</span>
                    <span class="meta-item">‚úÖ 5 Quiz Questions</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container content-wrapper">

        <!-- PART 1: WHY SHOULD I CARE? -->
        <section class="content-section fade-in">
            <h2>Part 1: Why Should I Care?</h2>

            <div class="info-box info-box-warning">
                <div class="info-box-title">The Institutional Perspective</div>
                <p>
                    Traditional volume bars show <em>when</em> trading occurs. Volume Profile shows <em>where</em>
                    trading is concentrated‚Äîrevealing the price levels that matter most to institutional traders.
                </p>
                <p style="margin-top: 1rem; margin-bottom: 0;">
                    <strong>When an institution needs to buy $500M of stock, they target price levels with maximum liquidity.
                    Volume Profile reveals exactly where that liquidity exists.</strong>
                </p>
            </div>

            <h3>Why Volume Profile Matters</h3>

            <div class="grid grid-3">
                <div class="card">
                    <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">üéØ True Support/Resistance</h4>
                    <p style="margin: 0; font-size: 0.95rem;">
                        High Volume Nodes (HVN) are where real buying/selling occurred‚Äîfar more reliable than arbitrary lines on a chart.
                    </p>
                </div>
                <div class="card">
                    <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">‚ö° Predict Price Velocity</h4>
                    <p style="margin: 0; font-size: 0.95rem;">
                        Low Volume Nodes (LVN) indicate price inefficiency‚Äîexpect rapid moves through these zones.
                    </p>
                </div>
                <div class="card">
                    <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">üìà Find Fair Value</h4>
                    <p style="margin: 0; font-size: 0.95rem;">
                        Point of Control (POC) represents the "fairest" price where maximum trading agreement occurred.
                    </p>
                </div>
            </div>

            <div class="institutional-insight">
                <h4>üè¶ How Institutions Use Volume Profile</h4>
                <p>
                    Market makers and algorithmic trading desks use Volume Profile to:
                </p>
                <ul style="margin: 10px 0;">
                    <li>Identify optimal execution prices for large orders</li>
                    <li>Set limit orders at high-liquidity zones (HVNs)</li>
                    <li>Anticipate breakout acceleration through LVNs</li>
                    <li>Revert to POC when price extends too far</li>
                </ul>
            </div>
        </section>

        <!-- PART 2: BUILDING INTUITION -->
        <section class="content-section fade-in">
            <h2>Part 2: Building Intuition</h2>

            <div class="info-box info-box-info">
                <div class="info-box-title">Think of a Parking Garage</div>
                <p>
                    Imagine a parking garage where you track which floors have the most cars.
                    The busiest floor (POC) represents the most popular parking spot.
                    Floors with few cars (LVN) are passed through quickly‚Äîpeople don't stay there.
                    The range containing 70% of all cars is the "Value Area."
                </p>
            </div>

            <h3>Visual Volume Profile</h3>

            <div class="volume-profile-visual">
                <div class="price-ladder">
                    <div class="price-row">
                        <span class="price-label">$160</span>
                        <div class="volume-bar lvn" style="width: 15%;"></div>
                        <span style="color: #ef4444; font-size: 0.8rem;">LVN</span>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$158</span>
                        <div class="volume-bar" style="width: 25%;"></div>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$156</span>
                        <div class="volume-bar hvn" style="width: 55%;"></div>
                        <span style="color: #f59e0b; font-size: 0.8rem;">HVN (VAH)</span>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$154</span>
                        <div class="volume-bar" style="width: 70%;"></div>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$152</span>
                        <div class="volume-bar poc" style="width: 100%;"></div>
                        <span style="color: #10b981; font-size: 0.8rem;">POC</span>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$150</span>
                        <div class="volume-bar" style="width: 65%;"></div>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$148</span>
                        <div class="volume-bar hvn" style="width: 50%;"></div>
                        <span style="color: #f59e0b; font-size: 0.8rem;">HVN (VAL)</span>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$146</span>
                        <div class="volume-bar" style="width: 20%;"></div>
                    </div>
                    <div class="price-row">
                        <span class="price-label">$144</span>
                        <div class="volume-bar lvn" style="width: 10%;"></div>
                        <span style="color: #ef4444; font-size: 0.8rem;">LVN</span>
                    </div>
                </div>
            </div>

            <div class="profile-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>POC (Point of Control)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>HVN (High Volume Node)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>LVN (Low Volume Node)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #6366f1;"></div>
                    <span>Normal Volume</span>
                </div>
            </div>

            <div class="node-grid">
                <div class="node-card hvn">
                    <h4 style="color: #f59e0b;">High Volume Nodes (HVN)</h4>
                    <p>Price levels where significant trading occurred. Act as:</p>
                    <ul>
                        <li><strong>Support:</strong> HVNs below current price</li>
                        <li><strong>Resistance:</strong> HVNs above current price</li>
                    </ul>
                    <p><em>Price tends to consolidate around HVNs‚Äî"sticky" price zones.</em></p>
                </div>
                <div class="node-card lvn">
                    <h4 style="color: #ef4444;">Low Volume Nodes (LVN)</h4>
                    <p>Price levels where little agreement existed. Characteristics:</p>
                    <ul>
                        <li><strong>Fast moves:</strong> Price accelerates through LVNs</li>
                        <li><strong>Rejection zones:</strong> Price often reverses at LVNs</li>
                    </ul>
                    <p><em>LVNs represent price inefficiency‚Äîunstable equilibrium.</em></p>
                </div>
            </div>

            <div class="value-area-box">
                <h4>Value Area (VA) ‚Äî The 70% Zone</h4>
                <p>The range containing 70% of all volume, bounded by:</p>
                <ul>
                    <li><strong>VAH (Value Area High):</strong> Upper boundary</li>
                    <li><strong>VAL (Value Area Low):</strong> Lower boundary</li>
                </ul>
                <p style="margin-top: 15px;">
                    <strong>Trading Rules:</strong> Price inside VA = balanced market.
                    Price breaking VAH/VAL = potential trend initiation.
                    Failed breakouts return to POC.
                </p>
            </div>
        </section>

        <!-- PART 3: THE MATHEMATICS -->
        <section class="content-section fade-in">
            <h2>Part 3: The Mathematics</h2>

            <div class="formula-box">
                <h3>Volume at Price Level</h3>
                <div class="formula">
                    V<sub>p</sub> = Œ£<sub>i</sub> v<sub>i</sub> ¬∑ ùüô<sub>[p-Œ¥/2, p+Œ¥/2]</sub>(p<sub>i</sub>)
                </div>
                <p>Sum all volume where trade price falls within the price bucket [p-Œ¥/2, p+Œ¥/2]</p>
            </div>

            <div class="formula-box">
                <h3>Point of Control (POC)</h3>
                <div class="formula">
                    POC = argmax<sub>p</sub> V<sub>p</sub>
                </div>
                <p>The price level with maximum volume‚Äîfair value where most agreement occurred</p>
            </div>

            <div class="formula-box">
                <h3>Value Area Calculation</h3>
                <div class="formula">
                    VA = {p : V<sub>AL</sub> ‚â§ p ‚â§ V<sub>AH</sub>} where Œ£<sub>p‚ààVA</sub> V<sub>p</sub> ‚â• 0.70 ¬∑ Œ£<sub>all p</sub> V<sub>p</sub>
                </div>
                <p>Iteratively expand from POC until 70% of total volume is captured</p>
            </div>

            <div class="info-box info-box-info">
                <div class="info-box-title">Value Area Algorithm</div>
                <ol>
                    <li>Start at POC</li>
                    <li>Compare volume one tick above vs one tick below current range</li>
                    <li>Expand toward side with higher volume</li>
                    <li>Repeat until cumulative volume ‚â• 70% of total</li>
                </ol>
            </div>

            <div class="formula-box">
                <h3>Volume Node Classification (Z-Score)</h3>
                <div class="formula">
                    z<sub>p</sub> = (V<sub>p</sub> - Œº<sub>V</sub>) / œÉ<sub>V</sub>
                </div>
                <p>
                    <strong>HVN:</strong> z<sub>p</sub> > 1.5 (significantly above average)<br>
                    <strong>LVN:</strong> z<sub>p</sub> < -1.0 (significantly below average)
                </p>
            </div>

            <div class="formula-box">
                <h3>Normalized Volume Profile</h3>
                <div class="formula">
                    VÃÇ<sub>p</sub> = (V<sub>p</sub> / Œ£<sub>all p</sub> V<sub>p</sub>) √ó 100%
                </div>
                <p>Percentage of total volume at each price level‚Äîenables cross-period comparison</p>
            </div>
        </section>

        <!-- PART 4: KEY PROPERTIES -->
        <section class="content-section fade-in">
            <h2>Part 4: Key Properties for Trading</h2>

            <div class="properties-list">
                <div class="property-item">
                    <span class="property-name">POC as Fair Value Magnet</span>
                    <span class="property-desc">Price tends to return to POC during consolidation‚Äîmean reversion to fair value</span>
                </div>
                <div class="property-item">
                    <span class="property-name">Value Area as Balance Zone</span>
                    <span class="property-desc">70% of time, price trades within VA. Breaks signal potential trend moves</span>
                </div>
                <div class="property-item">
                    <span class="property-name">LVN Acceleration</span>
                    <span class="property-desc">Price velocity increases in LVNs‚Äîno volume to absorb momentum</span>
                </div>
                <div class="property-item">
                    <span class="property-name">HVN as Support/Resistance</span>
                    <span class="property-desc">High volume = high interest. These levels are defended by market participants</span>
                </div>
            </div>

            <h3>Volume Profile Shapes</h3>

            <div class="grid grid-2">
                <div class="card">
                    <h4>P-Shape Profile</h4>
                    <p>Volume concentrated at top. Indicates short covering rally‚Äîsellers trapped, forced to buy back.</p>
                    <div class="highlight">Potential reversal DOWN from highs</div>
                </div>
                <div class="card">
                    <h4>b-Shape Profile</h4>
                    <p>Volume concentrated at bottom. Indicates long liquidation‚Äîbuyers capitulated at lows.</p>
                    <div class="highlight">Potential reversal UP from lows</div>
                </div>
                <div class="card">
                    <h4>D-Shape Profile</h4>
                    <p>Normal distribution, POC in middle. Balanced market in equilibrium.</p>
                    <div class="highlight">Range-bound, fade extremes</div>
                </div>
                <div class="card">
                    <h4>B-Shape Profile</h4>
                    <p>Bimodal‚Äîtwo HVNs separated by LVN. Market undecided between two values.</p>
                    <div class="highlight">Breakout imminent, direction TBD</div>
                </div>
            </div>
        </section>

        <!-- PART 5: PYTHON IMPLEMENTATION -->
        <section class="content-section fade-in">
            <h2>Part 5: Python Implementation</h2>

            <div class="code-block">
                <div class="code-header">
                    <span>Complete Volume Profile Calculator</span>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                </div>
                <pre><code class="language-python">import numpy as np
import pandas as pd
from typing import Tuple, List, Dict
from dataclasses import dataclass


@dataclass
class VolumeProfileResult:
    """Container for Volume Profile analysis results."""
    price_levels: np.ndarray
    volume_at_price: np.ndarray
    poc: float
    poc_volume: float
    vah: float
    val: float
    hvn_levels: List[float]
    lvn_levels: List[float]
    total_volume: float


class VolumeProfileAnalyzer:
    """
    Professional Volume Profile analyzer.

    Calculates POC, Value Area, and identifies HVN/LVN zones.
    """

    def __init__(
        self,
        num_bins: int = 50,
        value_area_pct: float = 0.70,
        hvn_threshold: float = 1.5,
        lvn_threshold: float = -1.0
    ):
        """
        Initialize analyzer.

        Args:
            num_bins: Number of price buckets
            value_area_pct: Target percentage for Value Area
            hvn_threshold: Z-score threshold for HVN
            lvn_threshold: Z-score threshold for LVN
        """
        self.num_bins = num_bins
        self.value_area_pct = value_area_pct
        self.hvn_threshold = hvn_threshold
        self.lvn_threshold = lvn_threshold

    def calculate_profile(
        self,
        prices: np.ndarray,
        volumes: np.ndarray
    ) -> VolumeProfileResult:
        """
        Calculate complete Volume Profile.

        Args:
            prices: Array of trade prices
            volumes: Array of trade volumes

        Returns:
            VolumeProfileResult with all metrics
        """
        # Create price bins
        price_min, price_max = prices.min(), prices.max()
        bin_edges = np.linspace(price_min, price_max, self.num_bins + 1)
        price_levels = (bin_edges[:-1] + bin_edges[1:]) / 2

        # Aggregate volume at each price level
        volume_at_price = np.zeros(self.num_bins)
        for price, volume in zip(prices, volumes):
            bin_idx = np.searchsorted(bin_edges[1:], price)
            bin_idx = min(bin_idx, self.num_bins - 1)
            volume_at_price[bin_idx] += volume

        # Find POC (Point of Control)
        poc_idx = np.argmax(volume_at_price)
        poc = price_levels[poc_idx]
        poc_volume = volume_at_price[poc_idx]

        # Calculate Value Area
        vah, val = self._calculate_value_area(
            price_levels, volume_at_price, poc_idx
        )

        # Identify HVN and LVN
        hvn_levels, lvn_levels = self._classify_nodes(
            price_levels, volume_at_price
        )

        return VolumeProfileResult(
            price_levels=price_levels,
            volume_at_price=volume_at_price,
            poc=poc,
            poc_volume=poc_volume,
            vah=vah,
            val=val,
            hvn_levels=hvn_levels,
            lvn_levels=lvn_levels,
            total_volume=volume_at_price.sum()
        )

    def _calculate_value_area(
        self,
        price_levels: np.ndarray,
        volume_at_price: np.ndarray,
        poc_idx: int
    ) -> Tuple[float, float]:
        """Calculate Value Area using iterative expansion."""
        total_volume = volume_at_price.sum()
        target_volume = total_volume * self.value_area_pct

        cumulative = volume_at_price[poc_idx]
        upper_idx = poc_idx
        lower_idx = poc_idx

        while cumulative < target_volume:
            vol_above = (
                volume_at_price[upper_idx + 1]
                if upper_idx + 1 < len(volume_at_price) else 0
            )
            vol_below = (
                volume_at_price[lower_idx - 1]
                if lower_idx > 0 else 0
            )

            if vol_above >= vol_below and upper_idx + 1 < len(volume_at_price):
                upper_idx += 1
                cumulative += volume_at_price[upper_idx]
            elif lower_idx > 0:
                lower_idx -= 1
                cumulative += volume_at_price[lower_idx]
            else:
                break

        return price_levels[upper_idx], price_levels[lower_idx]

    def _classify_nodes(
        self,
        price_levels: np.ndarray,
        volume_at_price: np.ndarray
    ) -> Tuple[List[float], List[float]]:
        """Classify price levels as HVN or LVN using z-scores."""
        mean_vol = volume_at_price.mean()
        std_vol = volume_at_price.std()

        if std_vol == 0:
            return [], []

        z_scores = (volume_at_price - mean_vol) / std_vol

        hvn = price_levels[z_scores > self.hvn_threshold].tolist()
        lvn = price_levels[z_scores < self.lvn_threshold].tolist()

        return hvn, lvn


def generate_trading_signals(
    profile: VolumeProfileResult,
    current_price: float
) -> Dict:
    """
    Generate trading signals from Volume Profile.

    Args:
        profile: VolumeProfileResult from analysis
        current_price: Current market price

    Returns:
        Dictionary with signals and key levels
    """
    signals = {
        'position_vs_value_area': None,
        'nearest_support': None,
        'nearest_resistance': None,
        'poc_distance_pct': None,
        'trading_bias': None
    }

    # Position relative to Value Area
    if current_price > profile.vah:
        signals['position_vs_value_area'] = 'above_vah'
        signals['trading_bias'] = 'extended_bullish'
    elif current_price < profile.val:
        signals['position_vs_value_area'] = 'below_val'
        signals['trading_bias'] = 'extended_bearish'
    else:
        signals['position_vs_value_area'] = 'inside_va'
        signals['trading_bias'] = 'neutral_balanced'

    # Distance to POC
    signals['poc_distance_pct'] = (
        (current_price - profile.poc) / profile.poc * 100
    )

    # Find nearest support/resistance from HVN
    supports = [h for h in profile.hvn_levels if h < current_price]
    resistances = [h for h in profile.hvn_levels if h > current_price]

    if supports:
        signals['nearest_support'] = max(supports)
    if resistances:
        signals['nearest_resistance'] = min(resistances)

    return signals


# Example usage
if __name__ == "__main__":
    np.random.seed(42)

    # Simulate OHLCV data with volume clustering around $150
    n_trades = 5000
    prices = 150 + np.random.randn(n_trades) * 5
    # More volume near $150 (fair value)
    volumes = 1000 + np.exp(-((prices - 150) ** 2) / 50) * 5000
    volumes += np.random.rand(n_trades) * 500

    # Analyze
    analyzer = VolumeProfileAnalyzer(num_bins=50)
    profile = analyzer.calculate_profile(prices, volumes)

    print("=" * 50)
    print("VOLUME PROFILE ANALYSIS")
    print("=" * 50)
    print(f"\nPoint of Control (POC): ${profile.poc:.2f}")
    print(f"POC Volume: {profile.poc_volume:,.0f}")
    print(f"\nValue Area High (VAH): ${profile.vah:.2f}")
    print(f"Value Area Low (VAL): ${profile.val:.2f}")
    print(f"Value Area Width: ${profile.vah - profile.val:.2f}")
    print(f"\nHigh Volume Nodes: {len(profile.hvn_levels)}")
    print(f"Low Volume Nodes: {len(profile.lvn_levels)}")

    # Generate signals
    current_price = 153.50
    signals = generate_trading_signals(profile, current_price)

    print(f"\n--- Trading Signals (Price: ${current_price}) ---")
    print(f"Position: {signals['position_vs_value_area']}")
    print(f"Bias: {signals['trading_bias']}")
    print(f"Distance to POC: {signals['poc_distance_pct']:.2f}%")</code></pre>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <span>Value Area Trading Strategy</span>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                </div>
                <pre><code class="language-python">def value_area_strategy(
    current_price: float,
    vah: float,
    val: float,
    poc: float,
    prev_close_location: str
) -> Dict:
    """
    Value Area trading strategy based on previous close.

    Rules:
    - Prev close IN VA, open IN VA ‚Üí Range day, fade extremes
    - Prev close OUT VA, open IN VA ‚Üí Trade to opposite VA boundary
    - Prev close IN VA, open OUT VA ‚Üí Breakout, trade with momentum

    Args:
        current_price: Current/open price
        vah: Value Area High
        val: Value Area Low
        poc: Point of Control
        prev_close_location: 'inside_va', 'above_va', or 'below_va'

    Returns:
        Trading signal dictionary
    """
    signal = {
        'action': None,
        'entry': current_price,
        'target': None,
        'stop': None,
        'rationale': None
    }

    in_va = val <= current_price <= vah

    if in_va:
        if prev_close_location == 'inside_va':
            # Range day expected - fade moves to VA boundaries
            if current_price > poc:
                signal['action'] = 'SHORT'
                signal['target'] = poc
                signal['stop'] = vah * 1.005
                signal['rationale'] = 'Fade to POC in balanced market'
            else:
                signal['action'] = 'LONG'
                signal['target'] = poc
                signal['stop'] = val * 0.995
                signal['rationale'] = 'Fade to POC in balanced market'
        else:
            # Market accepting value - trade to opposite boundary
            if prev_close_location == 'above_va':
                signal['action'] = 'SHORT'
                signal['target'] = val
                signal['stop'] = vah * 1.005
                signal['rationale'] = 'Rejection from above, target VAL'
            else:  # below_va
                signal['action'] = 'LONG'
                signal['target'] = vah
                signal['stop'] = val * 0.995
                signal['rationale'] = 'Acceptance from below, target VAH'
    else:
        # Outside Value Area - breakout mode
        if current_price > vah:
            signal['action'] = 'LONG'
            signal['target'] = vah + (vah - val)  # 1x VA extension
            signal['stop'] = vah * 0.995
            signal['rationale'] = 'Breakout above VAH, trend continuation'
        else:  # below VAL
            signal['action'] = 'SHORT'
            signal['target'] = val - (vah - val)
            signal['stop'] = val * 1.005
            signal['rationale'] = 'Breakdown below VAL, trend continuation'

    return signal


# Example
signal = value_area_strategy(
    current_price=155.00,
    vah=156.00,
    val=148.00,
    poc=152.00,
    prev_close_location='inside_va'
)
print(f"\nSignal: {signal['action']}")
print(f"Target: ${signal['target']:.2f}")
print(f"Stop: ${signal['stop']:.2f}")
print(f"Rationale: {signal['rationale']}")</code></pre>
            </div>
        </section>

        <!-- PART 6: INTERACTIVE CALCULATOR -->
        <section class="content-section fade-in">
            <h2>Part 6: Interactive Volume Profile Calculator</h2>

            <div class="calculator">
                <h3>Calculate Volume Profile Metrics</h3>
                <p style="color: #94a3b8; margin-bottom: 20px;">
                    Enter price levels and corresponding volumes to analyze the profile.
                </p>

                <div class="input-group">
                    <label for="priceLevels">Price Levels (comma-separated):</label>
                    <input type="text" id="priceLevels" value="145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155"
                           placeholder="e.g., 145, 146, 147, ...">
                </div>

                <div class="input-group">
                    <label for="volumeLevels">Volume at Each Level:</label>
                    <input type="text" id="volumeLevels" value="5000, 8000, 15000, 25000, 35000, 50000, 40000, 30000, 18000, 10000, 6000"
                           placeholder="e.g., 5000, 8000, 15000, ...">
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0;">
                    <div class="input-group">
                        <label for="valueAreaPct">Value Area %:</label>
                        <input type="number" id="valueAreaPct" value="70" min="50" max="90" step="5">
                    </div>
                    <div class="input-group">
                        <label for="currentPriceVP">Current Price ($):</label>
                        <input type="number" id="currentPriceVP" value="151" step="0.5">
                    </div>
                </div>

                <button class="btn" onclick="calculateVolumeProfile()">Calculate Profile</button>

                <div id="vpResults" style="margin-top: 20px;">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <div class="chart-container">
                <h3>Volume Profile Visualization</h3>
                <canvas id="volumeProfileChart"></canvas>
            </div>
        </section>

        <!-- PART 7: TRADING APPLICATIONS -->
        <section class="content-section fade-in">
            <h2>Part 7: Trading Applications</h2>

            <div class="card-grid">
                <div class="card">
                    <h4>Naked POC Strategy</h4>
                    <p>Historical POCs that haven't been revisited act as price magnets. Track and target them.</p>
                    <div class="highlight">Often filled within 5 sessions</div>
                </div>
                <div class="card">
                    <h4>LVN Breakout Play</h4>
                    <p>When price enters an LVN, expect acceleration. Set targets at the next HVN.</p>
                    <div class="highlight">Fast moves, tight stops</div>
                </div>
                <div class="card">
                    <h4>Initial Balance (IB)</h4>
                    <p>First hour's range establishes reference. IB break + Volume Profile confluence = high-probability trade.</p>
                    <div class="highlight">Combine with VA levels</div>
                </div>
                <div class="card">
                    <h4>Multi-Day Composite</h4>
                    <p>Combine multiple sessions to identify longer-term key levels. More volume = stronger level.</p>
                    <div class="highlight">Institutional reference</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Price Action with Volume Profile Overlay</h3>
                <canvas id="priceVolumeChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Value Area Evolution Over Time</h3>
                <canvas id="valueAreaChart"></canvas>
            </div>
        </section>

        <!-- PART 8: COMMON MISTAKES -->
        <section class="content-section fade-in">
            <h2>Part 8: Common Mistakes to Avoid</h2>

            <div class="warning-box">
                <h3>Mistake 1: Wrong Timeframe Mismatch</h3>
                <p>Using a daily profile for scalping or a 30-min profile for swing trading. Match profile period to your trading horizon.</p>
            </div>

            <div class="warning-box">
                <h3>Mistake 2: Ignoring Profile Context</h3>
                <p>An HVN formed during a selloff (distribution) behaves differently than one formed during accumulation. Understand HOW the volume developed.</p>
            </div>

            <div class="warning-box">
                <h3>Mistake 3: Static Analysis</h3>
                <p>Never updating your profile. Market structure evolves‚Äîrecalculate regularly and weight recent data more heavily.</p>
            </div>

            <div class="warning-box">
                <h3>Mistake 4: Too Many Bins</h3>
                <p>Using 500+ price bins creates noise. Stick to 30-100 bins depending on the price range. The goal is zones, not exact prices.</p>
            </div>

            <div class="warning-box">
                <h3>Mistake 5: POC-Only Trading</h3>
                <p>Blindly fading to POC without trend context. In strong trends, price leaves old POCs behind. Always combine with momentum analysis.</p>
            </div>
        </section>

        <!-- SUMMARY -->
        <section class="content-section fade-in">
            <h2>Summary</h2>

            <div class="key-concept">
                <h3>Key Takeaways</h3>
                <ul>
                    <li><strong>Volume Profile:</strong> Horizontal histogram showing volume at each price level</li>
                    <li><strong>POC:</strong> Price with maximum volume‚Äîfair value and price magnet</li>
                    <li><strong>Value Area:</strong> 70% of volume between VAH and VAL‚Äîbalance zone</li>
                    <li><strong>HVN:</strong> High volume = strong support/resistance, price consolidates</li>
                    <li><strong>LVN:</strong> Low volume = price inefficiency, expect acceleration</li>
                </ul>
            </div>

            <div class="nav-buttons">
                <a href="../module_3_calculus/3.4_optimization_techniques.html" class="nav-btn">‚Üê Previous: Optimization Techniques</a>
                <a href="4.2_vwap_analysis.html" class="nav-btn">Next: VWAP Analysis ‚Üí</a>
            </div>
        </section>

        <!-- QUIZ -->
        <section class="content-section fade-in">
            <h2>Test Your Knowledge</h2>

            <div class="quiz-container" id="quiz">
                <div class="quiz-question">
                    <h4>Question 1: What does POC (Point of Control) represent?</h4>
                    <div class="quiz-options">
                        <label><input type="radio" name="q1" value="a"> The highest price in the session</label>
                        <label><input type="radio" name="q1" value="b"> The price level with maximum traded volume</label>
                        <label><input type="radio" name="q1" value="c"> The opening price</label>
                        <label><input type="radio" name="q1" value="d"> The average of all prices</label>
                    </div>
                    <div class="quiz-feedback" id="feedback1"></div>
                </div>

                <div class="quiz-question">
                    <h4>Question 2: What percentage of volume does the Value Area typically contain?</h4>
                    <div class="quiz-options">
                        <label><input type="radio" name="q2" value="a"> 50%</label>
                        <label><input type="radio" name="q2" value="b"> 60%</label>
                        <label><input type="radio" name="q2" value="c"> 70%</label>
                        <label><input type="radio" name="q2" value="d"> 80%</label>
                    </div>
                    <div class="quiz-feedback" id="feedback2"></div>
                </div>

                <div class="quiz-question">
                    <h4>Question 3: How does price typically behave when entering a Low Volume Node (LVN)?</h4>
                    <div class="quiz-options">
                        <label><input type="radio" name="q3" value="a"> Consolidates and ranges</label>
                        <label><input type="radio" name="q3" value="b"> Accelerates and moves quickly through</label>
                        <label><input type="radio" name="q3" value="c"> Always reverses</label>
                        <label><input type="radio" name="q3" value="d"> Volume increases dramatically</label>
                    </div>
                    <div class="quiz-feedback" id="feedback3"></div>
                </div>

                <div class="quiz-question">
                    <h4>Question 4: What does a P-shaped Volume Profile indicate?</h4>
                    <div class="quiz-options">
                        <label><input type="radio" name="q4" value="a"> Accumulation at lows</label>
                        <label><input type="radio" name="q4" value="b"> Short covering rally, volume concentrated at highs</label>
                        <label><input type="radio" name="q4" value="c"> Balanced market</label>
                        <label><input type="radio" name="q4" value="d"> Market in uptrend</label>
                    </div>
                    <div class="quiz-feedback" id="feedback4"></div>
                </div>

                <div class="quiz-question">
                    <h4>Question 5: What is a "Naked POC"?</h4>
                    <div class="quiz-options">
                        <label><input type="radio" name="q5" value="a"> A POC with unusually high volume</label>
                        <label><input type="radio" name="q5" value="b"> A historical POC that price hasn't revisited</label>
                        <label><input type="radio" name="q5" value="c"> A POC at session lows</label>
                        <label><input type="radio" name="q5" value="d"> The current day's POC</label>
                    </div>
                    <div class="quiz-feedback" id="feedback5"></div>
                </div>

                <button class="btn" onclick="checkQuiz()">Submit Answers</button>
                <div class="quiz-score" id="quizScore"></div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="../../assets/js/shared-scripts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
        let volumeProfileChart, priceVolumeChart, valueAreaChart;

        function initializeCharts() {
            // Volume Profile Chart
            const ctx1 = document.getElementById('volumeProfileChart').getContext('2d');
            volumeProfileChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Volume',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Volume Profile (Horizontal)', color: '#e2e8f0' }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Volume', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Price Level', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            // Price with Volume Profile overlay
            const ctx2 = document.getElementById('priceVolumeChart').getContext('2d');

            // Generate sample price data
            const days = 30;
            const priceData = [];
            let price = 150;
            for (let i = 0; i < days; i++) {
                price += (Math.random() - 0.48) * 2;
                priceData.push(price);
            }

            priceVolumeChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: Array.from({length: days}, (_, i) => `Day ${i + 1}`),
                    datasets: [{
                        label: 'Price',
                        data: priceData,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        annotation: {
                            annotations: {
                                poc: {
                                    type: 'line',
                                    yMin: 150,
                                    yMax: 150,
                                    borderColor: '#10b981',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: { display: true, content: 'POC $150', color: '#10b981' }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                        y: {
                            title: { display: true, text: 'Price ($)', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            // Value Area Evolution
            const ctx3 = document.getElementById('valueAreaChart').getContext('2d');
            const vaData = {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'],
                vah: [155, 156, 158, 157, 159],
                val: [145, 146, 148, 149, 151],
                poc: [150, 151, 153, 153, 155]
            };

            valueAreaChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: vaData.labels,
                    datasets: [
                        {
                            label: 'VAH',
                            data: vaData.vah,
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.2)',
                            fill: '+1'
                        },
                        {
                            label: 'VAL',
                            data: vaData.val,
                            borderColor: '#a855f7',
                            fill: false
                        },
                        {
                            label: 'POC',
                            data: vaData.poc,
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        title: { display: true, text: 'Value Area Migrating Higher (Uptrend)', color: '#94a3b8' }
                    },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                        y: {
                            title: { display: true, text: 'Price ($)', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            // Initial calculation
            calculateVolumeProfile();
        }

        function calculateVolumeProfile() {
            const pricesStr = document.getElementById('priceLevels').value;
            const volumesStr = document.getElementById('volumeLevels').value;
            const vaPct = parseFloat(document.getElementById('valueAreaPct').value) / 100;
            const currentPrice = parseFloat(document.getElementById('currentPriceVP').value);

            const prices = pricesStr.split(',').map(p => parseFloat(p.trim()));
            const volumes = volumesStr.split(',').map(v => parseFloat(v.trim()));

            if (prices.length !== volumes.length) {
                alert('Price and volume arrays must have the same length');
                return;
            }

            // Calculate metrics
            const totalVolume = volumes.reduce((a, b) => a + b, 0);
            const pocIdx = volumes.indexOf(Math.max(...volumes));
            const poc = prices[pocIdx];
            const pocVolume = volumes[pocIdx];

            // Value Area calculation
            let cumVolume = pocVolume;
            let upperIdx = pocIdx;
            let lowerIdx = pocIdx;
            const targetVolume = totalVolume * vaPct;

            while (cumVolume < targetVolume) {
                const volAbove = upperIdx + 1 < volumes.length ? volumes[upperIdx + 1] : 0;
                const volBelow = lowerIdx > 0 ? volumes[lowerIdx - 1] : 0;

                if (volAbove >= volBelow && upperIdx + 1 < volumes.length) {
                    upperIdx++;
                    cumVolume += volumes[upperIdx];
                } else if (lowerIdx > 0) {
                    lowerIdx--;
                    cumVolume += volumes[lowerIdx];
                } else {
                    break;
                }
            }

            const vah = prices[upperIdx];
            const val = prices[lowerIdx];

            // Classify nodes (simple z-score)
            const meanVol = totalVolume / volumes.length;
            const stdVol = Math.sqrt(volumes.map(v => (v - meanVol) ** 2).reduce((a, b) => a + b) / volumes.length);

            const hvnLevels = [];
            const lvnLevels = [];
            volumes.forEach((v, i) => {
                const z = (v - meanVol) / stdVol;
                if (z > 1.5) hvnLevels.push(prices[i]);
                if (z < -1) lvnLevels.push(prices[i]);
            });

            // Position analysis
            let position = 'Inside Value Area';
            let bias = 'Neutral - Balanced';
            if (currentPrice > vah) {
                position = 'Above VAH';
                bias = 'Extended Bullish - Watch for mean reversion';
            } else if (currentPrice < val) {
                position = 'Below VAL';
                bias = 'Extended Bearish - Watch for mean reversion';
            }

            // Update results
            document.getElementById('vpResults').innerHTML = `
                <div class="grid grid-2" style="gap: 15px;">
                    <div class="card" style="text-align: center;">
                        <h4 style="color: #10b981;">POC</h4>
                        <p style="font-size: 1.5rem; font-weight: bold;">$${poc.toFixed(2)}</p>
                        <p style="color: #94a3b8; font-size: 0.9rem;">Volume: ${pocVolume.toLocaleString()}</p>
                    </div>
                    <div class="card" style="text-align: center;">
                        <h4 style="color: #a855f7;">Value Area</h4>
                        <p style="font-size: 1.2rem;">$${val.toFixed(2)} - $${vah.toFixed(2)}</p>
                        <p style="color: #94a3b8; font-size: 0.9rem;">Width: $${(vah - val).toFixed(2)}</p>
                    </div>
                </div>
                <div class="info-box info-box-info" style="margin-top: 15px;">
                    <p><strong>Current Price:</strong> $${currentPrice.toFixed(2)} ‚Äî ${position}</p>
                    <p><strong>Trading Bias:</strong> ${bias}</p>
                    <p><strong>Distance to POC:</strong> ${((currentPrice - poc) / poc * 100).toFixed(2)}%</p>
                    ${hvnLevels.length > 0 ? `<p><strong>HVN Levels:</strong> $${hvnLevels.map(h => h.toFixed(0)).join(', $')}</p>` : ''}
                    ${lvnLevels.length > 0 ? `<p><strong>LVN Levels:</strong> $${lvnLevels.map(l => l.toFixed(0)).join(', $')}</p>` : ''}
                </div>
            `;

            // Update chart
            const colors = prices.map((p, i) => {
                if (i === pocIdx) return 'rgba(16, 185, 129, 0.8)';
                if (p >= val && p <= vah) return 'rgba(168, 85, 247, 0.6)';
                const z = (volumes[i] - meanVol) / stdVol;
                if (z > 1.5) return 'rgba(245, 158, 11, 0.7)';
                if (z < -1) return 'rgba(239, 68, 68, 0.5)';
                return 'rgba(99, 102, 241, 0.6)';
            });

            volumeProfileChart.data.labels = prices.map(p => '$' + p.toFixed(0));
            volumeProfileChart.data.datasets[0].data = volumes;
            volumeProfileChart.data.datasets[0].backgroundColor = colors;
            volumeProfileChart.update();
        }

        function checkQuiz() {
            const answers = {
                q1: { correct: 'b', explanation: 'POC is the price level with maximum traded volume‚Äîrepresenting fair value where most agreement occurred.' },
                q2: { correct: 'c', explanation: 'The Value Area contains 70% of total volume by standard convention (approximately one standard deviation).' },
                q3: { correct: 'b', explanation: 'LVNs are areas of price inefficiency with no significant volume to absorb momentum, causing price to accelerate through.' },
                q4: { correct: 'b', explanation: 'P-shape has volume concentrated at the top, indicating a short covering rally where shorts were forced to buy at highs.' },
                q5: { correct: 'b', explanation: 'A Naked POC is a historical POC that price hasn\'t revisited since formation‚Äîthese often act as future price magnets.' }
            };

            let score = 0;
            for (const [q, data] of Object.entries(answers)) {
                const selected = document.querySelector(`input[name="${q}"]:checked`);
                const feedback = document.getElementById(`feedback${q.slice(1)}`);

                if (selected && selected.value === data.correct) {
                    score++;
                    feedback.innerHTML = `<span style="color: #10b981;">‚úì Correct!</span> ${data.explanation}`;
                } else {
                    feedback.innerHTML = `<span style="color: #ef4444;">‚úó Incorrect.</span> ${data.explanation}`;
                }
                feedback.style.display = 'block';
            }

            const pct = (score / 5 * 100).toFixed(0);
            document.getElementById('quizScore').innerHTML = `
                <h3>Score: ${score}/5 (${pct}%)</h3>
                <p>${pct >= 80 ? 'Excellent! You understand Volume Profile analysis.' : pct >= 60 ? 'Good progress! Review the concepts.' : 'Keep studying the material.'}</p>
            `;
        }

        document.addEventListener('DOMContentLoaded', initializeCharts);
    </script>
</body>
</html>