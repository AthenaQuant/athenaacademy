<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Master comprehensive risk management for quantitative trading. Learn VaR, CVaR, Sharpe ratio, Sortino ratio, maximum drawdown, and risk-adjusted performance metrics.">
    <title>7.1 Complete Risk Management Framework | Quantitative Trading Mastery</title>

    <link rel="stylesheet" href="../../assets/css/shared-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">

    <style>
        .key-concept { background: var(--bg-card); border-left: 4px solid var(--accent-cyan); padding: 1.5rem; border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: 1.5rem 0; }
        .key-concept h3 { color: var(--accent-cyan); margin-bottom: 1rem; }
        .important-note { background: var(--warning-bg); border-left: 4px solid var(--warning); padding: 1.5rem; border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: 1.5rem 0; }
        .important-note h3 { color: var(--warning); margin-bottom: 0.5rem; }
        .risk-metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .risk-metric-card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .risk-metric-card h4 { color: var(--accent-blue); margin-bottom: 0.75rem; font-size: 1.1rem; }
        .risk-metric-card .formula { font-family: var(--font-mono); font-size: 0.9rem; color: var(--accent-purple); background: var(--bg-secondary); padding: 0.75rem; border-radius: var(--radius-sm); margin: 0.75rem 0; }
        .metric-value { font-size: 2rem; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--error); }
        .metric-value.neutral { color: var(--accent-blue); }
        .comparison-table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
        .comparison-table th, .comparison-table td { padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .comparison-table th { background: var(--bg-secondary); color: var(--text-primary); font-weight: 600; }
        .comparison-table tr:hover { background: var(--bg-card); }
        .calculator-container { background: var(--bg-card); border-radius: var(--radius-lg); padding: 2rem; margin: 2rem 0; border: 1px solid rgba(255,255,255,0.1); }
        .calculator-container h3 { color: var(--accent-purple); margin-bottom: 1.5rem; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .input-group input, .input-group select { width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); color: var(--text-primary); font-size: 1rem; }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .calculate-btn { background: var(--gradient-secondary); color: white; border: none; padding: 1rem 2rem; border-radius: var(--radius-md); cursor: pointer; font-size: 1rem; font-weight: 600; width: 100%; margin-top: 1rem; transition: transform 0.2s, box-shadow 0.2s; }
        .calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .results-container { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 1.5rem; margin-top: 1.5rem; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .result-item { text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md); }
        .result-label { font-size: 0.85rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem; }
        .result-value { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
        .quiz-container { background: var(--bg-card); border-radius: var(--radius-lg); padding: 2rem; margin: 2rem 0; }
        .quiz-question { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .quiz-question:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .quiz-question h4 { color: var(--text-primary); margin-bottom: 1rem; }
        .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .quiz-options button { background: var(--bg-secondary); border: 2px solid transparent; padding: 1rem; border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; text-align: left; transition: all 0.2s; }
        .quiz-options button:hover:not(:disabled) { border-color: var(--accent-blue); background: var(--bg-tertiary); }
        .quiz-options button:disabled { cursor: not-allowed; opacity: 0.7; }
        .quiz-feedback { margin-top: 1rem; padding: 1rem; border-radius: var(--radius-md); display: none; }
        .quiz-feedback .correct { background: var(--success-bg); color: var(--success); }
        .quiz-feedback .incorrect { background: var(--error-bg); color: var(--error); }
        .score-container { text-align: center; padding: 2rem; background: var(--gradient-secondary); border-radius: var(--radius-lg); margin-top: 2rem; display: none; }
        .code-block { background: #1a1f2e; border-radius: var(--radius-lg); overflow: hidden; margin: 1.5rem 0; }
        .code-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg-tertiary); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .code-header span { color: var(--text-muted); font-size: 0.85rem; }
        .code-block pre { margin: 0; padding: 1.5rem; overflow-x: auto; }
        .code-block code { font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 0.9rem; line-height: 1.6; }
        .chart-container { background: var(--bg-card); border-radius: var(--radius-lg); padding: 1.5rem; margin: 2rem 0; border: 1px solid rgba(255,255,255,0.1); position: relative; height: 400px; }
        .chart-container canvas { max-height: 350px; }
        .risk-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .dashboard-metric { background: var(--bg-card); border-radius: var(--radius-md); padding: 1.5rem; text-align: center; border-left: 4px solid var(--accent-blue); }
        .dashboard-metric.var { border-color: var(--error); }
        .dashboard-metric.sharpe { border-color: var(--success); }
        .dashboard-metric.sortino { border-color: var(--accent-purple); }
        .dashboard-metric.drawdown { border-color: var(--warning); }
    </style>
</head>
<body>
    <nav class="module-nav-header">
        <div class="container">
            <div class="nav-content">
                <a href="../../index.html" class="nav-home">‚Üê Back to Course</a>
                <div class="nav-module-info">
                    <span class="nav-module-number">Module 7.1</span>
                    <span class="nav-module-title">Risk Management Framework</span>
                </div>
                <a href="../../index.html" class="nav-next">Complete Course ‚Üí</a>
            </div>
        </div>
    </nav>

    <header class="module-hero">
        <div class="container">
            <div class="module-hero-content">
                <div class="module-breadcrumb">
                    <span>Module 7: Risk Metrics</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span>7.1 Complete Risk Management Framework</span>
                </div>
                <h1>Complete Risk Management Framework</h1>
                <p class="module-subtitle">
                    Master every risk metric used by professional quants: VaR, CVaR, Sharpe, Sortino,
                    maximum drawdown, beta, and comprehensive risk-adjusted performance measurement.
                </p>
                <div class="module-meta">
                    <span class="meta-item">‚è±Ô∏è 75 min read</span>
                    <span class="meta-item">üìä 8 Visualizations</span>
                    <span class="meta-item">üíª Risk Dashboard</span>
                    <span class="meta-item">‚úÖ 5 Quiz Questions</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container content-wrapper">
        <!-- Part 1: Why Should I Care? -->
        <section class="content-section fade-in">
            <h2>Part 1: Why Should I Care?</h2>

            <div class="important-note">
                <h3>‚ö†Ô∏è The Cost of Ignoring Risk</h3>
                <p>
                    Long-Term Capital Management (LTCM) had Nobel laureates, 40% annual returns, and sophisticated models.
                    They lost $4.6 billion in weeks and nearly crashed the global financial system. Why? <strong>They underestimated
                    tail risk and over-leveraged.</strong> Risk management isn't optional‚Äîit's survival.
                </p>
            </div>

            <div class="risk-metric-grid">
                <div class="risk-metric-card">
                    <h4>üéØ Regulatory Compliance</h4>
                    <p>Banks must hold capital based on VaR. Funds report Sharpe ratios. Understanding these metrics is legally required in finance.</p>
                </div>
                <div class="risk-metric-card">
                    <h4>üíº Investor Communication</h4>
                    <p>Institutional investors demand risk metrics. "We returned 20%" means nothing without risk context. Sharpe ratio tells the real story.</p>
                </div>
                <div class="risk-metric-card">
                    <h4>üìä Strategy Comparison</h4>
                    <p>Two strategies: 15% return with 10% vol vs 20% return with 25% vol. Which is better? Risk-adjusted metrics provide the answer.</p>
                </div>
                <div class="risk-metric-card">
                    <h4>üõ°Ô∏è Position Sizing</h4>
                    <p>How much to risk on each trade? VaR and volatility metrics directly determine position sizes and leverage limits.</p>
                </div>
            </div>

            <div class="key-concept">
                <h3>The Risk Management Hierarchy</h3>
                <ol style="color: var(--text-secondary); line-height: 1.8;">
                    <li><strong>Volatility Metrics:</strong> Standard deviation, variance‚Äîmeasure dispersion of returns</li>
                    <li><strong>Downside Risk:</strong> VaR, CVaR, semi-deviation‚Äîfocus on losses, not just variance</li>
                    <li><strong>Drawdown Analysis:</strong> Maximum drawdown, recovery time‚Äîmeasure peak-to-trough declines</li>
                    <li><strong>Risk-Adjusted Returns:</strong> Sharpe, Sortino, Calmar‚Äîreturn per unit of risk</li>
                    <li><strong>Factor Exposure:</strong> Beta, correlation‚Äîsensitivity to market movements</li>
                </ol>
            </div>
        </section>

        <!-- Part 2: Volatility Metrics -->
        <section class="content-section fade-in">
            <h2>Part 2: Volatility & Standard Deviation</h2>

            <p>Volatility measures the dispersion of returns around the mean. Higher volatility = more uncertainty = more risk.</p>

            <div class="formula-box">
                <h3>Standard Deviation (œÉ)</h3>
                <div class="formula" style="text-align: center; font-size: 1.3rem; padding: 1rem;">
                    œÉ = ‚àö[Œ£(r·µ¢ - rÃÑ)¬≤ / (n-1)]
                </div>
                <p style="text-align: center; color: var(--text-muted); margin-top: 0.5rem;">
                    Square root of variance; in same units as returns
                </p>
            </div>

            <div class="formula-box">
                <h3>Annualized Volatility</h3>
                <div class="formula" style="text-align: center; font-size: 1.3rem; padding: 1rem;">
                    œÉ_annual = œÉ_daily √ó ‚àö252
                </div>
                <p style="text-align: center; color: var(--text-muted); margin-top: 0.5rem;">
                    252 trading days per year; scale daily to annual
                </p>
            </div>

            <div class="info-box info-box-info">
                <div class="info-box-title">üìä Typical Volatility Levels</div>
                <table class="comparison-table">
                    <thead>
                        <tr><th>Asset Class</th><th>Annual Volatility</th><th>Daily Move (1œÉ)</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>US Treasuries</td><td>4-8%</td><td>0.25-0.50%</td></tr>
                        <tr><td>S&P 500</td><td>15-20%</td><td>0.95-1.25%</td></tr>
                        <tr><td>Individual Stocks</td><td>25-40%</td><td>1.6-2.5%</td></tr>
                        <tr><td>Bitcoin</td><td>60-80%</td><td>3.8-5.0%</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Part 3: VaR & CVaR -->
        <section class="content-section fade-in">
            <h2>Part 3: Value at Risk (VaR) & CVaR</h2>

            <div class="key-concept">
                <h3>Value at Risk (VaR)</h3>
                <p>VaR answers: "What's the maximum I could lose with X% confidence over Y time period?"</p>
                <p style="margin-top: 1rem;"><strong>Example:</strong> 1-day 95% VaR of $1M means there's a 5% chance of losing more than $1M in one day.</p>
            </div>

            <div class="formula-box">
                <h3>Parametric VaR (Normal Distribution)</h3>
                <div class="formula" style="text-align: center; font-size: 1.3rem; padding: 1rem;">
                    VaR_Œ± = Œº - z_Œ± √ó œÉ
                </div>
                <p style="text-align: center; color: var(--text-muted);">
                    z_95% = 1.645, z_99% = 2.326
                </p>
            </div>

            <div class="formula-box">
                <h3>Historical VaR</h3>
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem;">
                    VaR_Œ± = Percentile(Returns, Œ±)
                </div>
                <p style="text-align: center; color: var(--text-muted);">
                    95% VaR = 5th percentile of historical returns
                </p>
            </div>

            <div class="important-note">
                <h3>‚ö†Ô∏è VaR Limitations</h3>
                <p><strong>VaR tells you nothing about losses beyond the threshold!</strong> If 95% VaR is $1M, your worst day could be $1.1M or $10M‚ÄîVaR doesn't distinguish. This is why we need CVaR.</p>
            </div>

            <div class="key-concept">
                <h3>Conditional VaR (CVaR / Expected Shortfall)</h3>
                <p>CVaR answers: "When losses exceed VaR, what's the average loss?"</p>
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem; margin-top: 1rem;">
                    CVaR_Œ± = E[Loss | Loss > VaR_Œ±]
                </div>
                <p style="margin-top: 1rem;"><strong>Example:</strong> 95% CVaR of $1.5M means that in the worst 5% of cases, the average loss is $1.5M.</p>
            </div>

            <div class="chart-container">
                <h4 style="margin-bottom: 1rem;">VaR vs CVaR Visualization</h4>
                <canvas id="varChart" height="300"></canvas>
            </div>
        </section>

        <!-- Part 4: Risk-Adjusted Returns -->
        <section class="content-section fade-in">
            <h2>Part 4: Risk-Adjusted Performance Metrics</h2>

            <div class="risk-metric-grid">
                <div class="risk-metric-card">
                    <h4>üìà Sharpe Ratio</h4>
                    <p>Return per unit of total risk. The gold standard for risk-adjusted performance.</p>
                    <div class="formula">Sharpe = (R_p - R_f) / œÉ_p</div>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">
                        R_p = portfolio return, R_f = risk-free rate, œÉ_p = volatility
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                        <span style="color: var(--success);">Good: > 1.0</span> |
                        <span style="color: var(--accent-blue);">Great: > 2.0</span> |
                        <span style="color: var(--accent-purple);">Elite: > 3.0</span>
                    </p>
                </div>

                <div class="risk-metric-card">
                    <h4>üìâ Sortino Ratio</h4>
                    <p>Return per unit of downside risk. Doesn't penalize upside volatility.</p>
                    <div class="formula">Sortino = (R_p - R_f) / œÉ_downside</div>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">
                        œÉ_downside = std dev of negative returns only
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                        Better than Sharpe when returns are asymmetric
                    </p>
                </div>

                <div class="risk-metric-card">
                    <h4>üèîÔ∏è Calmar Ratio</h4>
                    <p>Return relative to maximum drawdown. Focuses on worst-case scenario.</p>
                    <div class="formula">Calmar = Annual Return / Max Drawdown</div>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">
                        Higher = better recovery from worst period
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                        <span style="color: var(--success);">Good: > 1.0</span> |
                        <span style="color: var(--accent-blue);">Great: > 2.0</span>
                    </p>
                </div>

                <div class="risk-metric-card">
                    <h4>üìä Information Ratio</h4>
                    <p>Active return per unit of tracking error vs benchmark.</p>
                    <div class="formula">IR = (R_p - R_b) / TE</div>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">
                        TE = tracking error = std dev of (R_p - R_b)
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                        Measures skill of active management
                    </p>
                </div>
            </div>

            <div class="info-box info-box-info">
                <div class="info-box-title">üéØ Choosing the Right Metric</div>
                <table class="comparison-table">
                    <thead>
                        <tr><th>Situation</th><th>Best Metric</th><th>Why</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>General comparison</td><td>Sharpe Ratio</td><td>Industry standard, comparable across strategies</td></tr>
                        <tr><td>Asymmetric returns (options)</td><td>Sortino Ratio</td><td>Doesn't penalize upside volatility</td></tr>
                        <tr><td>Drawdown-sensitive investors</td><td>Calmar Ratio</td><td>Focuses on maximum pain point</td></tr>
                        <tr><td>Active vs benchmark</td><td>Information Ratio</td><td>Measures value added over passive</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Part 5: Maximum Drawdown -->
        <section class="content-section fade-in">
            <h2>Part 5: Maximum Drawdown Analysis</h2>

            <div class="key-concept">
                <h3>What is Drawdown?</h3>
                <p>Drawdown measures the decline from a peak to a trough before a new peak is achieved. It answers: "How much did I lose from my best point?"</p>
            </div>

            <div class="formula-box">
                <h3>Drawdown Calculation</h3>
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem;">
                    DD_t = (Peak_t - Value_t) / Peak_t
                </div>
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem; margin-top: 0.5rem;">
                    Max Drawdown = max(DD_t) for all t
                </div>
            </div>

            <div class="chart-container">
                <h4 style="margin-bottom: 1rem;">Equity Curve & Drawdown Visualization</h4>
                <canvas id="drawdownChart" height="300"></canvas>
            </div>

            <div class="important-note">
                <h3>‚ö†Ô∏è Drawdown Psychology</h3>
                <p>A 50% drawdown requires a 100% gain to recover. A 75% drawdown requires 300% gain. Drawdowns are psychologically devastating and often lead to strategy abandonment at the worst time.</p>
                <table class="comparison-table" style="margin-top: 1rem;">
                    <thead><tr><th>Drawdown</th><th>Recovery Needed</th><th>Time to Recover (at 10%/yr)</th></tr></thead>
                    <tbody>
                        <tr><td>10%</td><td>11.1%</td><td>~1 year</td></tr>
                        <tr><td>25%</td><td>33.3%</td><td>~3 years</td></tr>
                        <tr><td>50%</td><td>100%</td><td>~7 years</td></tr>
                        <tr><td>75%</td><td>300%</td><td>~15 years</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Part 6: Beta & Factor Exposure -->
        <section class="content-section fade-in">
            <h2>Part 6: Beta & Systematic Risk</h2>

            <div class="key-concept">
                <h3>Beta (Œ≤)</h3>
                <p>Beta measures sensitivity to market movements. It answers: "When the market moves 1%, how much does my portfolio move?"</p>
            </div>

            <div class="formula-box">
                <h3>Beta Calculation</h3>
                <div class="formula" style="text-align: center; font-size: 1.3rem; padding: 1rem;">
                    Œ≤ = Cov(R_p, R_m) / Var(R_m)
                </div>
                <p style="text-align: center; color: var(--text-muted);">
                    Alternatively: Œ≤ = œÅ √ó (œÉ_p / œÉ_m)
                </p>
            </div>

            <div class="risk-metric-grid">
                <div class="risk-metric-card">
                    <h4>Œ≤ = 1.0</h4>
                    <p>Moves exactly with market. S&P 500 index fund by definition.</p>
                </div>
                <div class="risk-metric-card">
                    <h4>Œ≤ > 1.0</h4>
                    <p>Aggressive. Tech stocks often Œ≤ = 1.2-1.5. Amplifies market moves.</p>
                </div>
                <div class="risk-metric-card">
                    <h4>Œ≤ < 1.0</h4>
                    <p>Defensive. Utilities often Œ≤ = 0.5-0.7. Dampens market moves.</p>
                </div>
                <div class="risk-metric-card">
                    <h4>Œ≤ < 0</h4>
                    <p>Negative correlation. Gold, some hedge funds. Moves opposite to market.</p>
                </div>
            </div>

            <div class="formula-box">
                <h3>Alpha (Jensen's Alpha)</h3>
                <div class="formula" style="text-align: center; font-size: 1.2rem; padding: 1rem;">
                    Œ± = R_p - [R_f + Œ≤ √ó (R_m - R_f)]
                </div>
                <p style="text-align: center; color: var(--text-muted);">
                    Return not explained by market exposure = skill (or luck)
                </p>
            </div>
        </section>

        <!-- Part 7: Python Implementation -->
        <section class="content-section fade-in">
            <h2>Part 7: Python Implementation</h2>

            <div class="code-block">
                <div class="code-header">
                    <span>risk_metrics.py</span>
                    <button onclick="copyCode(this)" style="background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer;">Copy</button>
                </div>
                <pre><code class="language-python">"""
Complete Risk Management Framework
===================================
Professional risk metrics for quantitative trading.
"""

import numpy as np
import pandas as pd
from scipy import stats

class RiskMetrics:
    """Comprehensive risk analysis toolkit."""

    def __init__(self, returns: np.ndarray, risk_free_rate: float = 0.02):
        """
        Initialize with return series.

        Parameters
        ----------
        returns : np.ndarray
            Array of periodic returns (daily, monthly, etc.)
        risk_free_rate : float
            Annual risk-free rate (default 2%)
        """
        self.returns = np.array(returns)
        self.rf = risk_free_rate

    # ============ Volatility Metrics ============
    def volatility(self, annualize: bool = True, periods: int = 252) -> float:
        """Calculate volatility (standard deviation)."""
        vol = np.std(self.returns, ddof=1)
        return vol * np.sqrt(periods) if annualize else vol

    def downside_deviation(self, threshold: float = 0, annualize: bool = True) -> float:
        """Calculate downside deviation (semi-deviation below threshold)."""
        downside = self.returns[self.returns < threshold]
        if len(downside) == 0:
            return 0.0
        dd = np.std(downside, ddof=1)
        return dd * np.sqrt(252) if annualize else dd

    # ============ VaR & CVaR ============
    def var_historical(self, confidence: float = 0.95) -> float:
        """Historical Value at Risk."""
        return -np.percentile(self.returns, (1 - confidence) * 100)

    def var_parametric(self, confidence: float = 0.95) -> float:
        """Parametric VaR assuming normal distribution."""
        z = stats.norm.ppf(1 - confidence)
        return -(np.mean(self.returns) + z * np.std(self.returns))

    def cvar(self, confidence: float = 0.95) -> float:
        """Conditional VaR (Expected Shortfall)."""
        var = self.var_historical(confidence)
        return -np.mean(self.returns[self.returns <= -var])

    # ============ Risk-Adjusted Returns ============
    def sharpe_ratio(self, periods: int = 252) -> float:
        """Sharpe Ratio: excess return per unit of total risk."""
        excess_return = np.mean(self.returns) * periods - self.rf
        vol = self.volatility(annualize=True, periods=periods)
        return excess_return / vol if vol > 0 else 0.0

    def sortino_ratio(self, periods: int = 252) -> float:
        """Sortino Ratio: excess return per unit of downside risk."""
        excess_return = np.mean(self.returns) * periods - self.rf
        downside_vol = self.downside_deviation(threshold=0, annualize=True)
        return excess_return / downside_vol if downside_vol > 0 else 0.0

    def calmar_ratio(self, periods: int = 252) -> float:
        """Calmar Ratio: annual return / max drawdown."""
        annual_return = np.mean(self.returns) * periods
        max_dd = self.max_drawdown()
        return annual_return / max_dd if max_dd > 0 else 0.0

    # ============ Drawdown Analysis ============
    def drawdown_series(self) -> np.ndarray:
        """Calculate drawdown at each point in time."""
        cumulative = np.cumprod(1 + self.returns)
        running_max = np.maximum.accumulate(cumulative)
        drawdown = (running_max - cumulative) / running_max
        return drawdown

    def max_drawdown(self) -> float:
        """Maximum drawdown."""
        return np.max(self.drawdown_series())

    def avg_drawdown(self) -> float:
        """Average drawdown."""
        return np.mean(self.drawdown_series())

    # ============ Beta & Alpha ============
    def beta(self, market_returns: np.ndarray) -> float:
        """Calculate beta vs market."""
        covariance = np.cov(self.returns, market_returns)[0, 1]
        market_variance = np.var(market_returns, ddof=1)
        return covariance / market_variance if market_variance > 0 else 0.0

    def alpha(self, market_returns: np.ndarray, periods: int = 252) -> float:
        """Jensen's Alpha: return not explained by market."""
        beta = self.beta(market_returns)
        portfolio_return = np.mean(self.returns) * periods
        market_return = np.mean(market_returns) * periods
        return portfolio_return - (self.rf + beta * (market_return - self.rf))

    # ============ Summary Report ============
    def summary(self, market_returns: np.ndarray = None) -> dict:
        """Generate comprehensive risk report."""
        report = {
            'Annual Return': f"{np.mean(self.returns) * 252:.2%}",
            'Volatility': f"{self.volatility():.2%}",
            'Sharpe Ratio': f"{self.sharpe_ratio():.2f}",
            'Sortino Ratio': f"{self.sortino_ratio():.2f}",
            'Max Drawdown': f"{self.max_drawdown():.2%}",
            'Calmar Ratio': f"{self.calmar_ratio():.2f}",
            'VaR (95%)': f"{self.var_historical(0.95):.2%}",
            'CVaR (95%)': f"{self.cvar(0.95):.2%}",
        }

        if market_returns is not None:
            report['Beta'] = f"{self.beta(market_returns):.2f}"
            report['Alpha'] = f"{self.alpha(market_returns):.2%}"

        return report


# Example usage
if __name__ == "__main__":
    # Generate sample returns
    np.random.seed(42)
    daily_returns = np.random.normal(0.0005, 0.015, 252)  # ~12.5% annual, 24% vol
    market_returns = np.random.normal(0.0004, 0.012, 252)  # ~10% annual, 19% vol

    # Calculate all metrics
    rm = RiskMetrics(daily_returns, risk_free_rate=0.02)

    print("=" * 50)
    print("RISK METRICS SUMMARY")
    print("=" * 50)

    for metric, value in rm.summary(market_returns).items():
        print(f"{metric:20s}: {value}")
</code></pre>
            </div>
        </section>

        <!-- Part 8: Interactive Calculator -->
        <section class="content-section fade-in">
            <h2>Part 8: Interactive Risk Dashboard</h2>

            <div class="calculator-container">
                <h3>üéõÔ∏è Risk Metrics Calculator</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Enter your portfolio statistics to calculate comprehensive risk metrics.
                </p>

                <div class="input-row">
                    <div class="input-group">
                        <label for="annualReturn">Annual Return (%)</label>
                        <input type="number" id="annualReturn" value="15" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="annualVol">Annual Volatility (%)</label>
                        <input type="number" id="annualVol" value="20" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="riskFree">Risk-Free Rate (%)</label>
                        <input type="number" id="riskFree" value="5" step="0.1">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="maxDD">Max Drawdown (%)</label>
                        <input type="number" id="maxDD" value="25" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="downsideVol">Downside Volatility (%)</label>
                        <input type="number" id="downsideVol" value="14" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="portfolioBeta">Portfolio Beta</label>
                        <input type="number" id="portfolioBeta" value="1.1" step="0.01">
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateRiskMetrics()">Calculate Risk Metrics</button>

                <div class="results-container" id="resultsContainer" style="display: none;">
                    <h4 style="margin-bottom: 1rem; color: var(--accent-cyan);">Risk Dashboard</h4>
                    <div class="risk-dashboard">
                        <div class="dashboard-metric sharpe">
                            <div class="result-label">Sharpe Ratio</div>
                            <div class="metric-value" id="sharpeResult">-</div>
                        </div>
                        <div class="dashboard-metric sortino">
                            <div class="result-label">Sortino Ratio</div>
                            <div class="metric-value" id="sortinoResult">-</div>
                        </div>
                        <div class="dashboard-metric drawdown">
                            <div class="result-label">Calmar Ratio</div>
                            <div class="metric-value" id="calmarResult">-</div>
                        </div>
                        <div class="dashboard-metric var">
                            <div class="result-label">VaR (95%)</div>
                            <div class="metric-value" id="varResult">-</div>
                        </div>
                    </div>
                    <div class="result-grid" style="margin-top: 1rem;">
                        <div class="result-item">
                            <span class="result-label">Jensen's Alpha</span>
                            <span class="result-value" id="alphaResult">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Recovery from Max DD</span>
                            <span class="result-value" id="recoveryResult">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Risk Rating</span>
                            <span class="result-value" id="ratingResult">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Part 9: Key Takeaways -->
        <section class="content-section fade-in">
            <h2>Part 9: Key Takeaways</h2>

            <div class="card" style="padding: 2rem;">
                <div style="display: grid; gap: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</span>
                        <div>
                            <strong style="color: var(--text-primary);">Sharpe Ratio is the industry standard</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Use it for general strategy comparison. Above 1.0 is good, above 2.0 is excellent.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</span>
                        <div>
                            <strong style="color: var(--text-primary);">VaR has critical limitations</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Always use CVaR alongside VaR. VaR tells you nothing about tail losses beyond the threshold.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</span>
                        <div>
                            <strong style="color: var(--text-primary);">Drawdowns destroy compounding</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">A 50% loss needs 100% gain to recover. Manage drawdowns aggressively.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</span>
                        <div>
                            <strong style="color: var(--text-primary);">Match metric to context</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Sortino for asymmetric returns, Calmar for drawdown-sensitive investors, Information Ratio vs benchmarks.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <span style="background: var(--accent-blue); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">5</span>
                        <div>
                            <strong style="color: var(--text-primary);">Beta separates systematic from idiosyncratic risk</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Know your market exposure. Alpha is return above what beta explains‚Äîtrue skill (or luck).</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Part 10: Quiz -->
        <section class="content-section fade-in">
            <h2>Part 10: Knowledge Check</h2>

            <div class="quiz-container">
                <div class="quiz-question" id="q1">
                    <h4>1. A portfolio has 15% annual return and 20% volatility. Risk-free rate is 5%. What is the Sharpe ratio?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(1, 'a')">a) 0.75</button>
                        <button onclick="checkAnswer(1, 'b')">b) 0.50</button>
                        <button onclick="checkAnswer(1, 'c')">c) 1.00</button>
                        <button onclick="checkAnswer(1, 'd')">d) 0.25</button>
                    </div>
                    <div class="quiz-feedback" id="feedback1"></div>
                </div>

                <div class="quiz-question" id="q2">
                    <h4>2. What does 95% VaR of $1M mean?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(2, 'a')">a) You will lose exactly $1M 95% of the time</button>
                        <button onclick="checkAnswer(2, 'b')">b) There's a 5% chance of losing more than $1M</button>
                        <button onclick="checkAnswer(2, 'c')">c) Your maximum possible loss is $1M</button>
                        <button onclick="checkAnswer(2, 'd')">d) You will gain $1M 95% of the time</button>
                    </div>
                    <div class="quiz-feedback" id="feedback2"></div>
                </div>

                <div class="quiz-question" id="q3">
                    <h4>3. Why is CVaR (Expected Shortfall) preferred over VaR by risk managers?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(3, 'a')">a) It's easier to calculate</button>
                        <button onclick="checkAnswer(3, 'b')">b) It captures the magnitude of tail losses beyond VaR</button>
                        <button onclick="checkAnswer(3, 'c')">c) It's always smaller than VaR</button>
                        <button onclick="checkAnswer(3, 'd')">d) It assumes normal distribution</button>
                    </div>
                    <div class="quiz-feedback" id="feedback3"></div>
                </div>

                <div class="quiz-question" id="q4">
                    <h4>4. A stock has beta of 1.5. If the market falls 10%, what's the expected stock decline?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(4, 'a')">a) 10%</button>
                        <button onclick="checkAnswer(4, 'b')">b) 15%</button>
                        <button onclick="checkAnswer(4, 'c')">c) 6.67%</button>
                        <button onclick="checkAnswer(4, 'd')">d) 5%</button>
                    </div>
                    <div class="quiz-feedback" id="feedback4"></div>
                </div>

                <div class="quiz-question" id="q5">
                    <h4>5. After a 40% drawdown, what gain is needed to return to the previous peak?</h4>
                    <div class="quiz-options">
                        <button onclick="checkAnswer(5, 'a')">a) 40%</button>
                        <button onclick="checkAnswer(5, 'b')">b) 50%</button>
                        <button onclick="checkAnswer(5, 'c')">c) 66.7%</button>
                        <button onclick="checkAnswer(5, 'd')">d) 80%</button>
                    </div>
                    <div class="quiz-feedback" id="feedback5"></div>
                </div>

                <div class="score-container" id="scoreContainer">
                    <h3>Quiz Complete! Score: <span id="finalScore">0</span>/5</h3>
                </div>
            </div>
        </section>

    </main>

    <script>
        // Quiz functionality
        const correctAnswers = { 1: 'b', 2: 'b', 3: 'b', 4: 'b', 5: 'c' };
        const explanations = {
            1: {
                'a': 'Close! Sharpe = (15% - 5%) / 20% = 0.50',
                'b': 'Correct! Sharpe = (R_p - R_f) / œÉ = (15% - 5%) / 20% = 0.50',
                'c': 'Incorrect. That would require 20% excess return.',
                'd': 'Incorrect. Check the formula: (Return - Risk-free) / Volatility'
            },
            2: {
                'a': 'Incorrect. VaR is a threshold, not an exact loss amount.',
                'b': 'Correct! 95% VaR means 5% probability of exceeding that loss.',
                'c': 'Incorrect. Losses can exceed VaR‚Äîthat\'s why we need CVaR.',
                'd': 'Incorrect. VaR measures downside risk, not gains.'
            },
            3: {
                'a': 'Incorrect. CVaR is actually more complex to calculate.',
                'b': 'Correct! CVaR tells you the average loss when VaR is breached.',
                'c': 'Incorrect. CVaR is always larger (worse) than VaR.',
                'd': 'Incorrect. CVaR works with any distribution.'
            },
            4: {
                'a': 'Incorrect. That would be beta = 1.0.',
                'b': 'Correct! Expected move = Beta √ó Market move = 1.5 √ó 10% = 15%',
                'c': 'Incorrect. You divided instead of multiplied.',
                'd': 'Incorrect. Review the beta calculation.'
            },
            5: {
                'a': 'Incorrect. The math is not symmetric for losses.',
                'b': 'Incorrect. That would only recover a 33% loss.',
                'c': 'Correct! If you have $60 left after 40% loss, need $40 gain = 40/60 = 66.7%',
                'd': 'Incorrect. That would recover a 44% loss.'
            }
        };

        let quizAnswers = {};

        function checkAnswer(questionNum, answer) {
            const feedback = document.getElementById(`feedback${questionNum}`);
            const isCorrect = answer === correctAnswers[questionNum];

            quizAnswers[questionNum] = answer;

            feedback.innerHTML = `<div class="${isCorrect ? 'correct' : 'incorrect'}">
                ${isCorrect ? '‚úì Correct!' : '‚úó Incorrect.'} ${explanations[questionNum][answer]}
            </div>`;
            feedback.style.display = 'block';

            const buttons = document.querySelectorAll(`#q${questionNum} button`);
            buttons.forEach(btn => btn.disabled = true);

            if (Object.keys(quizAnswers).length === 5) {
                showFinalScore();
            }
        }

        function showFinalScore() {
            const score = Object.keys(quizAnswers).reduce((sum, q) =>
                sum + (quizAnswers[q] === correctAnswers[q] ? 1 : 0), 0);
            document.getElementById('finalScore').textContent = score;
            document.getElementById('scoreContainer').style.display = 'block';
        }

        // Calculator functionality
        function calculateRiskMetrics() {
            const annualReturn = parseFloat(document.getElementById('annualReturn').value) / 100;
            const annualVol = parseFloat(document.getElementById('annualVol').value) / 100;
            const riskFree = parseFloat(document.getElementById('riskFree').value) / 100;
            const maxDD = parseFloat(document.getElementById('maxDD').value) / 100;
            const downsideVol = parseFloat(document.getElementById('downsideVol').value) / 100;
            const beta = parseFloat(document.getElementById('portfolioBeta').value);

            // Calculate metrics
            const sharpe = (annualReturn - riskFree) / annualVol;
            const sortino = (annualReturn - riskFree) / downsideVol;
            const calmar = annualReturn / maxDD;
            const var95 = annualVol * 1.645 / Math.sqrt(252) * 100; // Daily VaR
            const marketReturn = 0.10; // Assume 10% market return
            const alpha = annualReturn - (riskFree + beta * (marketReturn - riskFree));
            const recoveryNeeded = (1 / (1 - maxDD) - 1) * 100;

            // Risk rating
            let rating = 'Moderate';
            if (sharpe > 1.5 && maxDD < 0.15) rating = 'Low Risk';
            else if (sharpe < 0.5 || maxDD > 0.35) rating = 'High Risk';

            // Display results
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('sharpeResult').textContent = sharpe.toFixed(2);
            document.getElementById('sharpeResult').className = `metric-value ${sharpe > 1 ? 'positive' : sharpe > 0.5 ? 'neutral' : 'negative'}`;

            document.getElementById('sortinoResult').textContent = sortino.toFixed(2);
            document.getElementById('sortinoResult').className = `metric-value ${sortino > 1.5 ? 'positive' : sortino > 0.7 ? 'neutral' : 'negative'}`;

            document.getElementById('calmarResult').textContent = calmar.toFixed(2);
            document.getElementById('calmarResult').className = `metric-value ${calmar > 1 ? 'positive' : calmar > 0.5 ? 'neutral' : 'negative'}`;

            document.getElementById('varResult').textContent = var95.toFixed(2) + '%';
            document.getElementById('alphaResult').textContent = (alpha * 100).toFixed(2) + '%';
            document.getElementById('alphaResult').style.color = alpha > 0 ? 'var(--success)' : 'var(--error)';
            document.getElementById('recoveryResult').textContent = recoveryNeeded.toFixed(1) + '%';
            document.getElementById('ratingResult').textContent = rating;
            document.getElementById('ratingResult').style.color = rating === 'Low Risk' ? 'var(--success)' : rating === 'High Risk' ? 'var(--error)' : 'var(--warning)';
        }

        // Charts
        function initCharts() {
            // VaR Chart
            const varCtx = document.getElementById('varChart').getContext('2d');

            // Generate normal distribution data
            const xValues = [];
            const yValues = [];
            for (let x = -4; x <= 4; x += 0.1) {
                xValues.push(x);
                yValues.push(Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI));
            }

            new Chart(varCtx, {
                type: 'line',
                data: {
                    labels: xValues.map(x => x.toFixed(1)),
                    datasets: [{
                        label: 'Return Distribution',
                        data: yValues,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                varLine: {
                                    type: 'line',
                                    xMin: -1.645,
                                    xMax: -1.645,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    label: {
                                        content: 'VaR (95%)',
                                        enabled: true
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: -4, max: 4,
                            title: { display: true, text: 'Returns (œÉ)', color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#64748b', maxTicksLimit: 9 }
                        },
                        y: {
                            min: 0, max: 0.5,
                            title: { display: true, text: 'Probability', color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#64748b' }
                        }
                    }
                }
            });

            // Drawdown Chart
            const ddCtx = document.getElementById('drawdownChart').getContext('2d');

            // Generate sample equity curve and drawdown
            let equity = [100];
            const returns = [];
            for (let i = 0; i < 252; i++) {
                const ret = (Math.random() - 0.48) * 0.03;
                returns.push(ret);
                equity.push(equity[equity.length - 1] * (1 + ret));
            }

            const runningMax = [];
            let maxVal = 0;
            equity.forEach(v => {
                maxVal = Math.max(maxVal, v);
                runningMax.push(maxVal);
            });

            const drawdown = equity.map((v, i) => ((runningMax[i] - v) / runningMax[i]) * -100);

            new Chart(ddCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: equity.length}, (_, i) => i),
                    datasets: [
                        {
                            label: 'Equity Curve',
                            data: equity,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Drawdown %',
                            data: drawdown,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.3)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Trading Days', color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#64748b', maxTicksLimit: 10 }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Equity ($)', color: '#22c55e' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#22c55e' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Drawdown (%)', color: '#ef4444' },
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#ef4444' },
                            max: 0,
                            min: -30
                        }
                    }
                }
            });
        }

        function copyCode(btn) {
            const code = btn.closest('.code-block').querySelector('code').textContent;
            navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            calculateRiskMetrics();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
