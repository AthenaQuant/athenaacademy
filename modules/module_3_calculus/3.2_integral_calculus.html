<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Master integral calculus for quantitative trading. Learn area under curves, cumulative returns, probability distributions, and numerical integration methods.">
  <title>3.2 Integral Calculus | Quantitative Trading Mastery</title>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="../../assets/css/shared-styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚à´</text></svg>">

  <style>
    .integral-display {
      font-family: 'Times New Roman', serif;
      font-size: 1.8rem;
      color: #10b981;
      text-align: center;
      padding: 25px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 12px;
      margin: 20px 0;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .method-comparison {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 25px 0;
    }
    .method-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .method-card h4 {
      color: #818cf8;
      margin-bottom: 10px;
    }
    .method-card .accuracy {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-top: 10px;
    }
    .method-card .accuracy.high {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }
    .method-card .accuracy.medium {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }
    .riemann-visual {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    .riemann-box {
      text-align: center;
      padding: 15px;
    }
    .riemann-box svg {
      width: 150px;
      height: 100px;
    }
    .area-result {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 20px 0;
    }
    .area-result .result-box {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    .area-result .result-box .value {
      font-size: 2rem;
      font-weight: bold;
      color: #10b981;
    }
    .area-result .result-box .label {
      color: #94a3b8;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- Navigation Header -->
  <nav class="module-nav-header">
    <div class="container">
      <div class="nav-content">
        <a href="../../index.html" class="nav-home">‚Üê Back to Course</a>
        <div class="nav-module-info">
          <span class="nav-module-number">Module 3.2</span>
          <span class="nav-module-title">Integral Calculus</span>
        </div>
        <a href="3.3_multivariate_calculus.html" class="nav-next">Next Module ‚Üí</a>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <header class="module-hero">
    <div class="container">
      <div class="module-hero-content">
        <div class="module-breadcrumb">
          <span>Module 3: Calculus</span>
          <span class="breadcrumb-separator">‚Ä∫</span>
          <span>3.2 Integral Calculus</span>
        </div>
        <h1>Integral Calculus</h1>
        <p class="module-subtitle">
          Learn to calculate areas, accumulations, and probabilities. Essential for
          cumulative returns, VaR calculations, and option pricing.
        </p>
        <div class="module-meta">
          <span class="meta-item">‚è±Ô∏è 25 min read</span>
          <span class="meta-item">üìä 4 Visualizations</span>
          <span class="meta-item">üíª Interactive Calculator</span>
          <span class="meta-item">‚úÖ 5 Quiz Questions</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container content-wrapper">

    <!-- PART 1: WHY SHOULD I CARE? -->
    <section class="content-section fade-in">
      <h2>Part 1: Why Should I Care?</h2>

      <div class="info-box info-box-warning">
        <div class="info-box-title">The Probability Problem</div>
        <p>
          What's the probability that your portfolio loses more than 5% tomorrow?
          This is P(R < -5%) = ‚à´<sub>-‚àû</sub><sup>-0.05</sup> f(r) dr
        </p>
        <p style="margin-top: 1rem; margin-bottom: 0;">
          The integral of the probability density function (PDF) gives you the probability.
          <strong>Without integrals, you cannot calculate VaR, expected values, or option prices.</strong>
        </p>
      </div>

      <h3>Where Integrals Appear in Trading</h3>

      <div class="grid grid-3">
        <div class="card">
          <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">üìä Cumulative Returns</h4>
          <p style="margin: 0; font-size: 0.95rem;">
            Total P&L = ‚à´ daily_returns dt. Wealth accumulates as the integral of returns over time.
          </p>
        </div>
        <div class="card">
          <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">üìà Probability Calculations</h4>
          <p style="margin: 0; font-size: 0.95rem;">
            CDF = ‚à´ PDF. Value at Risk requires integrating the return distribution up to the loss threshold.
          </p>
        </div>
        <div class="card">
          <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">‚öñÔ∏è Expected Values</h4>
          <p style="margin: 0; font-size: 0.95rem;">
            E[X] = ‚à´ x¬∑f(x) dx. Option prices are expected payoffs under risk-neutral measure.
          </p>
        </div>
      </div>
    </section>

    <!-- PART 2: BUILDING INTUITION -->
    <section class="content-section fade-in">
      <h2>Part 2: Building Intuition</h2>

      <div class="info-box info-box-info">
        <div class="info-box-title">Area Under the Curve</div>
        <p>
          An integral calculates the area between a function and the x-axis. For positive functions,
          this is literally the area. For mixed functions, areas below the axis are negative.
        </p>
      </div>

      <svg viewBox="0 0 700 300" class="svg-diagram">
        <!-- Axes -->
        <line x1="80" y1="220" x2="620" y2="220" stroke="#94a3b8" stroke-width="2"/>
        <line x1="80" y1="220" x2="80" y2="50" stroke="#94a3b8" stroke-width="2"/>

        <!-- Axis labels -->
        <text x="350" y="260" text-anchor="middle" fill="#94a3b8" font-size="14">x</text>
        <text x="40" y="135" text-anchor="middle" fill="#94a3b8" font-size="14" transform="rotate(-90, 40, 135)">f(x)</text>

        <!-- Function curve -->
        <path d="M 100 180 Q 200 80 300 100 T 500 60 T 580 120"
              fill="none" stroke="#6366f1" stroke-width="3" id="funcCurve"/>

        <!-- Shaded area (integral) -->
        <path d="M 180 220 L 180 140 Q 250 85 320 95 Q 390 105 420 80 L 420 220 Z"
              fill="rgba(16, 185, 129, 0.3)" stroke="none"/>

        <!-- Bounds -->
        <line x1="180" y1="220" x2="180" y2="140" stroke="#10b981" stroke-width="2" stroke-dasharray="5,5"/>
        <line x1="420" y1="220" x2="420" y2="80" stroke="#10b981" stroke-width="2" stroke-dasharray="5,5"/>

        <!-- Labels -->
        <text x="180" y="240" text-anchor="middle" fill="#10b981" font-size="12">a</text>
        <text x="420" y="240" text-anchor="middle" fill="#10b981" font-size="12">b</text>

        <!-- Integral notation -->
        <text x="520" y="100" fill="#e2e8f0" font-size="18">‚à´</text>
        <text x="525" y="85" fill="#94a3b8" font-size="10">b</text>
        <text x="525" y="115" fill="#94a3b8" font-size="10">a</text>
        <text x="540" y="100" fill="#e2e8f0" font-size="14">f(x) dx = Area</text>

        <!-- Area label -->
        <text x="300" y="170" text-anchor="middle" fill="#10b981" font-size="14" font-weight="bold">Area</text>
      </svg>

      <div class="riemann-visual">
        <div class="riemann-box">
          <h4 style="color: #f59e0b;">Left Riemann Sum</h4>
          <svg viewBox="0 0 150 100">
            <path d="M 10 80 Q 50 20 90 40 Q 130 60 140 30" fill="none" stroke="#6366f1" stroke-width="2"/>
            <rect x="10" y="35" width="30" height="45" fill="rgba(245, 158, 11, 0.3)" stroke="#f59e0b"/>
            <rect x="40" y="25" width="30" height="55" fill="rgba(245, 158, 11, 0.3)" stroke="#f59e0b"/>
            <rect x="70" y="40" width="30" height="40" fill="rgba(245, 158, 11, 0.3)" stroke="#f59e0b"/>
            <rect x="100" y="50" width="30" height="30" fill="rgba(245, 158, 11, 0.3)" stroke="#f59e0b"/>
          </svg>
          <p style="font-size: 0.8rem; color: #94a3b8;">Uses left endpoints</p>
        </div>
        <div class="riemann-box">
          <h4 style="color: #10b981;">Trapezoidal Rule</h4>
          <svg viewBox="0 0 150 100">
            <path d="M 10 80 Q 50 20 90 40 Q 130 60 140 30" fill="none" stroke="#6366f1" stroke-width="2"/>
            <polygon points="10,80 10,35 40,25 40,80" fill="rgba(16, 185, 129, 0.3)" stroke="#10b981"/>
            <polygon points="40,80 40,25 70,40 70,80" fill="rgba(16, 185, 129, 0.3)" stroke="#10b981"/>
            <polygon points="70,80 70,40 100,50 100,80" fill="rgba(16, 185, 129, 0.3)" stroke="#10b981"/>
            <polygon points="100,80 100,50 130,35 130,80" fill="rgba(16, 185, 129, 0.3)" stroke="#10b981"/>
          </svg>
          <p style="font-size: 0.8rem; color: #94a3b8;">Linear interpolation</p>
        </div>
        <div class="riemann-box">
          <h4 style="color: #8b5cf6;">Simpson's Rule</h4>
          <svg viewBox="0 0 150 100">
            <path d="M 10 80 Q 50 20 90 40 Q 130 60 140 30" fill="none" stroke="#6366f1" stroke-width="2"/>
            <path d="M 10 80 L 10 35 Q 40 15 70 40 Q 100 55 130 35 L 130 80 Z" fill="rgba(139, 92, 246, 0.3)" stroke="#8b5cf6"/>
          </svg>
          <p style="font-size: 0.8rem; color: #94a3b8;">Quadratic interpolation</p>
        </div>
      </div>
    </section>

    <!-- PART 3: THE MATHEMATICS -->
    <section class="content-section fade-in">
      <h2>Part 3: The Mathematics</h2>

      <div class="formula-box">
        <h3>Fundamental Theorem of Calculus</h3>
        <div class="formula">
          ‚à´<sub>a</sub><sup>b</sup> f(x) dx = F(b) - F(a)
        </div>
        <p>Where F'(x) = f(x). The integral equals the antiderivative evaluated at the bounds.</p>
      </div>

      <div class="formula-box">
        <h3>Indefinite Integral (Antiderivative)</h3>
        <div class="formula">
          ‚à´ f(x) dx = F(x) + C
        </div>
        <p>F(x) is any function whose derivative is f(x). C is the constant of integration.</p>
      </div>

      <h3>Common Integrals for Finance</h3>

      <table class="sensitivity-table">
        <thead>
          <tr>
            <th>Function f(x)</th>
            <th>Integral ‚à´f(x)dx</th>
            <th>Application</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>x‚Åø</td>
            <td>x‚Åø‚Å∫¬π/(n+1) + C</td>
            <td>Polynomial growth</td>
          </tr>
          <tr>
            <td>eÀ£</td>
            <td>eÀ£ + C</td>
            <td>Continuous compounding</td>
          </tr>
          <tr>
            <td>1/x</td>
            <td>ln|x| + C</td>
            <td>Log returns</td>
          </tr>
          <tr>
            <td>e^(-x¬≤/2)</td>
            <td>‚àö(2œÄ)¬∑Œ¶(x)</td>
            <td>Normal CDF</td>
          </tr>
        </tbody>
      </table>

      <h3>Numerical Integration Methods</h3>

      <div class="method-comparison">
        <div class="method-card">
          <h4>Trapezoidal Rule</h4>
          <div class="formula" style="font-size: 0.9rem;">‚à´ ‚âà h/2 ¬∑ [f(a) + 2Œ£f(x·µ¢) + f(b)]</div>
          <p style="font-size: 0.85rem; color: #94a3b8;">Error: O(h¬≤)</p>
          <span class="accuracy medium">Medium Accuracy</span>
        </div>
        <div class="method-card">
          <h4>Simpson's Rule</h4>
          <div class="formula" style="font-size: 0.9rem;">‚à´ ‚âà h/3 ¬∑ [f‚ÇÄ + 4f‚ÇÅ + 2f‚ÇÇ + ... + f‚Çô]</div>
          <p style="font-size: 0.85rem; color: #94a3b8;">Error: O(h‚Å¥)</p>
          <span class="accuracy high">High Accuracy</span>
        </div>
        <div class="method-card">
          <h4>Gaussian Quadrature</h4>
          <div class="formula" style="font-size: 0.9rem;">‚à´ ‚âà Œ£ w·µ¢¬∑f(x·µ¢)</div>
          <p style="font-size: 0.85rem; color: #94a3b8;">Error: O(h¬≤‚Åø)</p>
          <span class="accuracy high">Highest Accuracy</span>
        </div>
      </div>
    </section>

    <!-- PART 4: KEY PROPERTIES -->
    <section class="content-section fade-in">
      <h2>Part 4: Key Properties for Trading</h2>

      <div class="properties-list">
        <div class="property-item">
          <span class="property-name">Linearity</span>
          <span class="property-desc">‚à´[af + bg]dx = a‚à´f dx + b‚à´g dx ‚Äî integrals distribute over addition</span>
        </div>
        <div class="property-item">
          <span class="property-name">Additivity</span>
          <span class="property-desc">‚à´‚Çê·µá + ‚à´·µá·∂ú = ‚à´‚Çê·∂ú ‚Äî split integrals at any point</span>
        </div>
        <div class="property-item">
          <span class="property-name">Reversal</span>
          <span class="property-desc">‚à´‚Çê·µá = -‚à´·µá‚Çê ‚Äî swapping bounds negates the integral</span>
        </div>
        <div class="property-item">
          <span class="property-name">PDF Property</span>
          <span class="property-desc">‚à´‚Çã‚àû^‚àû f(x)dx = 1 for any probability density function</span>
        </div>
      </div>

      <div class="info-box info-box-info">
        <div class="info-box-title">Expected Value as an Integral</div>
        <div class="formula-box">
          <div class="formula">E[X] = ‚à´‚Çã‚àû^‚àû x ¬∑ f(x) dx</div>
        </div>
        <p>For continuous distributions, the expected value is the integral of x weighted by probability density.</p>

        <div class="formula-box">
          <div class="formula">E[g(X)] = ‚à´‚Çã‚àû^‚àû g(x) ¬∑ f(x) dx</div>
        </div>
        <p>Expected value of any function g(X), like option payoffs: E[max(S-K, 0)]</p>
      </div>
    </section>

    <!-- PART 5: PYTHON IMPLEMENTATION -->
    <section class="content-section fade-in">
      <h2>Part 5: Python Implementation</h2>

      <div class="code-block">
        <div class="code-header">
          <span>Numerical Integration Methods</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code class="language-python">import numpy as np
from scipy import integrate
from typing import Callable, Tuple

def trapezoidal_rule(
    f: Callable[[float], float],
    a: float,
    b: float,
    n: int = 100
) -> float:
    """
    Numerical integration using trapezoidal rule.

    Parameters:
    -----------
    f : Callable
        Function to integrate
    a, b : float
        Integration bounds
    n : int
        Number of trapezoids

    Returns:
    --------
    float : Approximate integral value
    """
    x = np.linspace(a, b, n + 1)
    y = np.array([f(xi) for xi in x])

    h = (b - a) / n
    integral = h * (0.5 * y[0] + np.sum(y[1:-1]) + 0.5 * y[-1])

    return integral

def simpsons_rule(
    f: Callable[[float], float],
    a: float,
    b: float,
    n: int = 100
) -> float:
    """
    Numerical integration using Simpson's rule.
    Requires n to be even.
    """
    if n % 2 != 0:
        n += 1

    x = np.linspace(a, b, n + 1)
    y = np.array([f(xi) for xi in x])
    h = (b - a) / n

    # Simpson's 1/3 rule
    integral = h / 3 * (y[0] + y[-1] +
                        4 * np.sum(y[1:-1:2]) +  # Odd indices
                        2 * np.sum(y[2:-1:2]))   # Even indices

    return integral

# Example: Integrate standard normal PDF
def normal_pdf(x: float, mu: float = 0, sigma: float = 1) -> float:
    """Standard normal probability density function."""
    return np.exp(-0.5 * ((x - mu) / sigma)**2) / (sigma * np.sqrt(2 * np.pi))

# Calculate probability P(-1 < X < 1) for standard normal
prob_trap = trapezoidal_rule(normal_pdf, -1, 1, n=100)
prob_simp = simpsons_rule(normal_pdf, -1, 1, n=100)
prob_scipy, error = integrate.quad(normal_pdf, -1, 1)

print("=" * 50)
print("NUMERICAL INTEGRATION COMPARISON")
print("=" * 50)
print(f"\nP(-1 < Z < 1) for standard normal:")
print(f"  Trapezoidal (n=100): {prob_trap:.8f}")
print(f"  Simpson's (n=100):   {prob_simp:.8f}")
print(f"  scipy.quad:          {prob_scipy:.8f}")
print(f"  True value:          0.68268949")
print(f"\nError comparison:")
print(f"  Trapezoidal error: {abs(prob_trap - 0.68268949):.2e}")
print(f"  Simpson's error:   {abs(prob_simp - 0.68268949):.2e}")</code></pre>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span>Cumulative Returns Calculation</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code class="language-python">import numpy as np
import pandas as pd

def calculate_cumulative_returns(daily_returns: np.ndarray) -> dict:
    """
    Calculate cumulative returns from daily returns.

    The cumulative return is the "integral" of daily returns.
    For discrete data: cumsum (log returns) or cumprod (simple returns)

    Parameters:
    -----------
    daily_returns : np.ndarray
        Array of daily simple returns

    Returns:
    --------
    dict : cumulative returns, wealth path
    """
    # Method 1: Direct cumulative product (for simple returns)
    wealth_simple = np.cumprod(1 + daily_returns)

    # Method 2: Via log returns (more accurate for long periods)
    log_returns = np.log(1 + daily_returns)
    cumulative_log = np.cumsum(log_returns)
    wealth_log = np.exp(cumulative_log)

    # Total return
    total_return = wealth_simple[-1] - 1

    # Using trapezoidal integration on continuous approximation
    t = np.arange(len(daily_returns))
    cumulative_integral = np.trapz(daily_returns, t)

    return {
        'wealth_path': wealth_simple,
        'total_return': total_return,
        'cumulative_log_return': cumulative_log[-1],
        'integral_approx': cumulative_integral
    }

# Example: 1 year of daily returns
np.random.seed(42)
n_days = 252
mean_daily = 0.0004  # ~10% annual
std_daily = 0.015    # ~24% annual vol

daily_returns = np.random.normal(mean_daily, std_daily, n_days)

results = calculate_cumulative_returns(daily_returns)

print("\n" + "=" * 50)
print("CUMULATIVE RETURNS ANALYSIS")
print("=" * 50)
print(f"\nDaily returns: {n_days} days")
print(f"Mean daily return: {np.mean(daily_returns)*100:.4f}%")
print(f"Daily volatility: {np.std(daily_returns)*100:.2f}%")
print(f"\nTotal Return: {results['total_return']*100:.2f}%")
print(f"Cumulative Log Return: {results['cumulative_log_return']*100:.2f}%")
print(f"Final Wealth (from $1): ${results['wealth_path'][-1]:.4f}")</code></pre>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span>Value at Risk via Integration</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code class="language-python">from scipy import integrate, stats

def calculate_var_analytical(
    mu: float,
    sigma: float,
    confidence: float = 0.95,
    horizon: int = 1,
    portfolio_value: float = 1000000
) -> dict:
    """
    Calculate VaR using analytical integration of normal distribution.

    VaR at confidence level Œ± is the value x such that:
    P(R < x) = ‚à´_{-‚àû}^{x} f(r) dr = 1 - Œ±

    Parameters:
    -----------
    mu : float
        Expected return (daily)
    sigma : float
        Volatility (daily)
    confidence : float
        Confidence level (e.g., 0.95 for 95% VaR)
    horizon : int
        Time horizon in days
    portfolio_value : float
        Portfolio value

    Returns:
    --------
    dict : VaR metrics
    """
    # Scale to horizon
    mu_h = mu * horizon
    sigma_h = sigma * np.sqrt(horizon)

    # VaR as quantile (analytical)
    z_score = stats.norm.ppf(1 - confidence)
    var_return = mu_h + z_score * sigma_h
    var_dollar = -var_return * portfolio_value

    # Verify by integration
    def normal_cdf_integral(x):
        result, _ = integrate.quad(
            lambda r: stats.norm.pdf(r, mu_h, sigma_h),
            -np.inf, x
        )
        return result

    # Find x such that P(R < x) = 1 - confidence
    verification_prob = normal_cdf_integral(var_return)

    # Expected Shortfall (CVaR) - conditional expectation below VaR
    def conditional_loss(r):
        return r * stats.norm.pdf(r, mu_h, sigma_h)

    es_numerator, _ = integrate.quad(conditional_loss, -np.inf, var_return)
    cvar_return = es_numerator / (1 - confidence)
    cvar_dollar = -cvar_return * portfolio_value

    return {
        'var_return': var_return,
        'var_dollar': var_dollar,
        'cvar_return': cvar_return,
        'cvar_dollar': cvar_dollar,
        'confidence': confidence,
        'verification_prob': verification_prob
    }

# Calculate VaR
mu_daily = 0.0004
sigma_daily = 0.015
portfolio = 1_000_000

var_results = calculate_var_analytical(
    mu_daily, sigma_daily,
    confidence=0.95,
    horizon=1,
    portfolio_value=portfolio
)

print("\n" + "=" * 50)
print("VALUE AT RISK (VaR) CALCULATION")
print("=" * 50)
print(f"\nPortfolio Value: ${portfolio:,.0f}")
print(f"Confidence Level: {var_results['confidence']*100:.0f}%")
print(f"\n95% 1-day VaR:")
print(f"  Return: {var_results['var_return']*100:.4f}%")
print(f"  Dollar: ${var_results['var_dollar']:,.2f}")
print(f"\n95% 1-day CVaR (Expected Shortfall):")
print(f"  Return: {var_results['cvar_return']*100:.4f}%")
print(f"  Dollar: ${var_results['cvar_dollar']:,.2f}")
print(f"\nVerification P(R < VaR) = {var_results['verification_prob']:.4f}")</code></pre>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span>Option Pricing via Integration</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code class="language-python">from scipy import integrate, stats
import numpy as np

def option_price_by_integration(
    S: float,
    K: float,
    T: float,
    r: float,
    sigma: float,
    option_type: str = 'call'
) -> dict:
    """
    Price European option by integrating expected payoff.

    Call: E^Q[max(S_T - K, 0)] * e^(-rT)
        = ‚à´_K^‚àû (s - K) * f(s) ds * e^(-rT)

    where f(s) is the risk-neutral density of S_T (lognormal)
    """
    # Risk-neutral parameters
    # S_T is lognormal: ln(S_T) ~ N(ln(S) + (r - œÉ¬≤/2)T, œÉ¬≤T)
    mu_ln = np.log(S) + (r - 0.5 * sigma**2) * T
    sigma_ln = sigma * np.sqrt(T)

    # Lognormal PDF of S_T
    def lognormal_pdf(s):
        if s <= 0:
            return 0
        return stats.lognorm.pdf(s, s=sigma_ln, scale=np.exp(mu_ln))

    if option_type == 'call':
        # Integrate (s - K) * f(s) from K to infinity
        def integrand(s):
            return max(s - K, 0) * lognormal_pdf(s)

        expected_payoff, _ = integrate.quad(integrand, K, S * 10)  # Upper bound approximation

    else:  # put
        # Integrate (K - s) * f(s) from 0 to K
        def integrand(s):
            return max(K - s, 0) * lognormal_pdf(s)

        expected_payoff, _ = integrate.quad(integrand, 0.001, K)

    # Discount to present value
    option_price = expected_payoff * np.exp(-r * T)

    # Compare with Black-Scholes
    d1 = (np.log(S/K) + (r + 0.5*sigma**2)*T) / (sigma*np.sqrt(T))
    d2 = d1 - sigma*np.sqrt(T)

    if option_type == 'call':
        bs_price = S * stats.norm.cdf(d1) - K * np.exp(-r*T) * stats.norm.cdf(d2)
    else:
        bs_price = K * np.exp(-r*T) * stats.norm.cdf(-d2) - S * stats.norm.cdf(-d1)

    return {
        'integration_price': option_price,
        'black_scholes_price': bs_price,
        'difference': abs(option_price - bs_price)
    }

# Price a call option
result = option_price_by_integration(
    S=100, K=100, T=0.25, r=0.05, sigma=0.2, option_type='call'
)

print("\n" + "=" * 50)
print("OPTION PRICING VIA INTEGRATION")
print("=" * 50)
print(f"\nCall Option (S=100, K=100, T=0.25, r=5%, œÉ=20%)")
print(f"  Integration method: ${result['integration_price']:.4f}")
print(f"  Black-Scholes:      ${result['black_scholes_price']:.4f}")
print(f"  Difference:         ${result['difference']:.6f}")</code></pre>
      </div>
    </section>

    <!-- PART 6: INTERACTIVE CALCULATOR -->
    <section class="content-section fade-in">
      <h2>Part 6: Interactive Integral Calculator</h2>

      <div class="calculator">
        <h3>Definite Integral Calculator</h3>

        <div class="input-group">
          <label for="integralFunc">Select Function:</label>
          <select id="integralFunc" onchange="updateIntegral()">
            <option value="quad">f(x) = x¬≤ (Quadratic)</option>
            <option value="cubic">f(x) = x¬≥ (Cubic)</option>
            <option value="exp">f(x) = e^x (Exponential)</option>
            <option value="sin">f(x) = sin(x) (Sine)</option>
            <option value="normal">f(x) = Normal PDF</option>
          </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="input-group">
            <label for="lowerBound">Lower Bound (a): <span id="aValue">0</span></label>
            <input type="range" id="lowerBound" min="-3" max="3" step="0.1" value="0" oninput="updateIntegral()">
          </div>
          <div class="input-group">
            <label for="upperBound">Upper Bound (b): <span id="bValue">2</span></label>
            <input type="range" id="upperBound" min="-3" max="5" step="0.1" value="2" oninput="updateIntegral()">
          </div>
        </div>

        <div class="area-result">
          <div class="result-box">
            <div class="value" id="integralValue">2.67</div>
            <div class="label">‚à´<sub>a</sub><sup>b</sup> f(x) dx</div>
          </div>
          <div class="result-box">
            <div class="value" id="antiderivValue">F(b) - F(a)</div>
            <div class="label">Antiderivative Method</div>
          </div>
        </div>

        <div class="integral-display" id="integralFormula">
          ‚à´‚ÇÄ¬≤ x¬≤ dx = [x¬≥/3]‚ÇÄ¬≤ = 8/3 - 0 = 2.667
        </div>
      </div>

      <div class="chart-container">
        <h3>Area Under the Curve</h3>
        <canvas id="integralChart"></canvas>
      </div>
    </section>

    <!-- PART 7: TRADING APPLICATIONS -->
    <section class="content-section fade-in">
      <h2>Part 7: Trading Applications</h2>

      <div class="card-grid">
        <div class="card">
          <h4>Probability Calculations</h4>
          <p>P(a < X < b) = ‚à´‚Çê·µá f(x)dx for any continuous distribution. Essential for VaR, probability of profit, etc.</p>
          <div class="highlight">P(loss > 5%) = ‚à´‚Çã‚àû^(-0.05) f(r)dr</div>
        </div>
        <div class="card">
          <h4>Expected Payoffs</h4>
          <p>Option prices = discounted expected payoffs. Call = e‚Åª ≥·µÄ ‚à´‚Çñ^‚àû (s-K)f(s)ds under risk-neutral measure.</p>
          <div class="highlight">C = e‚Åª ≥·µÄ E[max(S‚Çú-K, 0)]</div>
        </div>
        <div class="card">
          <h4>Cumulative P&L</h4>
          <p>Total returns accumulate via integration. Wealth(T) = W‚ÇÄ ¬∑ exp(‚à´‚ÇÄ·µÄ r(t)dt) for continuous compounding.</p>
          <div class="highlight">W(T) = W‚ÇÄ ¬∑ e^(‚à´r dt)</div>
        </div>
        <div class="card">
          <h4>Duration as Integral</h4>
          <p>Macaulay Duration = weighted average time of cash flows. D = ‚à´‚ÇÄ·µÄ t¬∑c(t)¬∑e‚Åª ∏·µó dt / P.</p>
          <div class="highlight">D = -1/P ¬∑ dP/dy</div>
        </div>
      </div>

      <div class="chart-container">
        <h3>Cumulative Return Path</h3>
        <canvas id="wealthChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>Return Distribution with VaR</h3>
        <canvas id="varDistChart"></canvas>
      </div>
    </section>

    <!-- PART 8: COMMON MISTAKES -->
    <section class="content-section fade-in">
      <h2>Part 8: Common Mistakes to Avoid</h2>

      <div class="warning-box">
        <h3>Mistake 1: Integrating Simple Returns Directly</h3>
        <p>‚à´ simple_returns ‚â† total return. Use cumulative product for simple returns or cumulative sum for log returns.</p>
        <div class="code-block">
          <div class="code-header">
            <span>Correct Cumulative Returns</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># WRONG: Direct integration of simple returns
wrong_total = np.trapz(simple_returns)

# RIGHT: Cumulative product for simple returns
correct_total = np.prod(1 + simple_returns) - 1

# RIGHT: Cumulative sum for log returns
log_returns = np.log(1 + simple_returns)
correct_total_log = np.exp(np.sum(log_returns)) - 1</code></pre>
        </div>
      </div>

      <div class="warning-box">
        <h3>Mistake 2: Wrong Number of Intervals for Simpson's</h3>
        <p>Simpson's rule requires an EVEN number of intervals. Odd intervals give wrong results.</p>
      </div>

      <div class="warning-box">
        <h3>Mistake 3: Ignoring Improper Integrals</h3>
        <p>‚à´‚Çã‚àû^‚àû requires special handling. scipy.integrate.quad handles infinite bounds automatically.</p>
      </div>

      <div class="warning-box">
        <h3>Mistake 4: Forgetting the Discount Factor</h3>
        <p>Expected payoffs must be discounted: PV = e‚Åª ≥·µÄ ¬∑ E[Payoff]. Forgetting e‚Åª ≥·µÄ overvalues future cash flows.</p>
      </div>
    </section>

    <!-- SUMMARY -->
    <section class="content-section fade-in">
      <h2>Summary</h2>

      <div class="key-concept">
        <h3>Key Takeaways</h3>
        <ul>
          <li><strong>Integrals calculate accumulated quantities</strong> - area, probability, expected values</li>
          <li><strong>Fundamental Theorem</strong> connects derivatives and integrals: ‚à´f = F(b) - F(a)</li>
          <li><strong>Numerical methods</strong>: Trapezoidal O(h¬≤), Simpson's O(h‚Å¥), use scipy.quad for best results</li>
          <li><strong>PDF ‚Üí CDF via integration</strong>: P(X < x) = ‚à´‚Çã‚àûÀ£ f(t)dt</li>
          <li><strong>Expected values</strong>: E[g(X)] = ‚à´ g(x)f(x)dx for option pricing</li>
        </ul>
      </div>

      <div class="nav-buttons">
        <a href="3.1_differential_calculus.html" class="nav-btn">‚Üê Previous: Differential Calculus</a>
        <a href="3.3_multivariate_calculus.html" class="nav-btn">Next: Multivariate Calculus ‚Üí</a>
      </div>
    </section>

    <!-- QUIZ -->
    <section class="content-section fade-in">
      <h2>Test Your Knowledge</h2>

      <div class="quiz-container" id="quiz">
        <div class="quiz-question">
          <h4>Question 1: What does ‚à´‚Çã‚àû^x f(t)dt represent for a PDF f(t)?</h4>
          <div class="quiz-options">
            <label><input type="radio" name="q1" value="a"> The probability density at x</label>
            <label><input type="radio" name="q1" value="b"> The cumulative distribution function F(x)</label>
            <label><input type="radio" name="q1" value="c"> The expected value</label>
            <label><input type="radio" name="q1" value="d"> The variance</label>
          </div>
          <div class="quiz-feedback" id="feedback1"></div>
        </div>

        <div class="quiz-question">
          <h4>Question 2: What is ‚à´‚ÇÄ¬≥ 2x dx?</h4>
          <div class="quiz-options">
            <label><input type="radio" name="q2" value="a"> 6</label>
            <label><input type="radio" name="q2" value="b"> 9</label>
            <label><input type="radio" name="q2" value="c"> 18</label>
            <label><input type="radio" name="q2" value="d"> 3</label>
          </div>
          <div class="quiz-feedback" id="feedback2"></div>
        </div>

        <div class="quiz-question">
          <h4>Question 3: Which numerical integration method has O(h‚Å¥) error?</h4>
          <div class="quiz-options">
            <label><input type="radio" name="q3" value="a"> Left Riemann sum</label>
            <label><input type="radio" name="q3" value="b"> Trapezoidal rule</label>
            <label><input type="radio" name="q3" value="c"> Simpson's rule</label>
            <label><input type="radio" name="q3" value="d"> Midpoint rule</label>
          </div>
          <div class="quiz-feedback" id="feedback3"></div>
        </div>

        <div class="quiz-question">
          <h4>Question 4: For a standard normal distribution, ‚à´‚Çã‚àû^‚àû f(x)dx equals:</h4>
          <div class="quiz-options">
            <label><input type="radio" name="q4" value="a"> 0</label>
            <label><input type="radio" name="q4" value="b"> 0.5</label>
            <label><input type="radio" name="q4" value="c"> 1</label>
            <label><input type="radio" name="q4" value="d"> ‚àö(2œÄ)</label>
          </div>
          <div class="quiz-feedback" id="feedback4"></div>
        </div>

        <div class="quiz-question">
          <h4>Question 5: How do you calculate the expected payoff of a call option at expiration?</h4>
          <div class="quiz-options">
            <label><input type="radio" name="q5" value="a"> ‚à´‚ÇÄ^K (K-s)f(s)ds</label>
            <label><input type="radio" name="q5" value="b"> ‚à´‚Çñ^‚àû (s-K)f(s)ds</label>
            <label><input type="radio" name="q5" value="c"> ‚à´‚Çã‚àû^‚àû sf(s)ds</label>
            <label><input type="radio" name="q5" value="d"> ‚à´‚ÇÄ^‚àû Kf(s)ds</label>
          </div>
          <div class="quiz-feedback" id="feedback5"></div>
        </div>

        <button class="btn" onclick="checkQuiz()">Submit Answers</button>
        <div class="quiz-score" id="quizScore"></div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="../../assets/js/shared-scripts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

  <script>
    const integralFunctions = {
      quad: {
        f: x => x * x,
        F: x => x * x * x / 3,
        name: 'x¬≤',
        antideriv: 'x¬≥/3'
      },
      cubic: {
        f: x => x * x * x,
        F: x => x * x * x * x / 4,
        name: 'x¬≥',
        antideriv: 'x‚Å¥/4'
      },
      exp: {
        f: x => Math.exp(x),
        F: x => Math.exp(x),
        name: 'eÀ£',
        antideriv: 'eÀ£'
      },
      sin: {
        f: x => Math.sin(x),
        F: x => -Math.cos(x),
        name: 'sin(x)',
        antideriv: '-cos(x)'
      },
      normal: {
        f: x => Math.exp(-x * x / 2) / Math.sqrt(2 * Math.PI),
        F: x => 0.5 * (1 + erf(x / Math.sqrt(2))),
        name: 'Normal PDF',
        antideriv: 'Œ¶(x)'
      }
    };

    let integralChart, wealthChart, varDistChart;

    function erf(x) {
      const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
      const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
      const sign = x < 0 ? -1 : 1;
      x = Math.abs(x);
      const t = 1.0 / (1.0 + p * x);
      const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
      return sign * y;
    }

    function initializeCharts() {
      // Integral chart
      const ctx1 = document.getElementById('integralChart').getContext('2d');
      integralChart = new Chart(ctx1, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'f(x)',
              data: [],
              borderColor: '#6366f1',
              borderWidth: 2,
              fill: false,
              pointRadius: 0
            },
            {
              label: 'Area',
              data: [],
              backgroundColor: 'rgba(16, 185, 129, 0.3)',
              borderColor: '#10b981',
              borderWidth: 2,
              fill: true,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#e2e8f0' } } },
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'x', color: '#94a3b8' },
              ticks: { color: '#94a3b8' },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            },
            y: {
              title: { display: true, text: 'f(x)', color: '#94a3b8' },
              ticks: { color: '#94a3b8' },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            }
          }
        }
      });

      // Wealth chart
      const ctx2 = document.getElementById('wealthChart').getContext('2d');
      const days = 252;
      const wealthPath = [1];
      for (let i = 1; i < days; i++) {
        const ret = 0.0004 + 0.015 * (Math.random() - 0.5) * 2;
        wealthPath.push(wealthPath[i - 1] * (1 + ret));
      }

      wealthChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: Array.from({ length: days }, (_, i) => i),
          datasets: [{
            label: 'Cumulative Wealth',
            data: wealthPath,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 2,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e2e8f0' } },
            title: { display: true, text: 'Wealth = ‚àè(1 + daily returns)', color: '#94a3b8' }
          },
          scales: {
            x: {
              title: { display: true, text: 'Day', color: '#94a3b8' },
              ticks: { color: '#94a3b8' },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            },
            y: {
              title: { display: true, text: 'Wealth ($)', color: '#94a3b8' },
              ticks: { color: '#94a3b8' },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            }
          }
        }
      });

      // VaR distribution chart
      const ctx3 = document.getElementById('varDistChart').getContext('2d');
      const xVals = [];
      const pdfVals = [];
      const varThreshold = -0.025;

      for (let x = -0.06; x <= 0.06; x += 0.002) {
        xVals.push((x * 100).toFixed(1) + '%');
        pdfVals.push(Math.exp(-x * x / (2 * 0.015 * 0.015)) / (0.015 * Math.sqrt(2 * Math.PI)));
      }

      varDistChart = new Chart(ctx3, {
        type: 'line',
        data: {
          labels: xVals,
          datasets: [{
            label: 'Return Distribution',
            data: pdfVals,
            borderColor: '#6366f1',
            backgroundColor: pdfVals.map((_, i) => {
              const x = -0.06 + i * 0.002;
              return x < varThreshold ? 'rgba(239, 68, 68, 0.5)' : 'rgba(99, 102, 241, 0.2)';
            }),
            borderWidth: 2,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e2e8f0' } },
            title: { display: true, text: '95% VaR = area in red tail', color: '#94a3b8' }
          },
          scales: {
            x: {
              title: { display: true, text: 'Daily Return', color: '#94a3b8' },
              ticks: { color: '#94a3b8', maxTicksLimit: 10 },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            },
            y: {
              title: { display: true, text: 'Probability Density', color: '#94a3b8' },
              ticks: { color: '#94a3b8' },
              grid: { color: 'rgba(148, 163, 184, 0.1)' }
            }
          }
        }
      });

      updateIntegral();
    }

    function updateIntegral() {
      const funcKey = document.getElementById('integralFunc').value;
      const a = parseFloat(document.getElementById('lowerBound').value);
      const b = parseFloat(document.getElementById('upperBound').value);

      document.getElementById('aValue').textContent = a.toFixed(1);
      document.getElementById('bValue').textContent = b.toFixed(1);

      const func = integralFunctions[funcKey];
      const integralValue = func.F(b) - func.F(a);

      document.getElementById('integralValue').textContent = integralValue.toFixed(4);
      document.getElementById('antiderivValue').textContent = `${func.antideriv}|${a}‚Üí${b}`;
      document.getElementById('integralFormula').innerHTML =
        `‚à´<sub>${a}</sub><sup>${b}</sup> ${func.name} dx = [${func.antideriv}]<sub>${a}</sub><sup>${b}</sup> = ${integralValue.toFixed(4)}`;

      // Generate chart data
      const xMin = Math.min(a, -3);
      const xMax = Math.max(b, 5);
      const funcData = [];
      const areaData = [];

      for (let x = xMin; x <= xMax; x += 0.05) {
        const y = func.f(x);
        if (isFinite(y) && Math.abs(y) < 20) {
          funcData.push({ x, y });
          if (x >= a && x <= b) {
            areaData.push({ x, y });
          }
        }
      }

      integralChart.data.datasets[0].data = funcData;
      integralChart.data.datasets[1].data = areaData;
      integralChart.update();
    }

    function checkQuiz() {
      const answers = {
        q1: { correct: 'b', explanation: 'The integral of PDF from -‚àû to x gives the CDF F(x) = P(X ‚â§ x).' },
        q2: { correct: 'b', explanation: '‚à´‚ÇÄ¬≥ 2x dx = [x¬≤]‚ÇÄ¬≥ = 9 - 0 = 9' },
        q3: { correct: 'c', explanation: 'Simpson\'s rule uses quadratic interpolation and has error O(h‚Å¥), better than O(h¬≤) for trapezoidal.' },
        q4: { correct: 'c', explanation: 'Any valid PDF integrates to 1 over its entire domain (total probability = 100%).' },
        q5: { correct: 'b', explanation: 'Call payoff = max(S-K, 0). For S > K, payoff = S-K. Expected value = ‚à´‚Çñ^‚àû (s-K)f(s)ds.' }
      };

      let score = 0;
      const total = Object.keys(answers).length;

      for (const [q, data] of Object.entries(answers)) {
        const selected = document.querySelector(`input[name="${q}"]:checked`);
        const feedback = document.getElementById(`feedback${q.slice(1)}`);

        if (selected && selected.value === data.correct) {
          score++;
          feedback.innerHTML = `<span style="color: #10b981;">‚úì Correct!</span> ${data.explanation}`;
        } else {
          feedback.innerHTML = `<span style="color: #ef4444;">‚úó Incorrect.</span> ${data.explanation}`;
        }
        feedback.style.display = 'block';
      }

      const pct = (score / total * 100).toFixed(0);
      document.getElementById('quizScore').innerHTML = `
        <h3>Score: ${score}/${total} (${pct}%)</h3>
        <p>${pct >= 80 ? 'Excellent!' : pct >= 60 ? 'Good progress!' : 'Review the material and try again.'}</p>
      `;
    }

    document.addEventListener('DOMContentLoaded', initializeCharts);
  </script>
</body>
</html>