<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Master the Put/Call Ratio as a contrarian sentiment indicator. Learn to spot extreme readings and time stock/ETF entries using options market sentiment.">
    <title>8.1.3 Put/Call Ratio - Sentiment Indicator | Quantitative Trading Mastery</title>

    <link rel="stylesheet" href="../../../assets/css/shared-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="icon" href="../../../assets/images/logo.png" type="image/png">

    <style>
        .pc-eq { font-size: 1.4rem; color: #8b5cf6; text-align: center; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; margin: 20px 0; border: 1px solid rgba(139, 92, 246, 0.3); }
        .metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .metric-card { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid rgba(148, 163, 184, 0.1); }
        .metric-value { font-size: 1.5rem; font-weight: bold; }
        .metric-label { font-size: 0.85rem; color: #94a3b8; margin-top: 5px; }
        .pc-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem; }
        .pc-table th, .pc-table td { padding: 12px; border: 1px solid rgba(148, 163, 184, 0.2); text-align: center; }
        .pc-table th { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; }
        .pc-table tr:hover { background: rgba(139, 92, 246, 0.1); }
        .bullish-zone { color: #10b981; font-weight: bold; }
        .bearish-zone { color: #ef4444; font-weight: bold; }
        .neutral-zone { color: #f59e0b; }
        .extreme-zone { color: #ec4899; font-weight: bold; }
        .sentiment-gauge { display: flex; flex-direction: column; align-items: center; margin: 30px 0; }
        .gauge-bar { width: 100%; max-width: 600px; height: 40px; background: linear-gradient(to right, #10b981, #10b981 30%, #f59e0b 30%, #f59e0b 60%, #ef4444 60%, #ef4444); border-radius: 20px; position: relative; margin: 10px 0; }
        .gauge-marker { position: absolute; top: -8px; width: 4px; height: 56px; background: white; border-radius: 2px; transform: translateX(-50%); transition: left 0.5s ease; }
        .gauge-labels { display: flex; justify-content: space-between; width: 100%; max-width: 600px; font-size: 0.85rem; color: #94a3b8; }
        .calculator-section { background: rgba(0,0,0,0.3); border-radius: 16px; padding: 25px; margin: 25px 0; border: 1px solid rgba(139, 92, 246, 0.3); }
        .calc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; }
        .calc-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; padding: 12px; color: #f1f5f9; width: 100%; }
        .calc-input:focus { outline: none; border-color: #8b5cf6; }
        .calc-btn { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .calc-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4); }
        .calc-result { background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px; }
        .signal-box { padding: 20px; border-radius: 12px; margin: 15px 0; text-align: center; }
        .signal-bullish { background: rgba(16, 185, 129, 0.15); border: 2px solid #10b981; }
        .signal-bearish { background: rgba(239, 68, 68, 0.15); border: 2px solid #ef4444; }
        .signal-neutral { background: rgba(245, 158, 11, 0.15); border: 2px solid #f59e0b; }
        .chart-container { position: relative; height: 400px; }
        .chart-container canvas { max-height: 350px; }
        @media (max-width: 768px) {
            .metric-grid { grid-template-columns: repeat(2, 1fr); }
            .calc-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="module-nav-header">
        <div class="container">
            <div class="nav-content">
                <a href="8.1.2_implied_volatility_fear_gauge.html" class="nav-home">‚Üê Previous</a>
                <div class="nav-module-info">
                    <span class="nav-module-number">Module 8.1.3</span>
                    <span class="nav-module-title">Put/Call Ratio Sentiment</span>
                </div>
                <a href="8.1.4_open_interest_analysis.html" class="nav-next">Next Module ‚Üí</a>
            </div>
        </div>
    </nav>

    <header class="module-hero">
        <div class="container">
            <div class="module-hero-content">
                <div class="module-breadcrumb">
                    <span>Module 8: Options Market Intelligence</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span>8.1 Foundations</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span>8.1.3 Put/Call Ratio</span>
                </div>
                <h1>Put/Call Ratio as Sentiment Indicator</h1>
                <p class="module-subtitle">
                    The ultimate contrarian indicator. When everyone is bearish (high P/C), buy. When everyone is bullish (low P/C), be cautious.
                    Extreme readings predict reversals with high accuracy.
                </p>
                <div class="module-meta">
                    <span class="meta-item">‚è±Ô∏è 35 min read</span>
                    <span class="meta-item">üìä 4 Visualizations</span>
                    <span class="meta-item">üíª P/C Calculator</span>
                    <span class="meta-item">‚úÖ 5 Quiz Questions</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container content-wrapper">
        <!-- PART 1: WHY SHOULD I CARE? -->
        <section class="content-section fade-in">
            <h2>Part 1: Why Should I Care?</h2>

            <div class="info-box info-box-warning">
                <div class="info-box-title">The Crowd is Usually Wrong at Extremes</div>
                <p>
                    October 2022: SPY is crashing. The Put/Call ratio spikes to 1.8‚Äîeveryone is buying puts for protection.
                    Media screams "more downside ahead!" Within 3 weeks, SPY rallies 15%. Those who understood the P/C ratio
                    as a <strong>contrarian indicator</strong> bought the fear and profited handsomely.
                </p>
            </div>

            <div class="pc-eq">
                Put/Call Ratio = Total Put Volume / Total Call Volume
            </div>
            <p style="text-align: center; color: #94a3b8;">When the crowd is extremely fearful (high P/C), the market often reverses UP</p>

            <div class="card-grid">
                <div class="card">
                    <h4>Contrarian Indicator</h4>
                    <p>P/C ratio measures crowd sentiment. Extreme readings often mark turning points‚Äîthe crowd is wrong at extremes.</p>
                    <div class="highlight">Buy fear, sell greed</div>
                </div>
                <div class="card">
                    <h4>High P/C (> 1.0)</h4>
                    <p>More puts than calls being traded. The crowd is bearish/fearful. Historically, this precedes rallies.</p>
                    <div class="highlight">Contrarian bullish signal</div>
                </div>
                <div class="card">
                    <h4>Low P/C (< 0.7)</h4>
                    <p>More calls than puts being traded. The crowd is greedy/complacent. Market may be topping.</p>
                    <div class="highlight">Contrarian bearish signal</div>
                </div>
                <div class="card">
                    <h4>Extreme Readings</h4>
                    <p>P/C > 1.5 = extreme fear (buy signal). P/C < 0.5 = extreme greed (caution signal). Extremes mean revert.</p>
                    <div class="highlight">Most powerful signals</div>
                </div>
            </div>

            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value bullish-zone">< 0.7</div>
                    <div class="metric-label">Bullish Crowd (Caution)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value neutral-zone">0.7 - 1.0</div>
                    <div class="metric-label">Neutral Zone</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value bearish-zone">> 1.0</div>
                    <div class="metric-label">Bearish Crowd (Bullish)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value extreme-zone">> 1.5</div>
                    <div class="metric-label">Extreme Fear (Strong Buy)</div>
                </div>
            </div>
        </section>

        <!-- PART 2: BUILDING INTUITION -->
        <section class="content-section fade-in">
            <h2>Part 2: Building Intuition</h2>

            <div class="info-box">
                <div class="info-box-title">Why Does the Contrarian Approach Work?</div>
                <p>
                    Markets are driven by supply and demand. When everyone has already bought puts (bearish), there's no one
                    left to sell‚Äîthe selling pressure exhausts. Conversely, when everyone owns calls (bullish), there's no one
                    left to buy. Extreme sentiment = exhausted positioning = reversal likely.
                </p>
            </div>

            <!-- Sentiment Gauge -->
            <h3>Current Market Sentiment Gauge</h3>
            <div class="sentiment-gauge">
                <div class="gauge-bar">
                    <div class="gauge-marker" id="pcMarker" style="left: 45%;"></div>
                </div>
                <div class="gauge-labels">
                    <span>Extreme Greed<br>(P/C < 0.5)</span>
                    <span>Greed<br>(0.5-0.7)</span>
                    <span>Neutral<br>(0.7-1.0)</span>
                    <span>Fear<br>(1.0-1.5)</span>
                    <span>Extreme Fear<br>(> 1.5)</span>
                </div>
                <p style="margin-top: 15px;">Current P/C: <span id="currentPC" style="font-weight: bold; color: #8b5cf6;">0.85</span> - <span id="pcInterpretation">Neutral, slight greed</span></p>
            </div>

            <!-- SVG Diagram -->
            <div style="text-align: center; margin: 30px 0;">
                <svg viewBox="0 0 800 400" style="max-width: 100%; height: auto;">
                    <defs>
                        <linearGradient id="pcGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.8" />
                            <stop offset="50%" style="stop-color:#f59e0b;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#ef4444;stop-opacity:0.8" />
                        </linearGradient>
                    </defs>

                    <!-- Title -->
                    <text x="400" y="30" text-anchor="middle" fill="#f1f5f9" font-size="18" font-weight="bold">Put/Call Ratio: Contrarian Interpretation</text>

                    <!-- P/C Scale -->
                    <rect x="100" y="60" width="600" height="30" rx="5" fill="url(#pcGradient)" />
                    <text x="100" y="110" fill="#94a3b8" font-size="11">0.3</text>
                    <text x="220" y="110" fill="#94a3b8" font-size="11">0.6</text>
                    <text x="340" y="110" fill="#94a3b8" font-size="11">0.9</text>
                    <text x="460" y="110" fill="#94a3b8" font-size="11">1.2</text>
                    <text x="580" y="110" fill="#94a3b8" font-size="11">1.5</text>
                    <text x="700" y="110" fill="#94a3b8" font-size="11">1.8+</text>

                    <!-- Crowd Sentiment Labels -->
                    <text x="175" y="140" fill="#10b981" font-size="12" font-weight="bold">CROWD BULLISH</text>
                    <text x="400" y="140" fill="#f59e0b" font-size="12" font-weight="bold" text-anchor="middle">NEUTRAL</text>
                    <text x="625" y="140" fill="#ef4444" font-size="12" font-weight="bold">CROWD BEARISH</text>

                    <!-- Contrarian Signal Boxes -->
                    <rect x="100" y="170" width="200" height="100" rx="10" fill="rgba(239, 68, 68, 0.2)" stroke="#ef4444" />
                    <text x="200" y="200" text-anchor="middle" fill="#ef4444" font-size="14" font-weight="bold">CONTRARIAN BEARISH</text>
                    <text x="200" y="225" text-anchor="middle" fill="#94a3b8" font-size="11">Too much optimism</text>
                    <text x="200" y="245" text-anchor="middle" fill="#f1f5f9" font-size="11">Market may be topping</text>
                    <text x="200" y="265" text-anchor="middle" fill="#94a3b8" font-size="10">Action: Reduce longs, tighten stops</text>

                    <rect x="500" y="170" width="200" height="100" rx="10" fill="rgba(16, 185, 129, 0.2)" stroke="#10b981" />
                    <text x="600" y="200" text-anchor="middle" fill="#10b981" font-size="14" font-weight="bold">CONTRARIAN BULLISH</text>
                    <text x="600" y="225" text-anchor="middle" fill="#94a3b8" font-size="11">Too much pessimism</text>
                    <text x="600" y="245" text-anchor="middle" fill="#f1f5f9" font-size="11">Market may be bottoming</text>
                    <text x="600" y="265" text-anchor="middle" fill="#94a3b8" font-size="10">Action: Accumulate longs</text>

                    <!-- Historical Example -->
                    <rect x="150" y="300" width="500" height="80" rx="10" fill="rgba(139, 92, 246, 0.15)" stroke="rgba(139, 92, 246, 0.5)" />
                    <text x="400" y="325" text-anchor="middle" fill="#c4b5fd" font-size="12" font-weight="bold">HISTORICAL EXAMPLE</text>
                    <text x="400" y="350" text-anchor="middle" fill="#f1f5f9" font-size="11">March 2020: P/C hit 2.0+ (extreme fear) ‚Üí SPY rallied 70% over next year</text>
                    <text x="400" y="370" text-anchor="middle" fill="#94a3b8" font-size="10">October 2022: P/C hit 1.8 ‚Üí SPY rallied 15% in 3 weeks</text>
                </svg>
            </div>

            <div class="card-grid">
                <div class="card">
                    <h4>Equity P/C Ratio</h4>
                    <p>Individual stock options only. Reflects retail and institutional sentiment on single stocks.</p>
                    <div class="highlight">More volatile, faster signals</div>
                </div>
                <div class="card">
                    <h4>Index P/C Ratio</h4>
                    <p>SPX, NDX, and other index options. Reflects institutional hedging and macro positioning.</p>
                    <div class="highlight">Institutional-focused</div>
                </div>
                <div class="card">
                    <h4>Total P/C Ratio</h4>
                    <p>All options combined. Broadest measure of overall market sentiment.</p>
                    <div class="highlight">Most comprehensive view</div>
                </div>
                <div class="card">
                    <h4>Moving Averages</h4>
                    <p>5-day or 10-day MA smooths noise. Spikes above/below MA are stronger signals than absolute levels.</p>
                    <div class="highlight">Reduces false signals</div>
                </div>
            </div>
        </section>

        <!-- PART 3: THE MATHEMATICS -->
        <section class="content-section fade-in">
            <h2>Part 3: The Mathematics</h2>

            <div class="formula-box">
                <h3>Put/Call Ratio (Volume)</h3>
                <div class="formula">P/C Ratio = Total Put Volume / Total Call Volume</div>
                <p>Most common calculation. Values typically range from 0.5 to 1.5, with extremes beyond.</p>
            </div>

            <div class="formula-box">
                <h3>Put/Call Ratio (Open Interest)</h3>
                <div class="formula">P/C Ratio (OI) = Total Put Open Interest / Total Call Open Interest</div>
                <p>More stable than volume. Reflects accumulated positioning rather than daily activity.</p>
            </div>

            <div class="formula-box">
                <h3>P/C Percentile</h3>
                <div class="formula">P/C Percentile = (Days with lower P/C) / (Total Days) √ó 100%</div>
                <p>Where current P/C stands relative to history. P/C Percentile > 90% = historically high fear.</p>
            </div>

            <div class="formula-box">
                <h3>P/C Moving Average Deviation</h3>
                <div class="formula">Deviation = (Current P/C - MA) / MA √ó 100%</div>
                <p>Positive deviation = more bearish than average. Negative = more bullish than average.</p>
            </div>

            <h3>P/C Ratio Interpretation Table</h3>
            <table class="pc-table">
                <thead>
                    <tr>
                        <th>P/C Range</th>
                        <th>Crowd Sentiment</th>
                        <th>Contrarian Signal</th>
                        <th>Typical Action</th>
                        <th>Historical Win Rate*</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="bullish-zone">< 0.5</td>
                        <td>Extreme Greed</td>
                        <td class="bearish-zone">Strong Sell/Caution</td>
                        <td>Reduce longs, tighten stops</td>
                        <td>72% (30-day decline)</td>
                    </tr>
                    <tr>
                        <td class="bullish-zone">0.5 - 0.7</td>
                        <td>Greed</td>
                        <td class="neutral-zone">Mild Caution</td>
                        <td>Be selective with longs</td>
                        <td>58%</td>
                    </tr>
                    <tr>
                        <td class="neutral-zone">0.7 - 1.0</td>
                        <td>Neutral</td>
                        <td>No Signal</td>
                        <td>Use other indicators</td>
                        <td>50%</td>
                    </tr>
                    <tr>
                        <td class="bearish-zone">1.0 - 1.5</td>
                        <td>Fear</td>
                        <td class="bullish-zone">Mild Buy</td>
                        <td>Look for long entries</td>
                        <td>62%</td>
                    </tr>
                    <tr>
                        <td class="extreme-zone">> 1.5</td>
                        <td>Extreme Fear</td>
                        <td class="bullish-zone">Strong Buy</td>
                        <td>Aggressively accumulate</td>
                        <td>78% (30-day rally)</td>
                    </tr>
                </tbody>
            </table>
            <p style="color: #94a3b8; font-size: 0.85rem;">*Based on CBOE Total P/C ratio 2010-2024. Past performance does not guarantee future results.</p>
        </section>

        <!-- PART 4: NUMERICAL EXAMPLE -->
        <section class="content-section fade-in">
            <h2>Part 4: Complete Worked Example</h2>

            <div class="info-box">
                <div class="info-box-title">Real Scenario: October 2022 Market Bottom</div>
                <p>Let's walk through how P/C ratio signaled the October 2022 market bottom.</p>
            </div>

            <h3>The Setup</h3>
            <table class="pc-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>SPY Price</th>
                        <th>P/C Ratio</th>
                        <th>P/C Percentile</th>
                        <th>Signal</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Oct 3, 2022</td>
                        <td>$365</td>
                        <td>1.25</td>
                        <td>78%</td>
                        <td class="neutral-zone">Elevated fear</td>
                    </tr>
                    <tr>
                        <td>Oct 7, 2022</td>
                        <td>$358</td>
                        <td>1.52</td>
                        <td>88%</td>
                        <td class="bullish-zone">Strong buy signal forming</td>
                    </tr>
                    <tr>
                        <td>Oct 13, 2022</td>
                        <td>$348</td>
                        <td class="extreme-zone">1.82</td>
                        <td class="extreme-zone">96%</td>
                        <td class="bullish-zone">EXTREME FEAR - Strong Buy</td>
                    </tr>
                    <tr>
                        <td>Oct 21, 2022</td>
                        <td>$375</td>
                        <td>1.15</td>
                        <td>70%</td>
                        <td class="neutral-zone">Fear subsiding</td>
                    </tr>
                    <tr>
                        <td>Nov 4, 2022</td>
                        <td>$392</td>
                        <td>0.92</td>
                        <td>55%</td>
                        <td class="neutral-zone">Neutral</td>
                    </tr>
                </tbody>
            </table>

            <div class="signal-box signal-bullish">
                <h3 style="color: #10b981; margin-bottom: 10px;">Result: +12.6% in 3 Weeks</h3>
                <p>Those who bought when P/C hit 1.82 (extreme fear) saw SPY rally from $348 to $392.</p>
                <p style="color: #94a3b8; margin-top: 10px;">The contrarian signal worked perfectly‚Äîextreme pessimism marked the bottom.</p>
            </div>

            <h3>Step-by-Step Analysis Process</h3>
            <div class="card-grid">
                <div class="card">
                    <h4>Step 1: Check Absolute Level</h4>
                    <p>P/C = 1.82 > 1.5 threshold ‚Üí Extreme fear zone confirmed.</p>
                </div>
                <div class="card">
                    <h4>Step 2: Check Percentile</h4>
                    <p>96th percentile ‚Üí P/C higher only 4% of the time historically. Rare extreme.</p>
                </div>
                <div class="card">
                    <h4>Step 3: Confirm with Context</h4>
                    <p>VIX also elevated, news extremely bearish. All signs point to capitulation.</p>
                </div>
                <div class="card">
                    <h4>Step 4: Execute</h4>
                    <p>Contrarian buy signal triggered. Add to SPY/QQQ positions or quality stocks.</p>
                </div>
            </div>
        </section>

        <!-- PART 5: PYTHON IMPLEMENTATION -->
        <section class="content-section fade-in">
            <h2>Part 5: Python Implementation</h2>

            <div class="code-block">
                <div class="code-header">
                    <span>put_call_ratio.py</span>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                </div>
                <pre><code class="language-python">"""
Put/Call Ratio Analysis Module

Calculate and interpret P/C ratios for contrarian trading signals.
Generate alerts when extreme readings occur.

Author: Quantitative Trading Mastery
"""

import pandas as pd
import numpy as np
from typing import Dict, Tuple, Literal, List, Optional
from dataclasses import dataclass
from datetime import datetime, timedelta
from enum import Enum


class SentimentSignal(Enum):
    """Contrarian trading signals based on P/C ratio."""
    STRONG_BUY = "STRONG_BUY"      # Extreme fear (P/C > 1.5)
    BUY = "BUY"                     # High fear (P/C 1.0-1.5)
    NEUTRAL = "NEUTRAL"            # Normal range (P/C 0.7-1.0)
    CAUTION = "CAUTION"            # Low fear (P/C 0.5-0.7)
    STRONG_SELL = "STRONG_SELL"    # Extreme greed (P/C < 0.5)


@dataclass
class PCAnalysis:
    """Container for P/C ratio analysis results."""
    current_pc: float
    pc_ma_5: float
    pc_ma_10: float
    pc_percentile: float
    sentiment: str
    signal: SentimentSignal
    signal_strength: float  # 0-1
    recommendation: str


def calculate_put_call_ratio(
    put_volume: int,
    call_volume: int
) -> float:
    """
    Calculate Put/Call ratio from volumes.

    Parameters
    ----------
    put_volume : int
        Total put option volume
    call_volume : int
        Total call option volume

    Returns
    -------
    float
        Put/Call ratio

    Examples
    --------
    >>> calculate_put_call_ratio(150000, 100000)
    1.5
    >>> calculate_put_call_ratio(80000, 120000)
    0.67
    """
    if call_volume == 0:
        return float('inf')
    return round(put_volume / call_volume, 3)


def calculate_pc_percentile(
    current_pc: float,
    pc_history: pd.Series,
    lookback_days: int = 252
) -> float:
    """
    Calculate P/C percentile (% of days with lower P/C).

    Parameters
    ----------
    current_pc : float
        Current P/C ratio
    pc_history : pd.Series
        Historical P/C values
    lookback_days : int
        Lookback period (default 252 = 1 year)

    Returns
    -------
    float
        Percentile (0-100)

    Examples
    --------
    >>> history = pd.Series([0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5])
    >>> calculate_pc_percentile(1.3, history)
    75.0
    """
    recent = pc_history.tail(lookback_days)
    percentile = (recent < current_pc).sum() / len(recent) * 100
    return round(percentile, 1)


def interpret_pc_ratio(pc_ratio: float) -> Tuple[str, SentimentSignal, float]:
    """
    Interpret P/C ratio and generate contrarian signal.

    Parameters
    ----------
    pc_ratio : float
        Current P/C ratio

    Returns
    -------
    Tuple[str, SentimentSignal, float]
        (crowd_sentiment, contrarian_signal, signal_strength)

    Examples
    --------
    >>> sentiment, signal, strength = interpret_pc_ratio(1.82)
    >>> signal
    <SentimentSignal.STRONG_BUY: 'STRONG_BUY'>
    """
    if pc_ratio >= 1.5:
        return ("Extreme Fear", SentimentSignal.STRONG_BUY, min(1.0, (pc_ratio - 1.5) / 0.5 + 0.7))
    elif pc_ratio >= 1.0:
        return ("Fear", SentimentSignal.BUY, 0.5 + (pc_ratio - 1.0) / 0.5 * 0.2)
    elif pc_ratio >= 0.7:
        return ("Neutral", SentimentSignal.NEUTRAL, 0.3)
    elif pc_ratio >= 0.5:
        return ("Greed", SentimentSignal.CAUTION, 0.4 + (0.7 - pc_ratio) / 0.2 * 0.2)
    else:
        return ("Extreme Greed", SentimentSignal.STRONG_SELL, min(1.0, (0.5 - pc_ratio) / 0.2 + 0.7))


def analyze_pc_ratio(
    put_volume: int,
    call_volume: int,
    pc_history: Optional[pd.Series] = None
) -> PCAnalysis:
    """
    Complete P/C ratio analysis for trading decisions.

    Parameters
    ----------
    put_volume : int
        Today's total put volume
    call_volume : int
        Today's total call volume
    pc_history : Optional[pd.Series]
        Historical P/C values for percentile calculation

    Returns
    -------
    PCAnalysis
        Complete analysis with signal and recommendations
    """
    current_pc = calculate_put_call_ratio(put_volume, call_volume)

    # Calculate moving averages if history provided
    if pc_history is not None and len(pc_history) >= 10:
        pc_ma_5 = pc_history.tail(5).mean()
        pc_ma_10 = pc_history.tail(10).mean()
        pc_percentile = calculate_pc_percentile(current_pc, pc_history)
    else:
        pc_ma_5 = current_pc
        pc_ma_10 = current_pc
        pc_percentile = 50.0

    # Interpret signal
    sentiment, signal, strength = interpret_pc_ratio(current_pc)

    # Generate recommendation
    recommendations = {
        SentimentSignal.STRONG_BUY: "STRONG BUY: Extreme fear detected. Historically excellent entry point. Consider aggressive long positions in quality stocks/ETFs.",
        SentimentSignal.BUY: "BUY: Elevated fear. Market sentiment overly bearish. Look for long entries on technical setups.",
        SentimentSignal.NEUTRAL: "NEUTRAL: No P/C signal. Market in normal sentiment range. Use other indicators for direction.",
        SentimentSignal.CAUTION: "CAUTION: Low fear, elevated greed. Market may be extended. Be selective, tighten stops on longs.",
        SentimentSignal.STRONG_SELL: "STRONG CAUTION: Extreme greed. Market likely overextended. Reduce long exposure, avoid new longs."
    }

    return PCAnalysis(
        current_pc=current_pc,
        pc_ma_5=round(pc_ma_5, 3),
        pc_ma_10=round(pc_ma_10, 3),
        pc_percentile=pc_percentile,
        sentiment=sentiment,
        signal=signal,
        signal_strength=round(strength, 2),
        recommendation=recommendations[signal]
    )


def generate_pc_alerts(
    pc_data: pd.DataFrame,
    high_threshold: float = 1.3,
    low_threshold: float = 0.6
) -> List[Dict]:
    """
    Generate alerts when P/C crosses thresholds.

    Parameters
    ----------
    pc_data : pd.DataFrame
        DataFrame with 'date' and 'pc_ratio' columns
    high_threshold : float
        Upper threshold for bullish alert
    low_threshold : float
        Lower threshold for bearish alert

    Returns
    -------
    List[Dict]
        List of alert dictionaries
    """
    alerts = []

    for i in range(1, len(pc_data)):
        prev_pc = pc_data.iloc[i-1]['pc_ratio']
        curr_pc = pc_data.iloc[i]['pc_ratio']
        date = pc_data.iloc[i]['date']

        # Bullish alert: crosses above high threshold
        if prev_pc < high_threshold and curr_pc >= high_threshold:
            alerts.append({
                'date': date,
                'type': 'BULLISH',
                'pc_ratio': curr_pc,
                'message': f'P/C ratio crossed above {high_threshold} - Contrarian BUY signal'
            })

        # Bearish alert: crosses below low threshold
        if prev_pc > low_threshold and curr_pc <= low_threshold:
            alerts.append({
                'date': date,
                'type': 'BEARISH',
                'pc_ratio': curr_pc,
                'message': f'P/C ratio crossed below {low_threshold} - Contrarian SELL signal'
            })

    return alerts


def backtest_pc_strategy(
    pc_data: pd.DataFrame,
    price_data: pd.DataFrame,
    buy_threshold: float = 1.5,
    sell_threshold: float = 0.6,
    holding_period: int = 30
) -> Dict:
    """
    Backtest contrarian P/C ratio strategy.

    Parameters
    ----------
    pc_data : pd.DataFrame
        P/C ratio data with 'date' and 'pc_ratio'
    price_data : pd.DataFrame
        Price data with 'date' and 'close'
    buy_threshold : float
        P/C level to trigger buy
    sell_threshold : float
        P/C level to trigger sell/avoid
    holding_period : int
        Days to hold after signal

    Returns
    -------
    Dict
        Backtest results
    """
    # Merge data
    merged = pd.merge(pc_data, price_data, on='date')
    results = []

    for i in range(len(merged) - holding_period):
        row = merged.iloc[i]

        if row['pc_ratio'] >= buy_threshold:
            entry_price = row['close']
            exit_price = merged.iloc[i + holding_period]['close']
            returns = (exit_price - entry_price) / entry_price * 100
            results.append({
                'type': 'BUY',
                'entry_date': row['date'],
                'entry_pc': row['pc_ratio'],
                'returns': returns
            })

    # Calculate statistics
    if results:
        buy_returns = [r['returns'] for r in results if r['type'] == 'BUY']
        return {
            'total_signals': len(results),
            'avg_return': round(np.mean(buy_returns), 2),
            'win_rate': round(len([r for r in buy_returns if r > 0]) / len(buy_returns) * 100, 1),
            'max_return': round(max(buy_returns), 2),
            'min_return': round(min(buy_returns), 2),
            'trades': results
        }

    return {'total_signals': 0, 'message': 'No signals generated'}


# ============================================================
# EXAMPLE USAGE
# ============================================================

if __name__ == "__main__":
    print("=" * 60)
    print("PUT/CALL RATIO ANALYSIS")
    print("=" * 60)

    # Simulate historical P/C data
    np.random.seed(42)
    dates = pd.date_range(end=datetime.now(), periods=252, freq='B')
    pc_history = pd.Series(
        0.85 + np.random.randn(252) * 0.15,
        index=dates
    ).clip(0.4, 2.0)

    # Today's data (extreme fear scenario)
    put_volume = 180000
    call_volume = 100000

    # Run analysis
    analysis = analyze_pc_ratio(put_volume, call_volume, pc_history)

    print(f"\nToday's Put Volume:  {put_volume:,}")
    print(f"Today's Call Volume: {call_volume:,}")
    print("-" * 60)
    print(f"P/C Ratio:           {analysis.current_pc}")
    print(f"P/C 5-day MA:        {analysis.pc_ma_5}")
    print(f"P/C 10-day MA:       {analysis.pc_ma_10}")
    print(f"P/C Percentile:      {analysis.pc_percentile}%")
    print("-" * 60)
    print(f"Crowd Sentiment:     {analysis.sentiment}")
    print(f"Contrarian Signal:   {analysis.signal.value}")
    print(f"Signal Strength:     {analysis.signal_strength:.0%}")
    print("-" * 60)
    print(f"Recommendation:\n  {analysis.recommendation}")

    # Generate sample alerts
    print("\n" + "=" * 60)
    print("RECENT ALERTS")
    print("=" * 60)

    pc_df = pd.DataFrame({
        'date': dates[-10:],
        'pc_ratio': [0.9, 1.1, 1.3, 1.5, 1.8, 1.6, 1.2, 0.9, 0.7, 0.55]
    })

    alerts = generate_pc_alerts(pc_df, high_threshold=1.3, low_threshold=0.6)
    for alert in alerts:
        print(f"  [{alert['date'].strftime('%Y-%m-%d')}] {alert['type']}: {alert['message']}")
</code></pre>
            </div>

            <h3>Sample Output</h3>
            <div class="code-block">
                <div class="code-header">
                    <span>Console Output</span>
                </div>
                <pre><code class="language-text">============================================================
PUT/CALL RATIO ANALYSIS
============================================================

Today's Put Volume:  180,000
Today's Call Volume: 100,000
------------------------------------------------------------
P/C Ratio:           1.8
P/C 5-day MA:        0.892
P/C 10-day MA:       0.876
P/C Percentile:      98.4%
------------------------------------------------------------
Crowd Sentiment:     Extreme Fear
Contrarian Signal:   STRONG_BUY
Signal Strength:     90%
------------------------------------------------------------
Recommendation:
  STRONG BUY: Extreme fear detected. Historically excellent
  entry point. Consider aggressive long positions in quality
  stocks/ETFs.

============================================================
RECENT ALERTS
============================================================
  [2024-01-15] BULLISH: P/C ratio crossed above 1.3 - Contrarian BUY signal
  [2024-01-22] BEARISH: P/C ratio crossed below 0.6 - Contrarian SELL signal</code></pre>
            </div>
        </section>

        <!-- PART 6: TRADING APPLICATIONS -->
        <section class="content-section fade-in">
            <h2>Part 6: Trading Applications</h2>

            <div class="card-grid">
                <div class="card">
                    <h4>Market Timing</h4>
                    <p>P/C > 1.5 combined with VIX spike = excellent long entry for SPY/QQQ. Wait for technical confirmation.</p>
                    <div class="highlight">Best for broad market ETFs</div>
                </div>
                <div class="card">
                    <h4>Individual Stocks</h4>
                    <p>Single stock P/C extremes work too. AAPL with P/C > 1.3 often sees bounce within days.</p>
                    <div class="highlight">Combine with company analysis</div>
                </div>
                <div class="card">
                    <h4>Risk Management</h4>
                    <p>When equity P/C < 0.5, reduce position sizes. Market euphoria often precedes corrections.</p>
                    <div class="highlight">Defensive positioning</div>
                </div>
                <div class="card">
                    <h4>Sector Rotation</h4>
                    <p>Sector ETFs with highest P/C ratios may be ready for bounce. Rotate into oversold sectors.</p>
                    <div class="highlight">Sector-level signals</div>
                </div>
            </div>

            <h3>Professional Workflow</h3>
            <table class="pc-table">
                <thead>
                    <tr>
                        <th>Step</th>
                        <th>Action</th>
                        <th>Tools</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1. Monitor</td>
                        <td>Track daily P/C ratio and percentile</td>
                        <td>CBOE data, broker platform</td>
                    </tr>
                    <tr>
                        <td>2. Alert</td>
                        <td>Set alerts for P/C > 1.3 or < 0.6</td>
                        <td>Custom scripts, alerts</td>
                    </tr>
                    <tr>
                        <td>3. Confirm</td>
                        <td>Check VIX, technicals, news context</td>
                        <td>Charts, IV analysis</td>
                    </tr>
                    <tr>
                        <td>4. Execute</td>
                        <td>Enter positions on technical setup</td>
                        <td>Limit orders, scaling in</td>
                    </tr>
                    <tr>
                        <td>5. Manage</td>
                        <td>Trail stops as P/C normalizes</td>
                        <td>Position management</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- PART 7: COMMON MISTAKES -->
        <section class="content-section fade-in">
            <h2>Part 7: Common Mistakes</h2>

            <div class="card-grid">
                <div class="card" style="border-left: 4px solid #ef4444;">
                    <h4>‚ùå Trading Every Signal</h4>
                    <p>P/C works best at EXTREMES (> 1.5 or < 0.5). Normal range signals are noise‚Äîdon't overtrade.</p>
                </div>
                <div class="card" style="border-left: 4px solid #ef4444;">
                    <h4>‚ùå Ignoring Context</h4>
                    <p>High P/C during genuine crisis (2008) can stay high longer. Always check if fear is justified.</p>
                </div>
                <div class="card" style="border-left: 4px solid #ef4444;">
                    <h4>‚ùå No Confirmation</h4>
                    <p>P/C alone isn't enough. Combine with VIX, technicals, and fundamentals for higher probability trades.</p>
                </div>
                <div class="card" style="border-left: 4px solid #ef4444;">
                    <h4>‚ùå Wrong Timeframe</h4>
                    <p>P/C is a short-term (days to weeks) indicator. Don't use for long-term investment decisions.</p>
                </div>
            </div>

            <div class="card-grid">
                <div class="card" style="border-left: 4px solid #10b981;">
                    <h4>‚úÖ Focus on Extremes</h4>
                    <p>Only trade when P/C Percentile > 90% or < 10%. These are the high-probability setups.</p>
                </div>
                <div class="card" style="border-left: 4px solid #10b981;">
                    <h4>‚úÖ Use Moving Averages</h4>
                    <p>5-day or 10-day MA smooths daily noise. Spike above MA is stronger signal than absolute level.</p>
                </div>
                <div class="card" style="border-left: 4px solid #10b981;">
                    <h4>‚úÖ Combine with VIX</h4>
                    <p>P/C extreme + VIX spike = higher confidence. Multiple fear indicators confirming is powerful.</p>
                </div>
                <div class="card" style="border-left: 4px solid #10b981;">
                    <h4>‚úÖ Wait for Technical Entry</h4>
                    <p>P/C tells you SENTIMENT. Still wait for price action to confirm (support, reversal candle, etc.)</p>
                </div>
            </div>
        </section>

        <!-- PART 8: SUMMARY -->
        <section class="content-section fade-in">
            <h2>Part 8: Summary & Cheat Sheet</h2>

            <div class="formula-box">
                <h3>Key Formulas</h3>
                <div class="formula">P/C Ratio = Put Volume / Call Volume</div>
                <div class="formula">P/C Percentile = (Days Lower) / (Total Days) √ó 100%</div>
                <div class="formula">Contrarian: High P/C (> 1.5) = Buy | Low P/C (< 0.5) = Caution</div>
            </div>

            <h3>Quick Reference Table</h3>
            <table class="pc-table">
                <thead>
                    <tr>
                        <th>P/C Ratio</th>
                        <th>Crowd</th>
                        <th>Contrarian Signal</th>
                        <th>Stock Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="extreme-zone">> 1.5</td>
                        <td>Extreme Fear</td>
                        <td class="bullish-zone">STRONG BUY</td>
                        <td>Aggressively accumulate quality longs</td>
                    </tr>
                    <tr>
                        <td class="bearish-zone">1.0 - 1.5</td>
                        <td>Fear</td>
                        <td class="bullish-zone">BUY</td>
                        <td>Look for long entries</td>
                    </tr>
                    <tr>
                        <td class="neutral-zone">0.7 - 1.0</td>
                        <td>Neutral</td>
                        <td>No Signal</td>
                        <td>Use other indicators</td>
                    </tr>
                    <tr>
                        <td class="bullish-zone">0.5 - 0.7</td>
                        <td>Greed</td>
                        <td class="bearish-zone">CAUTION</td>
                        <td>Be selective, tighten stops</td>
                    </tr>
                    <tr>
                        <td class="extreme-zone">< 0.5</td>
                        <td>Extreme Greed</td>
                        <td class="bearish-zone">AVOID LONGS</td>
                        <td>Reduce exposure, defensive</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- INTERACTIVE CALCULATOR -->
        <section class="content-section fade-in">
            <h2>Interactive P/C Calculator</h2>

            <div class="calculator-section">
                <h3>Put/Call Ratio Analyzer</h3>
                <div class="calc-grid">
                    <div>
                        <label>Put Volume</label>
                        <input type="number" id="putVol" class="calc-input" value="150000">
                    </div>
                    <div>
                        <label>Call Volume</label>
                        <input type="number" id="callVol" class="calc-input" value="100000">
                    </div>
                </div>
                <button class="calc-btn" onclick="analyzePCRatio()">Analyze Signal</button>
                <div id="pcResult" class="calc-result" style="display: none;"></div>
            </div>

            <div class="calculator-section">
                <h3>Historical P/C Percentile</h3>
                <div class="calc-grid">
                    <div>
                        <label>Current P/C Ratio</label>
                        <input type="number" id="currPC" class="calc-input" value="1.25" step="0.01">
                    </div>
                    <div>
                        <label>1-Year Average P/C</label>
                        <input type="number" id="avgPC" class="calc-input" value="0.85" step="0.01">
                    </div>
                    <div>
                        <label>1-Year Low P/C</label>
                        <input type="number" id="lowPC" class="calc-input" value="0.45" step="0.01">
                    </div>
                    <div>
                        <label>1-Year High P/C</label>
                        <input type="number" id="highPC" class="calc-input" value="1.85" step="0.01">
                    </div>
                </div>
                <button class="calc-btn" onclick="calculatePCPercentile()">Calculate Percentile</button>
                <div id="percentileResult" class="calc-result" style="display: none;"></div>
            </div>
        </section>

        <!-- CHARTS -->
        <section class="content-section fade-in">
            <h2>Visualizations</h2>

            <div class="chart-container">
                <h3>P/C Ratio History with Signals</h3>
                <canvas id="pcHistoryChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>P/C vs SPY Price (Contrarian Relationship)</h3>
                <canvas id="pcVsSpyChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>P/C Ratio Distribution</h3>
                <canvas id="pcDistributionChart"></canvas>
            </div>
        </section>

        <!-- QUIZ -->
        <section class="content-section fade-in">
            <h2>Knowledge Check</h2>

            <div class="quiz-container" id="quiz">
                <div class="quiz-question" data-question="1">
                    <h4>Question 1: A P/C ratio of 1.8 indicates:</h4>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">Extreme bullishness - sell signal</div>
                        <div class="quiz-option" data-correct="true">Extreme bearishness - contrarian buy signal</div>
                        <div class="quiz-option" data-correct="false">Neutral sentiment</div>
                        <div class="quiz-option" data-correct="false">Options are overpriced</div>
                    </div>
                    <div class="quiz-feedback"></div>
                </div>

                <div class="quiz-question" data-question="2">
                    <h4>Question 2: Why does the contrarian P/C strategy work?</h4>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">Because options traders are always right</div>
                        <div class="quiz-option" data-correct="true">At extremes, positioning is exhausted - no one left to buy/sell</div>
                        <div class="quiz-option" data-correct="false">Because the Fed watches P/C ratios</div>
                        <div class="quiz-option" data-correct="false">It doesn't work - it's random</div>
                    </div>
                    <div class="quiz-feedback"></div>
                </div>

                <div class="quiz-question" data-question="3">
                    <h4>Question 3: What is the difference between Equity P/C and Index P/C?</h4>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">They are the same thing</div>
                        <div class="quiz-option" data-correct="true">Equity = individual stocks, Index = SPX/NDX (institutional hedging)</div>
                        <div class="quiz-option" data-correct="false">Index is always higher than Equity</div>
                        <div class="quiz-option" data-correct="false">Equity is for long-term, Index is for short-term</div>
                    </div>
                    <div class="quiz-feedback"></div>
                </div>

                <div class="quiz-question" data-question="4">
                    <h4>Question 4: When should you NOT trade a P/C signal?</h4>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">When P/C is at extreme levels</div>
                        <div class="quiz-option" data-correct="true">When P/C is in the neutral range (0.7-1.0)</div>
                        <div class="quiz-option" data-correct="false">When VIX confirms the signal</div>
                        <div class="quiz-option" data-correct="false">When technicals align</div>
                    </div>
                    <div class="quiz-feedback"></div>
                </div>

                <div class="quiz-question" data-question="5">
                    <h4>Question 5: P/C Percentile of 95% means:</h4>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">P/C ratio is 0.95</div>
                        <div class="quiz-option" data-correct="false">95% of options are puts</div>
                        <div class="quiz-option" data-correct="true">Current P/C is higher than 95% of historical readings - rare extreme</div>
                        <div class="quiz-option" data-correct="false">95% chance of market going up</div>
                    </div>
                    <div class="quiz-feedback"></div>
                </div>
            </div>

            <div class="quiz-score" id="quizScore" style="display: none;">
                <h3>Quiz Complete!</h3>
                <p>Your score: <span id="scoreValue"></span>/5</p>
            </div>
        </section>

        <!-- Navigation -->
        <div class="module-navigation">
            <a href="8.1.2_implied_volatility_fear_gauge.html" class="nav-btn">‚Üê Previous: Implied Volatility</a>
            <a href="8.1.4_open_interest_analysis.html" class="nav-btn">Next: Open Interest ‚Üí</a>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
        // Copy code functionality
        function copyCode(button) {
            const codeBlock = button.parentElement.nextElementSibling.querySelector('code');
            navigator.clipboard.writeText(codeBlock.textContent);
            button.textContent = 'Copied!';
            setTimeout(() => button.textContent = 'Copy', 2000);
        }

        // P/C Ratio Analyzer
        function analyzePCRatio() {
            const putVol = parseInt(document.getElementById('putVol').value);
            const callVol = parseInt(document.getElementById('callVol').value);
            const pcRatio = (putVol / callVol).toFixed(3);

            let sentiment, signal, color, recommendation;

            if (pcRatio >= 1.5) {
                sentiment = 'Extreme Fear';
                signal = 'STRONG BUY';
                color = '#10b981';
                recommendation = 'Excellent contrarian entry. Aggressively accumulate quality longs.';
            } else if (pcRatio >= 1.0) {
                sentiment = 'Fear';
                signal = 'BUY';
                color = '#10b981';
                recommendation = 'Elevated fear. Look for long entry setups.';
            } else if (pcRatio >= 0.7) {
                sentiment = 'Neutral';
                signal = 'NEUTRAL';
                color = '#f59e0b';
                recommendation = 'No P/C signal. Use other indicators.';
            } else if (pcRatio >= 0.5) {
                sentiment = 'Greed';
                signal = 'CAUTION';
                color = '#ef4444';
                recommendation = 'Elevated greed. Be selective, tighten stops.';
            } else {
                sentiment = 'Extreme Greed';
                signal = 'AVOID LONGS';
                color = '#ef4444';
                recommendation = 'Extreme complacency. Reduce long exposure.';
            }

            // Update gauge
            const gaugePosition = Math.min(95, Math.max(5, (pcRatio / 2) * 100));
            document.getElementById('pcMarker').style.left = gaugePosition + '%';
            document.getElementById('currentPC').textContent = pcRatio;
            document.getElementById('pcInterpretation').textContent = sentiment;

            const resultDiv = document.getElementById('pcResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h4 style="color: ${color};">Signal: ${signal}</h4>
                <p><strong>P/C Ratio:</strong> ${pcRatio}</p>
                <p><strong>Crowd Sentiment:</strong> ${sentiment}</p>
                <p><strong>Put Volume:</strong> ${putVol.toLocaleString()}</p>
                <p><strong>Call Volume:</strong> ${callVol.toLocaleString()}</p>
                <p style="margin-top: 10px;"><strong>Recommendation:</strong> ${recommendation}</p>
            `;
        }

        // P/C Percentile Calculator
        function calculatePCPercentile() {
            const currPC = parseFloat(document.getElementById('currPC').value);
            const avgPC = parseFloat(document.getElementById('avgPC').value);
            const lowPC = parseFloat(document.getElementById('lowPC').value);
            const highPC = parseFloat(document.getElementById('highPC').value);

            // Calculate rank
            const rank = ((currPC - lowPC) / (highPC - lowPC) * 100).toFixed(1);

            // Estimate percentile (simplified)
            const percentile = Math.min(99, Math.max(1, rank * 1.1)).toFixed(1);

            // Deviation from average
            const deviation = ((currPC - avgPC) / avgPC * 100).toFixed(1);

            let interpretation, color;
            if (percentile > 90) {
                interpretation = 'EXTREME FEAR - Strong contrarian buy';
                color = '#10b981';
            } else if (percentile > 75) {
                interpretation = 'Elevated fear - Bullish bias';
                color = '#10b981';
            } else if (percentile > 25) {
                interpretation = 'Normal range - No signal';
                color = '#f59e0b';
            } else if (percentile > 10) {
                interpretation = 'Low fear - Caution';
                color = '#ef4444';
            } else {
                interpretation = 'EXTREME GREED - Avoid new longs';
                color = '#ef4444';
            }

            const resultDiv = document.getElementById('percentileResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h4 style="color: ${color};">${interpretation}</h4>
                <p><strong>P/C Rank:</strong> ${rank}%</p>
                <p><strong>P/C Percentile (est):</strong> ${percentile}%</p>
                <p><strong>Deviation from Average:</strong> ${deviation > 0 ? '+' : ''}${deviation}%</p>
                <p style="margin-top: 10px; color: #94a3b8;">
                    <em>Current P/C of ${currPC} is ${deviation > 0 ? 'above' : 'below'} the historical average of ${avgPC}</em>
                </p>
            `;
        }

        // Charts
        document.addEventListener('DOMContentLoaded', function() {
            // P/C History Chart
            const historyCtx = document.getElementById('pcHistoryChart').getContext('2d');
            new Chart(historyCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'P/C Ratio',
                        data: [0.75, 0.82, 1.45, 0.95, 0.68, 0.72, 0.88, 0.92, 1.15, 1.82, 1.05, 0.78],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } },
                        title: { display: true, text: 'CBOE Total P/C Ratio (2024)', color: '#f1f5f9' },
                        annotation: {
                            annotations: {
                                buyLine: {
                                    type: 'line',
                                    yMin: 1.5,
                                    yMax: 1.5,
                                    borderColor: '#10b981',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                sellLine: {
                                    type: 'line',
                                    yMin: 0.6,
                                    yMax: 0.6,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0.4,
                            max: 2.0,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            // P/C vs SPY Chart
            const vsSpyCtx = document.getElementById('pcVsSpyChart').getContext('2d');
            new Chart(vsSpyCtx, {
                type: 'line',
                data: {
                    labels: ['Sep 1', 'Sep 15', 'Oct 1', 'Oct 15', 'Nov 1', 'Nov 15', 'Dec 1'],
                    datasets: [
                        {
                            label: 'P/C Ratio',
                            data: [0.95, 1.15, 1.45, 1.82, 1.25, 0.95, 0.78],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'transparent',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'SPY Price',
                            data: [380, 365, 358, 348, 375, 392, 405],
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } },
                        title: { display: true, text: 'P/C Peaks as SPY Bottoms (Oct 2022)', color: '#f1f5f9' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#8b5cf6' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            title: { display: true, text: 'P/C Ratio', color: '#8b5cf6' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#10b981' },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'SPY Price', color: '#10b981' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            // P/C Distribution Chart
            const distCtx = document.getElementById('pcDistributionChart').getContext('2d');
            new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: ['<0.5', '0.5-0.7', '0.7-0.9', '0.9-1.1', '1.1-1.3', '1.3-1.5', '>1.5'],
                    datasets: [{
                        label: 'Frequency (%)',
                        data: [3, 12, 35, 28, 14, 5, 3],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(245, 158, 11, 0.6)',
                            'rgba(245, 158, 11, 0.4)',
                            'rgba(16, 185, 129, 0.4)',
                            'rgba(16, 185, 129, 0.6)',
                            'rgba(16, 185, 129, 0.8)'
                        ],
                        borderColor: ['#ef4444', '#f59e0b', '#f59e0b', '#f59e0b', '#10b981', '#10b981', '#10b981'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'P/C Ratio Distribution (Extremes are Rare)', color: '#f1f5f9' }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', callback: v => v + '%' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        });

        // Quiz functionality
        document.querySelectorAll('.quiz-option').forEach(option => {
            option.addEventListener('click', function() {
                const question = this.closest('.quiz-question');
                const options = question.querySelectorAll('.quiz-option');
                const feedback = question.querySelector('.quiz-feedback');

                if (question.classList.contains('answered')) return;

                question.classList.add('answered');
                options.forEach(opt => opt.style.pointerEvents = 'none');

                const isCorrect = this.dataset.correct === 'true';
                this.classList.add(isCorrect ? 'correct' : 'incorrect');

                if (!isCorrect) {
                    options.forEach(opt => {
                        if (opt.dataset.correct === 'true') opt.classList.add('correct');
                    });
                }

                feedback.textContent = isCorrect ? 'Correct!' : 'Incorrect. See the correct answer above.';
                feedback.style.color = isCorrect ? '#10b981' : '#ef4444';
                feedback.style.display = 'block';

                checkQuizComplete();
            });
        });

        function checkQuizComplete() {
            const questions = document.querySelectorAll('.quiz-question');
            const answered = document.querySelectorAll('.quiz-question.answered');

            if (questions.length === answered.length) {
                const correct = document.querySelectorAll('.quiz-option.correct:not(.incorrect)').length;
                document.getElementById('scoreValue').textContent = correct;
                document.getElementById('quizScore').style.display = 'block';
            }
        }

        // Scroll animations
        const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));
    </script>
</body>
</html>
