<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Combine dark pool stock prints with options flow for the strongest institutional signals. Learn confluence detection for high-probability stock trades.">
    <title>8.3.3 Dark Pool + Options Confluence | Quantitative Trading Mastery</title>
    <link rel="stylesheet" href="../../../assets/css/shared-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="icon" href="../../../assets/images/logo.png" type="image/png">
    <style>
        .conf-eq { font-size: 1.4rem; color: #f59e0b; text-align: center; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; margin: 20px 0; border: 1px solid rgba(245, 158, 11, 0.3); }
        .metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .metric-card { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid rgba(148, 163, 184, 0.1); }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #f59e0b; }
        .metric-label { font-size: 0.85rem; color: #94a3b8; margin-top: 5px; }
        .conf-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem; }
        .conf-table th, .conf-table td { padding: 12px; border: 1px solid rgba(148, 163, 184, 0.2); text-align: center; }
        .conf-table th { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .conf-table tr:hover { background: rgba(245, 158, 11, 0.1); }
        .signal-strong { color: #10b981; font-weight: bold; }
        .signal-weak { color: #ef4444; font-weight: bold; }
        .zone-card { padding: 20px; border-radius: 12px; margin: 10px 0; }
        .zone-confluence { background: rgba(16, 185, 129, 0.15); border: 2px solid #10b981; }
        .zone-divergence { background: rgba(239, 68, 68, 0.15); border: 2px solid #ef4444; }
        .calculator-section { background: rgba(0,0,0,0.3); border-radius: 16px; padding: 25px; margin: 25px 0; border: 1px solid rgba(245, 158, 11, 0.3); }
        .calc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; }
        .calc-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; padding: 12px; color: #f1f5f9; width: 100%; }
        .calc-input:focus { outline: none; border-color: #f59e0b; }
        .calc-btn { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .calc-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); }
        .calc-result { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px; }
        .chart-container { position: relative; height: 400px; }
        .chart-container canvas { max-height: 350px; }
        @media (max-width: 768px) { .metric-grid { grid-template-columns: repeat(2, 1fr); } .calc-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="module-nav-header"><div class="container"><div class="nav-content">
        <a href="../../../index.html" class="nav-home">‚Üê Back to Course</a>
        <div class="nav-module-info"><span class="nav-module-number">Module 8.3.3</span><span class="nav-module-title">Dark Pool + Options Confluence</span></div>
        <a href="8.3.4_volatility_skew_crash_indicator.html" class="nav-next">Next Module ‚Üí</a>
    </div></div></nav>

    <header class="module-hero"><div class="container"><div class="module-hero-content">
        <div class="module-breadcrumb"><span>Module 8: Options Market Intelligence</span><span class="breadcrumb-separator">‚Ä∫</span><span>8.3 Flow Analysis</span><span class="breadcrumb-separator">‚Ä∫</span><span>8.3.3 Dark Pool + Options Confluence</span></div>
        <h1>Dark Pool + Options Flow Confluence</h1>
        <p class="module-subtitle">When large dark pool stock prints align with unusual options activity, you have the strongest institutional signal available. This confluence gives you the highest-probability trades.</p>
        <div class="module-meta"><span class="meta-item">‚è±Ô∏è 50 min read</span><span class="meta-item">üìä 3 Visualizations</span><span class="meta-item">üíª Confluence Detector</span><span class="meta-item">‚úÖ 5 Quiz Questions</span></div>
    </div></div></header>

    <main class="container content-wrapper">
        <section class="content-section fade-in">
            <h2>Part 1: Why Should I Care?</h2>
            <div class="info-box info-box-warning"><div class="info-box-title">The Strongest Signal in Markets</div>
            <p>A hedge fund buys 500,000 shares of TSLA on a dark pool (hidden from public exchanges). Simultaneously, unusual call buying appears&mdash;$3M in aggressive call sweeps. This is <strong>confluence</strong>: the institution is building a massive long position in both stock AND options. When dark pool and options flow agree, the probability of a significant stock move is <strong>75%+ within 5 days</strong>. This is the strongest signal available to stock traders.</p></div>
            <div class="conf-eq">Dark Pool Buying + Call Flow = STRONG BULLISH Confluence (75%+ Win Rate)</div>
            <div class="card-grid">
                <div class="card"><h4>What Are Dark Pools?</h4><p>Private exchanges where institutions trade large stock blocks without moving the public market. ~40% of US equity volume goes through dark pools.</p></div>
                <div class="card"><h4>Why Confluence Matters</h4><p>A single signal can be misleading. When TWO independent signals agree (dark pool + options), the probability of a correct prediction increases dramatically.</p></div>
                <div class="card"><h4>Institutional Footprint</h4><p>When institutions build positions, they use both dark pools (stock) and options markets. Both leave traces. Together, they reveal the full picture.</p></div>
                <div class="card"><h4>Timing Edge</h4><p>Dark pool prints + options flow typically lead stock moves by 1-5 days. This gives you a real-time early warning system.</p></div>
            </div>
            <div class="metric-grid">
                <div class="metric-card"><div class="metric-value">75%+</div><div class="metric-label">Confluence Win Rate</div></div>
                <div class="metric-card"><div class="metric-value">40%</div><div class="metric-label">Volume via Dark Pools</div></div>
                <div class="metric-card"><div class="metric-value">1-5 Days</div><div class="metric-label">Lead Time</div></div>
                <div class="metric-card"><div class="metric-value">2x</div><div class="metric-label">Signal vs Single</div></div>
            </div>
        </section>

        <section class="content-section fade-in">
            <h2>Part 2: Building Intuition</h2>
            <h3>Dark Pool Basics</h3>
            <p>Dark pools are off-exchange venues where large institutions trade blocks of stock without showing their orders to the public market. When a pension fund needs to buy 1 million shares of AAPL, doing it on NYSE would move the price against them. Instead, they execute on a dark pool where the order is hidden until filled. After execution, the trade is reported &mdash; this is the &ldquo;dark pool print&rdquo; that we can track.</p>

            <h3>Confluence Scenarios</h3>
            <div class="zone-card zone-confluence">
                <h4>BULLISH Confluence (Strongest Buy Signal)</h4>
                <p><strong>Dark Pool:</strong> Large block purchases (above average volume, above VWAP)</p>
                <p><strong>Options:</strong> Aggressive call buying, sweeps, $1M+ premium</p>
                <p><strong>Interpretation:</strong> Institution loading stock AND calls. Maximum bullish conviction.</p>
                <p><strong>Action:</strong> Add to long watchlist. Enter on technical confirmation. Full size.</p>
            </div>
            <div class="zone-card zone-divergence">
                <h4>BEARISH Confluence (Strongest Sell Signal)</h4>
                <p><strong>Dark Pool:</strong> Large block sales (below VWAP, net selling)</p>
                <p><strong>Options:</strong> Aggressive put buying or call selling</p>
                <p><strong>Interpretation:</strong> Institution dumping stock AND buying protection. Maximum bearish conviction.</p>
                <p><strong>Action:</strong> Exit longs. Consider shorts. Hedge portfolio.</p>
            </div>

            <div style="margin: 30px 0;">
                <svg viewBox="0 0 800 260" style="width: 100%; max-width: 800px; display: block; margin: 0 auto;">
                    <text x="400" y="30" text-anchor="middle" fill="#f59e0b" font-size="16" font-weight="bold">CONFLUENCE DETECTION</text>
                    <rect x="30" y="50" width="200" height="80" rx="12" fill="rgba(99, 102, 241, 0.15)" stroke="#6366f1" stroke-width="2"/>
                    <text x="130" y="80" text-anchor="middle" fill="#a5b4fc" font-size="13" font-weight="bold">Dark Pool Data</text>
                    <text x="130" y="100" text-anchor="middle" fill="#94a3b8" font-size="10">Block prints, net buying</text>
                    <text x="130" y="115" text-anchor="middle" fill="#94a3b8" font-size="10">Volume, VWAP relationship</text>
                    <rect x="300" y="50" width="200" height="80" rx="12" fill="rgba(16, 185, 129, 0.15)" stroke="#10b981" stroke-width="2"/>
                    <text x="400" y="80" text-anchor="middle" fill="#10b981" font-size="13" font-weight="bold">Options Flow</text>
                    <text x="400" y="100" text-anchor="middle" fill="#94a3b8" font-size="10">UOA, sweeps, premium</text>
                    <text x="400" y="115" text-anchor="middle" fill="#94a3b8" font-size="10">Aggressiveness, DTE</text>
                    <line x1="230" y1="90" x2="300" y2="90" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowC)"/>
                    <line x1="500" y1="90" x2="570" y2="160" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowC)"/>
                    <line x1="230" y1="130" x2="230" y2="160" stroke="#f59e0b" stroke-width="2"/>
                    <line x1="230" y1="160" x2="570" y2="160" stroke="#f59e0b" stroke-width="2"/>
                    <rect x="570" y="130" width="210" height="80" rx="12" fill="rgba(245, 158, 11, 0.2)" stroke="#f59e0b" stroke-width="2"/>
                    <text x="675" y="158" text-anchor="middle" fill="#f59e0b" font-size="14" font-weight="bold">CONFLUENCE?</text>
                    <text x="675" y="178" text-anchor="middle" fill="#10b981" font-size="11">Both Bullish ‚Üí BUY</text>
                    <text x="675" y="195" text-anchor="middle" fill="#ef4444" font-size="11">Both Bearish ‚Üí SELL</text>
                    <defs><marker id="arrowC" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/></marker></defs>
                </svg>
            </div>
        </section>

        <section class="content-section fade-in">
            <h2>Part 3: The Mathematics</h2>
            <h3>Confluence Score</h3>
            <div class="conf-eq">Confluence Score = Dark Pool Score &times; Options Flow Score &times; Timing Multiplier</div>
            <table class="conf-table">
                <thead><tr><th>Component</th><th>Metric</th><th>Score</th></tr></thead>
                <tbody>
                    <tr><td rowspan="3"><strong>Dark Pool</strong></td><td>Net buying &gt; 2x avg volume</td><td class="signal-strong">+3</td></tr>
                    <tr><td>Prints above VWAP (bullish)</td><td class="signal-strong">+2</td></tr>
                    <tr><td>Net selling &gt; 2x avg volume</td><td class="signal-weak">-3</td></tr>
                    <tr><td rowspan="3"><strong>Options Flow</strong></td><td>Aggressive calls &gt;$1M</td><td class="signal-strong">+3</td></tr>
                    <tr><td>Call sweeps detected</td><td class="signal-strong">+2</td></tr>
                    <tr><td>Aggressive puts &gt;$1M</td><td class="signal-weak">-3</td></tr>
                    <tr><td rowspan="2"><strong>Timing</strong></td><td>Same day (strongest)</td><td>&times;2.0</td></tr>
                    <tr><td>Within 3 days</td><td>&times;1.5</td></tr>
                </tbody>
            </table>
            <div class="info-box"><div class="info-box-title">Example: TSLA Confluence</div>
            <p><strong>Dark Pool:</strong> 800K shares bought, 2.5x avg, above VWAP ‚Üí Score: +5<br>
            <strong>Options:</strong> $3M call sweeps, 90% aggressive ‚Üí Score: +5<br>
            <strong>Timing:</strong> Same day ‚Üí Multiplier: 2.0<br>
            <strong>Confluence Score:</strong> (5 + 5) &times; 2.0 = <span class="signal-strong">20.0 (VERY STRONG BULLISH)</span></p></div>
        </section>

        <section class="content-section fade-in">
            <h2>Part 4: Complete Numerical Example</h2>
            <div class="info-box"><div class="info-box-title">Scenario: NVDA Institutional Accumulation</div><p>NVDA trading at $450. Analyzing 3-day window for confluence.</p></div>
            <table class="conf-table">
                <thead><tr><th>Day</th><th>Dark Pool</th><th>Options Flow</th><th>Confluence?</th></tr></thead>
                <tbody>
                    <tr><td>Monday</td><td>1.2M shares bought, above VWAP</td><td>$2M call sweep at $460, 14 DTE</td><td class="signal-strong">STRONG BULLISH</td></tr>
                    <tr><td>Tuesday</td><td>800K shares bought, above VWAP</td><td>$1.5M call block at $465, 30 DTE</td><td class="signal-strong">BULLISH CONFIRMED</td></tr>
                    <tr><td>Wednesday</td><td>500K shares, at VWAP</td><td>Normal volume, no unusual</td><td>Neutral (position built)</td></tr>
                </tbody>
            </table>
            <p><strong>Result:</strong> NVDA rallied from $450 to $480 over the next 7 trading days (+6.7%). The confluence signal identified institutional accumulation before the move.</p>
            <div class="chart-container"><canvas id="confluenceChart"></canvas></div>
        </section>

        <section class="content-section fade-in">
            <h2>Part 5: Python Implementation</h2>
            <div class="code-block">
                <div class="code-header"><span>confluence_detector.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
                <pre><code class="language-python">import pandas as pd
import numpy as np
from typing import Dict, List, Optional
from dataclasses import dataclass
from datetime import datetime, timedelta
from enum import Enum


class ConfluenceSignal(Enum):
    """Confluence signal classification."""
    STRONG_BULLISH = "STRONG_BULLISH"
    BULLISH = "BULLISH"
    NEUTRAL = "NEUTRAL"
    BEARISH = "BEARISH"
    STRONG_BEARISH = "STRONG_BEARISH"


@dataclass
class DarkPoolPrint:
    """Dark pool trade data."""
    symbol: str
    timestamp: datetime
    shares: int
    price: float
    vwap: float
    avg_daily_volume: int


@dataclass
class OptionsFlowData:
    """Options flow summary data."""
    symbol: str
    timestamp: datetime
    net_call_premium: float   # Net aggressive call premium
    net_put_premium: float    # Net aggressive put premium
    has_sweeps: bool
    largest_trade: float      # Largest single premium


@dataclass
class ConfluenceResult:
    """Confluence analysis result."""
    dark_pool_score: float
    options_score: float
    timing_multiplier: float
    confluence_score: float
    signal: ConfluenceSignal
    confidence: str
    recommendation: str


def score_dark_pool(
    prints: List[DarkPoolPrint],
) -> float:
    """
    Score dark pool activity for a symbol.

    Parameters
    ----------
    prints : List[DarkPoolPrint]
        Dark pool prints for the period

    Returns
    -------
    float
        Dark pool score (-5 to +5)
    """
    if not prints:
        return 0.0

    total_shares = sum(p.shares for p in prints)
    avg_vol = prints[0].avg_daily_volume

    # Volume significance
    vol_ratio = total_shares / avg_vol if avg_vol > 0 else 0
    vol_score = min(3, vol_ratio)  # Cap at 3

    # Price vs VWAP (above VWAP = bullish accumulation)
    above_vwap = sum(p.shares for p in prints if p.price >= p.vwap)
    below_vwap = sum(p.shares for p in prints if p.price < p.vwap)

    if above_vwap > below_vwap * 1.5:
        direction_score = 2.0
    elif above_vwap > below_vwap:
        direction_score = 1.0
    elif below_vwap > above_vwap * 1.5:
        direction_score = -2.0
    elif below_vwap > above_vwap:
        direction_score = -1.0
    else:
        direction_score = 0.0

    return round(vol_score * (1 if direction_score >= 0 else -1)
                 + direction_score, 2)


def score_options_flow(flow: OptionsFlowData) -> float:
    """
    Score options flow activity.

    Parameters
    ----------
    flow : OptionsFlowData
        Options flow summary

    Returns
    -------
    float
        Options flow score (-5 to +5)
    """
    score = 0.0

    net_premium = flow.net_call_premium - flow.net_put_premium

    if net_premium > 1_000_000:
        score += 3.0
    elif net_premium > 500_000:
        score += 2.0
    elif net_premium > 0:
        score += 1.0
    elif net_premium < -1_000_000:
        score -= 3.0
    elif net_premium < -500_000:
        score -= 2.0
    elif net_premium < 0:
        score -= 1.0

    if flow.has_sweeps:
        score += 2.0 if net_premium > 0 else -2.0

    return max(-5, min(5, score))


def detect_confluence(
    dark_pool_prints: List[DarkPoolPrint],
    options_flow: List[OptionsFlowData],
    max_days_apart: int = 3
) -> ConfluenceResult:
    """
    Detect confluence between dark pool and options flow.

    Parameters
    ----------
    dark_pool_prints : List[DarkPoolPrint]
        Dark pool prints for the symbol
    options_flow : List[OptionsFlowData]
        Options flow data for the symbol
    max_days_apart : int
        Maximum days between signals for confluence

    Returns
    -------
    ConfluenceResult
        Complete confluence analysis
    """
    dp_score = score_dark_pool(dark_pool_prints)
    opt_score = score_options_flow(options_flow[0]) if options_flow else 0

    # Timing multiplier
    if dark_pool_prints and options_flow:
        dp_date = dark_pool_prints[0].timestamp.date()
        opt_date = options_flow[0].timestamp.date()
        days_apart = abs((dp_date - opt_date).days)
        if days_apart == 0:
            timing_mult = 2.0
        elif days_apart <= 1:
            timing_mult = 1.75
        elif days_apart <= max_days_apart:
            timing_mult = 1.5
        else:
            timing_mult = 1.0
    else:
        timing_mult = 1.0

    # Confluence score
    same_direction = (dp_score > 0 and opt_score > 0) or \
                     (dp_score < 0 and opt_score < 0)
    if same_direction:
        confluence = (abs(dp_score) + abs(opt_score)) * timing_mult
        if dp_score < 0:
            confluence = -confluence
    else:
        confluence = 0.0

    # Signal classification
    if confluence >= 12:
        signal = ConfluenceSignal.STRONG_BULLISH
        confidence = "VERY HIGH"
        rec = "Strong buy signal. Full position. Stop below support."
    elif confluence >= 6:
        signal = ConfluenceSignal.BULLISH
        confidence = "HIGH"
        rec = "Bullish. Add to watchlist. Enter on confirmation."
    elif confluence <= -12:
        signal = ConfluenceSignal.STRONG_BEARISH
        confidence = "VERY HIGH"
        rec = "Strong sell signal. Exit longs. Consider shorts."
    elif confluence <= -6:
        signal = ConfluenceSignal.BEARISH
        confidence = "HIGH"
        rec = "Bearish. Reduce long exposure. Tighten stops."
    else:
        signal = ConfluenceSignal.NEUTRAL
        confidence = "LOW"
        rec = "No clear confluence. Wait for alignment."

    return ConfluenceResult(
        dark_pool_score=dp_score,
        options_score=opt_score,
        timing_multiplier=timing_mult,
        confluence_score=round(confluence, 2),
        signal=signal,
        confidence=confidence,
        recommendation=rec
    )


# ‚îÄ‚îÄ‚îÄ EXAMPLE USAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if __name__ == "__main__":
    dp_prints = [
        DarkPoolPrint("TSLA", datetime(2024,1,15,10,0),
                      500000, 243, 241, 5000000),
        DarkPoolPrint("TSLA", datetime(2024,1,15,14,0),
                      300000, 244, 242, 5000000),
    ]

    opt_flow = [OptionsFlowData(
        "TSLA", datetime(2024,1,15,10,30),
        net_call_premium=3_000_000,
        net_put_premium=500_000,
        has_sweeps=True,
        largest_trade=1_500_000
    )]

    result = detect_confluence(dp_prints, opt_flow)
    print("‚ïê‚ïê‚ïê TSLA Confluence Analysis ‚ïê‚ïê‚ïê")
    print(f"  Dark Pool Score : {result.dark_pool_score}")
    print(f"  Options Score   : {result.options_score}")
    print(f"  Timing Mult     : {result.timing_multiplier}x")
    print(f"  Confluence      : {result.confluence_score}")
    print(f"  Signal          : {result.signal.value}")
    print(f"  Confidence      : {result.confidence}")
    print(f"  Action          : {result.recommendation}")</code></pre>
            </div>
        </section>

        <section class="content-section fade-in">
            <h2>Part 6: Trading Applications</h2>
            <div class="card-grid">
                <div class="card"><h4>1. Daily Confluence Scan</h4><p>Each morning, cross-reference yesterday's dark pool prints with options flow. Stocks appearing in BOTH lists with same direction = highest priority watchlist.</p></div>
                <div class="card"><h4>2. Entry Trigger</h4><p>Confluence identifies the stock. Technicals determine the entry. Wait for a breakout, pullback to support, or volume confirmation before entering.</p></div>
                <div class="card"><h4>3. Position Sizing</h4><p>Strong confluence (score 12+) = full size. Moderate confluence (6-12) = 70% size. No confluence = standard size or wait.</p></div>
                <div class="card"><h4>4. Exit Warning</h4><p>If you're long and bearish confluence appears (dark pool selling + put buying), tighten stops or exit. Don't wait for the price to confirm.</p></div>
            </div>
            <div class="chart-container"><canvas id="winRateChart"></canvas></div>
        </section>

        <section class="content-section fade-in">
            <h2>Part 7: Common Mistakes</h2>
            <table class="conf-table">
                <thead><tr><th style="width:45%">&#10060; Mistake</th><th style="width:55%">&#9989; Correct Approach</th></tr></thead>
                <tbody>
                    <tr><td>Using dark pool data alone</td><td>Dark pool prints can be hedges or closing trades. Always combine with options flow for direction confirmation.</td></tr>
                    <tr><td>Ignoring timing between signals</td><td>Same-day confluence is strongest. Signals 5+ days apart are weak. Apply timing multiplier.</td></tr>
                    <tr><td>Trading small-cap dark pool data</td><td>Dark pool data is most reliable for liquid stocks (SPY, QQQ, mega-caps). Small caps have too little dark pool activity.</td></tr>
                    <tr><td>Not checking VWAP relationship</td><td>Dark pool buys ABOVE VWAP = accumulation (bullish). Below VWAP = possible forced selling (less bullish).</td></tr>
                </tbody>
            </table>
        </section>

        <section class="content-section fade-in">
            <h2>Part 8: Summary &amp; Cheat Sheet</h2>
            <div class="conf-eq">Bullish Confluence: DP Buying (above VWAP) + Call Flow ($1M+) = 75%+ Win Rate</div>
            <div class="zone-card zone-confluence"><h4>BULLISH Confluence</h4><p>Dark pool net buying + aggressive call flow + same day = STRONG BUY. Enter on technical confirmation. Full size.</p></div>
            <div class="zone-card zone-divergence"><h4>BEARISH Confluence</h4><p>Dark pool net selling + aggressive put flow + same day = STRONG SELL. Exit longs. Consider shorts. Hedge.</p></div>
            <div class="card-grid">
                <div class="card"><h4>Two Sources &gt; One</h4><p>A single signal (dark pool OR options) can be misleading. When both agree, probability increases significantly.</p></div>
                <div class="card"><h4>Timing Is Critical</h4><p>Same-day confluence = 2x weight. Within 3 days = 1.5x. Beyond 3 days = weak or coincidental.</p></div>
            </div>
        </section>

        <section class="content-section fade-in">
            <h2>Interactive Confluence Detector</h2>
            <div class="calculator-section">
                <h3>Dark Pool + Options Confluence</h3>
                <div class="calc-grid">
                    <div><label style="color: #94a3b8; font-size: 0.9rem;">DP Shares Traded</label><input type="number" id="dpShares" class="calc-input" value="800000"></div>
                    <div><label style="color: #94a3b8; font-size: 0.9rem;">Avg Daily Volume</label><input type="number" id="dpAvgVol" class="calc-input" value="5000000"></div>
                    <div><label style="color: #94a3b8; font-size: 0.9rem;">DP Price vs VWAP</label>
                        <select id="dpVwap" class="calc-input"><option value="above">Above VWAP (Bullish)</option><option value="at">At VWAP (Neutral)</option><option value="below">Below VWAP (Bearish)</option></select></div>
                    <div><label style="color: #94a3b8; font-size: 0.9rem;">Net Call Premium ($)</label><input type="number" id="confCallPrem" class="calc-input" value="2000000"></div>
                    <div><label style="color: #94a3b8; font-size: 0.9rem;">Net Put Premium ($)</label><input type="number" id="confPutPrem" class="calc-input" value="300000"></div>
                    <div><label style="color: #94a3b8; font-size: 0.9rem;">Sweeps Detected?</label>
                        <select id="confSweeps" class="calc-input"><option value="yes">Yes</option><option value="no">No</option></select></div>
                    <div><label style="color: #94a3b8; font-size: 0.9rem;">Days Apart</label><input type="number" id="confDays" class="calc-input" value="0"></div>
                </div>
                <button class="calc-btn" onclick="detectConf()">Detect Confluence</button>
                <div class="calc-result" id="confResult" style="display: none;"></div>
            </div>
        </section>

        <section class="content-section fade-in"><h2>Confluence Signal Timeline</h2><div class="chart-container"><canvas id="timelineChart"></canvas></div></section>

        <section class="content-section fade-in">
            <h2>Knowledge Check</h2>
            <div class="quiz-question" id="q1"><h4>Q1: What makes confluence signals stronger than single signals?</h4>
                <div class="quiz-option" data-correct="true">Two independent data sources (dark pool + options) confirming the same direction increases probability</div>
                <div class="quiz-option" data-correct="false">Confluence signals are always correct</div>
                <div class="quiz-option" data-correct="false">Dark pool data is more accurate than options data</div>
                <div class="quiz-option" data-correct="false">Confluence only works for bullish signals</div><div class="quiz-feedback"></div></div>
            <div class="quiz-question" id="q2"><h4>Q2: Why does dark pool buying ABOVE VWAP matter?</h4>
                <div class="quiz-option" data-correct="false">VWAP is irrelevant for dark pool analysis</div>
                <div class="quiz-option" data-correct="true">Buying above VWAP indicates willingness to pay premium prices ‚Äî bullish accumulation</div>
                <div class="quiz-option" data-correct="false">All dark pool trades happen at VWAP</div>
                <div class="quiz-option" data-correct="false">Buying below VWAP is more bullish</div><div class="quiz-feedback"></div></div>
            <div class="quiz-question" id="q3"><h4>Q3: Same-day confluence gets a timing multiplier of:</h4>
                <div class="quiz-option" data-correct="true">2.0x (strongest weighting)</div>
                <div class="quiz-option" data-correct="false">1.0x (no bonus)</div>
                <div class="quiz-option" data-correct="false">0.5x (reduced because too fast)</div>
                <div class="quiz-option" data-correct="false">3.0x (triple weight)</div><div class="quiz-feedback"></div></div>
            <div class="quiz-question" id="q4"><h4>Q4: You see dark pool selling + aggressive put buying on AAPL. What should you do?</h4>
                <div class="quiz-option" data-correct="false">Buy the dip ‚Äî it's oversold</div>
                <div class="quiz-option" data-correct="true">Exit longs and consider shorts ‚Äî bearish confluence is a strong warning</div>
                <div class="quiz-option" data-correct="false">Ignore both signals and wait</div>
                <div class="quiz-option" data-correct="false">Buy calls because institutions are always wrong</div><div class="quiz-feedback"></div></div>
            <div class="quiz-question" id="q5"><h4>Q5: Why is dark pool data most reliable for mega-cap stocks?</h4>
                <div class="quiz-option" data-correct="false">Mega-caps have lower volume</div>
                <div class="quiz-option" data-correct="true">Mega-caps have enough dark pool volume for statistically meaningful analysis</div>
                <div class="quiz-option" data-correct="false">Small-caps have more dark pool activity</div>
                <div class="quiz-option" data-correct="false">Dark pools only trade mega-cap stocks</div><div class="quiz-feedback"></div></div>
            <div class="quiz-score" id="quizScore" style="display:none; margin-top: 20px; padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; text-align: center;">
                <h3>Quiz Complete!</h3><p>You scored <span id="scoreValue" style="color: #f59e0b; font-weight: bold; font-size: 1.5rem;">0</span> / 5</p></div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
        function copyCode(button) { const codeBlock = button.parentElement.nextElementSibling.querySelector('code'); navigator.clipboard.writeText(codeBlock.textContent); button.textContent = 'Copied!'; setTimeout(() => button.textContent = 'Copy', 2000); }

        function detectConf() {
            const shares = parseFloat(document.getElementById('dpShares').value);
            const avgVol = parseFloat(document.getElementById('dpAvgVol').value);
            const vwap = document.getElementById('dpVwap').value;
            const callPrem = parseFloat(document.getElementById('confCallPrem').value);
            const putPrem = parseFloat(document.getElementById('confPutPrem').value);
            const sweeps = document.getElementById('confSweeps').value === 'yes';
            const daysApart = parseFloat(document.getElementById('confDays').value);

            const volRatio = shares / avgVol;
            let dpScore = Math.min(3, volRatio);
            if (vwap === 'above') dpScore += 2; else if (vwap === 'below') dpScore = -dpScore - 2; else dpScore *= 0.5;

            const netPrem = callPrem - putPrem;
            let optScore = 0;
            if (netPrem > 1000000) optScore = 3; else if (netPrem > 500000) optScore = 2; else if (netPrem > 0) optScore = 1;
            else if (netPrem < -1000000) optScore = -3; else if (netPrem < -500000) optScore = -2; else if (netPrem < 0) optScore = -1;
            if (sweeps) optScore += netPrem > 0 ? 2 : -2;

            const timingMult = daysApart === 0 ? 2.0 : daysApart <= 1 ? 1.75 : daysApart <= 3 ? 1.5 : 1.0;
            const sameDir = (dpScore > 0 && optScore > 0) || (dpScore < 0 && optScore < 0);
            let confScore = sameDir ? (Math.abs(dpScore) + Math.abs(optScore)) * timingMult * (dpScore < 0 ? -1 : 1) : 0;

            let signal, sigColor;
            if (confScore >= 12) { signal = 'STRONG BULLISH CONFLUENCE'; sigColor = '#10b981'; }
            else if (confScore >= 6) { signal = 'BULLISH CONFLUENCE'; sigColor = '#6ee7b7'; }
            else if (confScore <= -12) { signal = 'STRONG BEARISH CONFLUENCE'; sigColor = '#ef4444'; }
            else if (confScore <= -6) { signal = 'BEARISH CONFLUENCE'; sigColor = '#fca5a5'; }
            else { signal = 'NO CLEAR CONFLUENCE'; sigColor = '#94a3b8'; }

            document.getElementById('confResult').style.display = 'block';
            document.getElementById('confResult').innerHTML = `<h4 style="color: #f59e0b; margin-bottom: 10px;">Confluence Analysis</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; text-align: center;">
                    <div><strong style="color: #94a3b8;">Dark Pool</strong><br><span style="color: ${dpScore > 0 ? '#10b981' : dpScore < 0 ? '#ef4444' : '#94a3b8'}; font-size: 1.1rem;">${dpScore.toFixed(1)}</span></div>
                    <div><strong style="color: #94a3b8;">Options Flow</strong><br><span style="color: ${optScore > 0 ? '#10b981' : optScore < 0 ? '#ef4444' : '#94a3b8'}; font-size: 1.1rem;">${optScore.toFixed(1)}</span></div>
                    <div><strong style="color: #94a3b8;">Timing</strong><br><span style="color: #f59e0b; font-size: 1.1rem;">${timingMult}x</span></div>
                </div>
                <div style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: ${sigColor};">${confScore.toFixed(1)}</div>
                    <div style="color: ${sigColor}; font-weight: 600;">${signal}</div>
                </div>`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Confluence chart
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const dpBuying = [1.2, 0.8, 0.5, 0.3, 0.2, 0.1, 0.2, 0.3, 0.1, 0.2];
            const callFlow = [2.0, 1.5, 0.5, 0.3, 0.2, 0.1, 0.1, 0.2, 0.1, 0.1];
            const nvdaPrice = [450, 452, 454, 458, 462, 468, 472, 476, 478, 480];

            new Chart(document.getElementById('confluenceChart'), {
                type: 'bar',
                data: { labels: days, datasets: [
                    { label: 'DP Net Buying ($M shares)', data: dpBuying, backgroundColor: 'rgba(99, 102, 241, 0.7)', yAxisID: 'y' },
                    { label: 'Call Premium ($M)', data: callFlow, backgroundColor: 'rgba(16, 185, 129, 0.7)', yAxisID: 'y' },
                    { label: 'NVDA Price', data: nvdaPrice, type: 'line', borderColor: '#f59e0b', borderWidth: 2, yAxisID: 'y1', fill: false, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#f59e0b' }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } }, title: { display: true, text: 'NVDA: Dark Pool + Options Confluence ‚Üí Price Rally', color: '#f1f5f9' } },
                    scales: { y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' }, title: { display: true, text: 'Volume ($M)', color: '#94a3b8' } }, y1: { position: 'right', ticks: { color: '#f59e0b' }, grid: { display: false }, title: { display: true, text: 'Price ($)', color: '#f59e0b' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } } } }
            });

            // Win rate chart
            new Chart(document.getElementById('winRateChart'), {
                type: 'bar',
                data: { labels: ['Dark Pool Only', 'Options Only', 'DP + Options\n(Confluence)', 'DP + Options\n+ Same Day'], datasets: [{
                    label: 'Historical Win Rate (%)', data: [55, 58, 72, 78],
                    backgroundColor: ['rgba(99, 102, 241, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(245, 158, 11, 0.7)', 'rgba(245, 158, 11, 0.9)'],
                    borderColor: ['#6366f1', '#10b981', '#f59e0b', '#f59e0b'], borderWidth: 2
                }]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Win Rate by Signal Type ‚Äî Confluence Dramatically Improves Accuracy', color: '#f1f5f9' } },
                    scales: { y: { min: 40, max: 85, ticks: { color: '#94a3b8', callback: v => v + '%' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } } } }
            });

            // Timeline chart
            const timeline = Array.from({length: 15}, (_, i) => `Day ${i+1}`);
            const dpData = [0, 0, 2, 3, 1, 0, 0, -1, -2, 0, 1, 3, 2, 0, 0];
            const optData = [0, 1, 3, 2, 0, 0, 0, 0, -3, -1, 0, 2, 3, 1, 0];
            const confData = dpData.map((d, i) => { const o = optData[i]; return (d > 0 && o > 0) ? d + o : (d < 0 && o < 0) ? d + o : 0; });

            new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: { labels: timeline, datasets: [
                    { label: 'Dark Pool Signal', data: dpData, borderColor: '#6366f1', borderWidth: 2, fill: false, tension: 0.3 },
                    { label: 'Options Signal', data: optData, borderColor: '#10b981', borderWidth: 2, fill: false, tension: 0.3 },
                    { label: 'Confluence', data: confData, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.2)', borderWidth: 3, fill: true, tension: 0.3 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } }, title: { display: true, text: 'Signal Timeline ‚Äî Confluence Appears When Both Signals Align', color: '#f1f5f9' } },
                    scales: { y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }, x: { ticks: { color: '#94a3b8', maxTicksLimit: 10 }, grid: { color: 'rgba(148, 163, 184, 0.1)' } } } }
            });
        });

        document.querySelectorAll('.quiz-option').forEach(option => { option.addEventListener('click', function() { const question = this.closest('.quiz-question'); const options = question.querySelectorAll('.quiz-option'); const feedback = question.querySelector('.quiz-feedback'); if (question.classList.contains('answered')) return; question.classList.add('answered'); options.forEach(opt => opt.style.pointerEvents = 'none'); const isCorrect = this.dataset.correct === 'true'; this.classList.add(isCorrect ? 'correct' : 'incorrect'); if (!isCorrect) { options.forEach(opt => { if (opt.dataset.correct === 'true') opt.classList.add('correct'); }); } feedback.textContent = isCorrect ? 'Correct!' : 'Incorrect. See the correct answer above.'; feedback.style.color = isCorrect ? '#10b981' : '#ef4444'; feedback.style.display = 'block'; checkQuizComplete(); }); });
        function checkQuizComplete() { const q = document.querySelectorAll('.quiz-question'); const a = document.querySelectorAll('.quiz-question.answered'); if (q.length === a.length) { document.getElementById('scoreValue').textContent = document.querySelectorAll('.quiz-option.correct:not(.incorrect)').length; document.getElementById('quizScore').style.display = 'block'; } }
        const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); }); }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
        document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));
    </script>
</body>
</html>